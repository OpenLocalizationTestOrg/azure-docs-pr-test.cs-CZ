---
title: "Azure Disk Encryption řešení potíží s | Microsoft Docs"
description: "Tento článek obsahuje tipy k řešení potíží pro Microsoft Azure Disk Encryption pro systém Windows a virtuálních počítačů IaaS Linux."
services: security
documentationcenter: na
author: deventiwari
manager: avibm
editor: yuridio
ms.assetid: ce0e23bd-07eb-43af-a56c-aa1a73bdb747
ms.service: security
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 07/27/2017
ms.author: devtiw
ms.openlocfilehash: 5f482a92b8fcd71a1b767fcc5741bc57605997ea
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 08/29/2017
---
# <a name="azure-disk-encryption-troubleshooting-guide"></a><span data-ttu-id="3b753-103">Průvodce odstraňováním potíží Azure Disk Encryption</span><span class="sxs-lookup"><span data-stu-id="3b753-103">Azure Disk Encryption Troubleshooting Guide</span></span>

<span data-ttu-id="3b753-104">Tato příručka je (IT) profesionálům, informace analytikům zabezpečení a problémy související s můžou správci cloudové jejichž organizace používají šifrování disku Azure a potřebovat pokyny k řešení potíží s šifrování disku.</span><span class="sxs-lookup"><span data-stu-id="3b753-104">This guide is for information technology (IT) professionals, information security analysts, and cloud administrators whose organizations are using Azure disk encryption and need guidance to troubleshoot disk-encryption related issues.</span></span>

## <a name="troubleshooting-linux-os-disk-encryption"></a><span data-ttu-id="3b753-105">Řešení potíží s šifrování disku operačního systému Linux</span><span class="sxs-lookup"><span data-stu-id="3b753-105">Troubleshooting Linux OS disk encryption</span></span>

<span data-ttu-id="3b753-106">Šifrování disku operačního systému Linux musí odpojit disk operačního systému před spuštěním procesu šifrování celého disku.</span><span class="sxs-lookup"><span data-stu-id="3b753-106">Linux OS disk encryption must unmount the OS drive prior to running it through the full disk encryption process.</span></span>   <span data-ttu-id="3b753-107">Pokud ne, chybová zpráva z "se nepodařilo odpojit po..."</span><span class="sxs-lookup"><span data-stu-id="3b753-107">If it cannot, an error message of "failed to unmount after…"</span></span> <span data-ttu-id="3b753-108">chybová zpráva se může vyskytnout.</span><span class="sxs-lookup"><span data-stu-id="3b753-108">error message is likely to occur.</span></span>

<span data-ttu-id="3b753-109">Toto je nejpravděpodobnější, při pokusu o šifrování disku operačního systému na cílové prostředí virtuálního počítače, který byl změněn nebo se změnila z jeho podporovaných uložených Galerie image.</span><span class="sxs-lookup"><span data-stu-id="3b753-109">This is most likely when OS disk encryption is attempted on a target VM environment that has been modified or changed from its supported stock gallery image.</span></span>  <span data-ttu-id="3b753-110">Příklady odchylky od podporované bitovou kopii, kterou může narušovat rozšíření možnost Odpojit disk operačního systému:</span><span class="sxs-lookup"><span data-stu-id="3b753-110">Examples of deviations from the supported image, which can interfere with the extension’s ability to unmount the OS drive include:</span></span>
- <span data-ttu-id="3b753-111">Přizpůsobené bitové kopie, které už odpovídají v podporovaném systému souborů nebo schéma rozdělení oddílů.</span><span class="sxs-lookup"><span data-stu-id="3b753-111">Customized images that no longer match a supported file system and/or partitioning scheme.</span></span>
- <span data-ttu-id="3b753-112">Přizpůsobené bitové kopie s aplikací, jako jsou antivirové Docker, SAP, MongoDB nebo Cassandra Apache spuštěn v operačním systému před šifrování.</span><span class="sxs-lookup"><span data-stu-id="3b753-112">Customized images with applications such as antivirus, Docker, SAP, MongoDB, or Apache Cassandra running in the OS prior to encryption.</span></span>  <span data-ttu-id="3b753-113">Tyto aplikace obtížně se ukončí a při současném zachování otevřených popisovačů souborů na jednotce operačního systému, jednotka nemůže nepřipojené způsobující selhání.</span><span class="sxs-lookup"><span data-stu-id="3b753-113">These applications are difficult to terminate, and when they retain open file handles to the OS drive, the drive cannot be unmounted, causing failure.</span></span>
- <span data-ttu-id="3b753-114">Vlastní skripty, které běží v zavřete čas blízkosti krok šifrování můžete konfliktu a způsobit, že tuto chybu.</span><span class="sxs-lookup"><span data-stu-id="3b753-114">Custom scripts that run in close time proximity to the encryption step can interfere and cause this failure.</span></span> <span data-ttu-id="3b753-115">Tomu může dojít, když šablonu Resource Manager definuje několik rozšíření provést současně, nebo když rozšíření vlastních skriptů nebo jiným běží současně pro šifrování disku.</span><span class="sxs-lookup"><span data-stu-id="3b753-115">This can happen when a Resource Manager template defines multiple extensions to execute simultaneously, or when a custom script extension or other action is run simultaneously to disk encryption.</span></span>   <span data-ttu-id="3b753-116">Tento problém může vyřešit serializaci a izolace tyto kroky.</span><span class="sxs-lookup"><span data-stu-id="3b753-116">Serializing and isolating such steps may resolve the issue.</span></span>
- <span data-ttu-id="3b753-117">Při SELinux nebylo zrušeno před povolením šifrování, selže, krok odpojení.</span><span class="sxs-lookup"><span data-stu-id="3b753-117">When SELinux has not been disabled prior to enabling encryption, the unmount step fails.</span></span>  <span data-ttu-id="3b753-118">Po dokončení šifrování, může být SELinux znovu zapnout.</span><span class="sxs-lookup"><span data-stu-id="3b753-118">SELinux can be re-enabled after encryption has completed.</span></span>
- <span data-ttu-id="3b753-119">Pokud je disk operačního systému pomocí příslušné schéma LVM (i když je k dispozici omezená podpora disku data LVM, disk operačního systému LVM není)</span><span class="sxs-lookup"><span data-stu-id="3b753-119">When the OS disk is using an LVM scheme (although limited LVM data disk support is available, LVM OS disk is not)</span></span>
- <span data-ttu-id="3b753-120">Pokud nejsou splněné požadavky na minimální množství paměti (7 GB je navržený pro šifrování disku operačního systému)</span><span class="sxs-lookup"><span data-stu-id="3b753-120">When minimum memory requirements are not met (7GB is suggested for OS disk encryption)</span></span>
- <span data-ttu-id="3b753-121">Když datové jednotky byly rekurzivně připojeny v adresáři /mnt/ nebo navzájem (například /mnt/data1 /mnt/data2, /data3 + /data3/data4, atd.)</span><span class="sxs-lookup"><span data-stu-id="3b753-121">When data drives have been recursively mounted under /mnt/ directory, or each other (for example, /mnt/data1, /mnt/data2, /data3 + /data3/data4, etc.)</span></span>
- <span data-ttu-id="3b753-122">Při další Azure Disk Encryption [požadavky](https://docs.microsoft.com/en-us/azure/security/azure-security-disk-encryption) nejsou splněny pro Linux</span><span class="sxs-lookup"><span data-stu-id="3b753-122">When other Azure Disk Encryption [prerequisites](https://docs.microsoft.com/en-us/azure/security/azure-security-disk-encryption) for Linux are not met</span></span>

## <a name="unable-to-encrypt"></a><span data-ttu-id="3b753-123">Nelze zašifrovat</span><span class="sxs-lookup"><span data-stu-id="3b753-123">Unable to encrypt</span></span>

<span data-ttu-id="3b753-124">V některých případech je zakázána Linux šifrování disku se zdá být zablokované ve "Spuštění šifrování disku operačního systému" a SSH.</span><span class="sxs-lookup"><span data-stu-id="3b753-124">In some cases, the Linux disk encryption appears to be stuck at "OS disk encryption started" and SSH is disabled.</span></span> <span data-ttu-id="3b753-125">Tento proces může trvat mezi 3-16 hodin, na bitovou kopii uložených galerie.</span><span class="sxs-lookup"><span data-stu-id="3b753-125">This process can take between 3-16 hours to complete on a stock gallery image.</span></span>  <span data-ttu-id="3b753-126">Pokud přidáte více TB velikost datových disků, může trvat dnů.</span><span class="sxs-lookup"><span data-stu-id="3b753-126">If multi-TB size data disks are added, the process may take days.</span></span> <span data-ttu-id="3b753-127">Pořadí šifrování disku operačního systému Linux dočasně ji operačního systému, odpojíte a provádí blok po bloku šifrování celého disku operačního systému před jeho opakovanému připojení v jeho šifrovaného stavu.</span><span class="sxs-lookup"><span data-stu-id="3b753-127">The Linux OS disk encryption sequence unmounts the OS drive temporarily, and performs block by block encryption of the entire OS disk, before remounting it in its encrypted state.</span></span>   <span data-ttu-id="3b753-128">Na rozdíl od Azure Disk Encryption v systému Windows Linux šifrování disku neumožňuje souběžné používání virtuálního počítače, když probíhá šifrování.</span><span class="sxs-lookup"><span data-stu-id="3b753-128">Unlike Azure Disk Encryption on Windows, Linux Disk Encryption does not allow concurrent use of the VM while the encryption is in progress.</span></span>  <span data-ttu-id="3b753-129">Výkonové charakteristiky virtuálního počítače, včetně velikosti disku a zda je zálohovaný účet úložiště standard nebo premium (SSD) úložiště může výrazně ovlivnit čas potřebný k dokončení šifrování.</span><span class="sxs-lookup"><span data-stu-id="3b753-129">The performance characteristics of the VM, including the size of the disk and whether the storage account is backed by standard or premium (SSD) storage, can greatly influence the time required to complete encryption.</span></span>

<span data-ttu-id="3b753-130">Pokud chcete zkontrolovat stav, pole ProgressMessage vrácená z [Get-AzureRmVmDiskEncryptionStatus](https://docs.microsoft.com/powershell/module/azurerm.compute/get-azurermvmdiskencryptionstatus) testují příkaz.</span><span class="sxs-lookup"><span data-stu-id="3b753-130">To check status, the ProgressMessage field returned from the [Get-AzureRmVmDiskEncryptionStatus](https://docs.microsoft.com/powershell/module/azurerm.compute/get-azurermvmdiskencryptionstatus) command can be polled.</span></span>   <span data-ttu-id="3b753-131">Během šifrované jednotky operačního systému, virtuální počítač dostane do stavu údržby a SSH se vypne taky aby se zabránilo přerušení na probíhající proces.</span><span class="sxs-lookup"><span data-stu-id="3b753-131">While the OS drive is being encrypted, the VM enters a servicing state, and SSH is also disabled to prevent any disruption to the ongoing process.</span></span>  <span data-ttu-id="3b753-132">EncryptionInProgress se ohlásí pro většinu času při šifrování probíhá, a potom několik hodin později s VMRestartPending zprávy, výzvy k restartování virtuálního počítače.</span><span class="sxs-lookup"><span data-stu-id="3b753-132">EncryptionInProgress will be reported for the majority of the time while encryption is in progress, followed several hours later with a VMRestartPending message prompting to restart the VM.</span></span>  <span data-ttu-id="3b753-133">Například:</span><span class="sxs-lookup"><span data-stu-id="3b753-133">For example:</span></span>


```
PS > Get-AzureRmVMDiskEncryptionStatus -ResourceGroupName $resourceGroupName -VMName $vmName
OsVolumeEncrypted          : EncryptionInProgress
DataVolumesEncrypted       : EncryptionInProgress
OsVolumeEncryptionSettings : Microsoft.Azure.Management.Compute.Models.DiskEncryptionSettings
ProgressMessage            : OS disk encryption started

PS > Get-AzureRmVMDiskEncryptionStatus -ResourceGroupName $resourceGroupName -VMName $vmName
OsVolumeEncrypted          : VMRestartPending
DataVolumesEncrypted       : Encrypted
OsVolumeEncryptionSettings : Microsoft.Azure.Management.Compute.Models.DiskEncryptionSettings
ProgressMessage            : OS disk successfully encrypted, please reboot the VM
```

<span data-ttu-id="3b753-134">Po zobrazení výzvy k restartování virtuálního počítače a po restartování virtuálního počítače a poskytnutí 2 – 3 minuty, pro restartování a poslední postup provést v cílovém, označí stavovou zprávu, že šifrování nakonec byla dokončena.</span><span class="sxs-lookup"><span data-stu-id="3b753-134">Once prompted to reboot the VM, and after restarting the VM, and giving 2-3 minutes for the reboot and for final steps to be performed on the target, the status message will indicate that encryption has finally completed.</span></span>   <span data-ttu-id="3b753-135">Jakmile se tato zpráva je k dispozici, na šifrované jednotce operačního systému musí být připravené pro použití a pro virtuální počítač. Chcete-li být znovu použitelné.</span><span class="sxs-lookup"><span data-stu-id="3b753-135">Once this message is available, the encrypted OS drive is expected to be ready for use and for the VM to be usable again.</span></span>

<span data-ttu-id="3b753-136">V případech, kdy toto pořadí nebyla zobrazena nebo pokud informace o spuštění, zprávu o průběhu nebo další indikátory, chyba ohlásit že OS šifrování se nezdařila uprostřed tento proces (například pokud se zobrazuje chyba "se nepodařilo odpojit" popsané v tomto průvodci), je Doporučujeme obnovit virtuální počítač zpět do snímku nebo zálohy bezprostředně před šifrování.</span><span class="sxs-lookup"><span data-stu-id="3b753-136">In cases where this sequence was not seen, or if boot information, progress message, or other error indicators report that OS encryption has failed in the middle of this process (for example if you are seeing the "failed to unmount" error described in this guide), it is recommended to restore the VM back to the snapshot or backup taken immediately prior to encryption.</span></span>  <span data-ttu-id="3b753-137">Před dalším pokusu o je doporučeno vytvořit znovu vyhodnotit vlastnosti virtuálního počítače a ujistěte se, že jsou splněny všechny požadavky.</span><span class="sxs-lookup"><span data-stu-id="3b753-137">Prior to the next attempt, it is suggested to re-evaluate the characteristics of the VM and ensure that all prerequisites are satisfied.</span></span>

## <a name="troubleshooting-azure-disk-encryption-behind-a-firewall"></a><span data-ttu-id="3b753-138">Řešení potíží s Azure Disk Encryption za bránou Firewall</span><span class="sxs-lookup"><span data-stu-id="3b753-138">Troubleshooting Azure Disk Encryption behind a Firewall</span></span>
<span data-ttu-id="3b753-139">Při připojení je omezené na základě brána firewall, proxy požadavek nebo nastavení zabezpečení skupiny (NSG) sítě, může být přerušeny možnost rozšíření potřebné úkoly.</span><span class="sxs-lookup"><span data-stu-id="3b753-139">When connectivity is restricted by a firewall, proxy requirement, or network security group (NSG) settings, the ability of the extension to perform needed tasks can be disrupted.</span></span>   <span data-ttu-id="3b753-140">To může mít za následek stavové zprávy, jako je například "Stav rozšíření ve virtuálním počítači není k dispozici" a v očekávané scénáře nedaří dokončit.</span><span class="sxs-lookup"><span data-stu-id="3b753-140">This can result in status messages such as "Extension status not available on the VM" and in expected scenarios failing to finish.</span></span>  <span data-ttu-id="3b753-141">V následujících má některé běžné problémy brány firewall, které může prozkoumat.</span><span class="sxs-lookup"><span data-stu-id="3b753-141">The sections that follow has some common firewall issues that you may investigate.</span></span>

### <a name="network-security-groups"></a><span data-ttu-id="3b753-142">Skupiny zabezpečení sítě</span><span class="sxs-lookup"><span data-stu-id="3b753-142">Network security groups</span></span>
<span data-ttu-id="3b753-143">Nastavení skupiny zabezpečení sítě aplikovaná musí umožňovat stále koncový bod podle zdokumentovaných síťovou konfiguraci [požadavky](https://docs.microsoft.com/azure/security/azure-security-disk-encryption#prerequisites) šifrování disku.</span><span class="sxs-lookup"><span data-stu-id="3b753-143">Any network security group settings applied must still allow the endpoint to meet the documented network configuration [prerequisites](https://docs.microsoft.com/azure/security/azure-security-disk-encryption#prerequisites) for disk encryption.</span></span>

### <a name="azure-keyvault-behind-firewall"></a><span data-ttu-id="3b753-144">Azure Keyvault za bránou firewall</span><span class="sxs-lookup"><span data-stu-id="3b753-144">Azure Keyvault behind firewall</span></span>
<span data-ttu-id="3b753-145">Virtuální počítač musí být schopen získat přístup k trezoru klíčů.</span><span class="sxs-lookup"><span data-stu-id="3b753-145">The VM must be able to access key vault.</span></span> <span data-ttu-id="3b753-146">Najdete pokyny k přístupu do klíče selhání za bránou firewall, který je spravován [Key Vault](https://docs.microsoft.com/azure/key-vault/key-vault-access-behind-firewall) týmu.</span><span class="sxs-lookup"><span data-stu-id="3b753-146">Refer to guidance on access to key fault from behind a firewall that is maintained by the [Key Vault](https://docs.microsoft.com/azure/key-vault/key-vault-access-behind-firewall) team.</span></span>

### <a name="linux-package-management-behind-firewall"></a><span data-ttu-id="3b753-147">Linux správy balíčků za bránou firewall</span><span class="sxs-lookup"><span data-stu-id="3b753-147">Linux package management behind firewall</span></span>
<span data-ttu-id="3b753-148">V době běhu Azure Disk Encryption pro Linux spoléhá na systém správy cílového distribučního balíčku pro instalaci potřebné součásti, které před povolením šifrování.</span><span class="sxs-lookup"><span data-stu-id="3b753-148">At run time, Azure Disk Encryption for Linux relies on the target distribution’s package management system to install needed prerequisite components prior to enabling encryption.</span></span>  <span data-ttu-id="3b753-149">Pokud nastavení brány firewall zabránit virtuální počítač mohli ke stažení a instalaci těchto součástí, se očekává následné selhání.</span><span class="sxs-lookup"><span data-stu-id="3b753-149">If firewall settings prevent the VM from being able to download and install these components, then subsequent failures are expected.</span></span>    <span data-ttu-id="3b753-150">Postup konfigurace to se může lišit distribucí.</span><span class="sxs-lookup"><span data-stu-id="3b753-150">The steps to configure this may vary by distribution.</span></span>  <span data-ttu-id="3b753-151">Na Red Hat zajistíte, že odběr manager a yum jsou správně nastavena je pokud proxy server je nutné, důležité.</span><span class="sxs-lookup"><span data-stu-id="3b753-151">On Red Hat, when a proxy is required, ensuring that subscription-manager and yum are set up properly is vital.</span></span>  <span data-ttu-id="3b753-152">V tématu [to](https://access.redhat.com/solutions/189533) článek podpory Red Hat v tomto tématu.</span><span class="sxs-lookup"><span data-stu-id="3b753-152">See [this](https://access.redhat.com/solutions/189533) Red Hat support article on this topic.</span></span>  

## <a name="troubleshooting-windows-server-2016-server-core"></a><span data-ttu-id="3b753-153">Řešení potíží s jádra serveru systému Windows Server 2016</span><span class="sxs-lookup"><span data-stu-id="3b753-153">Troubleshooting Windows Server 2016 Server Core</span></span>

<span data-ttu-id="3b753-154">Součást bdehdcfg není k dispozici ve výchozím nastavení, na jádru serveru Windows Server 2016.</span><span class="sxs-lookup"><span data-stu-id="3b753-154">On Windows Server 2016 Server Core, the bdehdcfg component is not available by default.</span></span> <span data-ttu-id="3b753-155">Tato součást vyžaduje Azure Disk Encryption.</span><span class="sxs-lookup"><span data-stu-id="3b753-155">This component is required by Azure Disk Encryption.</span></span>

<span data-ttu-id="3b753-156">Chcete-li vyřešit tento problém, kopírovat 4 následující soubory z virtuálního počítače Windows serveru 2016 Data Center do složky c:\windows\system32 bitovou kopii jádra serveru:</span><span class="sxs-lookup"><span data-stu-id="3b753-156">To workaround this issue, copy the following 4 files from a Windows Server 2016 Data Center VM to the c:\windows\system32 folder of the Server Core image:</span></span>

```
bdehdcfg.exe
bdehdcfglib.dll
bdehdcfglib.dll.mui
bdehdcfg.exe.mui
```

<span data-ttu-id="3b753-157">Pak spusťte následující příkaz:</span><span class="sxs-lookup"><span data-stu-id="3b753-157">Then, run the following command:</span></span>

```
bdehdcfg.exe -target default
```

<span data-ttu-id="3b753-158">Tím se vytvoří systémový oddíl 550MB a po restartování systému, můžete pak pomocí nástroje Diskpart, zkontrolujte příslušné svazky a pokračovat.</span><span class="sxs-lookup"><span data-stu-id="3b753-158">This will create a 550MB system partition and then after a reboot, you can use Diskpart to check the volumes, and proceed.</span></span>  

<span data-ttu-id="3b753-159">Například:</span><span class="sxs-lookup"><span data-stu-id="3b753-159">For example:</span></span>

```
DISKPART> list vol

  Volume ###  Ltr  Label        Fs     Type        Size     Status     Info
  ----------  ---  -----------  -----  ----------  -------  ---------  --------
  Volume 0     C                NTFS   Partition    126 GB  Healthy    Boot
  Volume 1                      NTFS   Partition    550 MB  Healthy    System
  Volume 2     D   Temporary S  NTFS   Partition     13 GB  Healthy    Pagefile
```
## <a name="see-also"></a><span data-ttu-id="3b753-160">Viz také</span><span class="sxs-lookup"><span data-stu-id="3b753-160">See also</span></span>
<span data-ttu-id="3b753-161">V tomto dokumentu jste zjistili, informace o některé běžné problémy při šifrování disku Azure a jejich řešení.</span><span class="sxs-lookup"><span data-stu-id="3b753-161">In this document, you learned more about some common issues in Azure disk encryption, and how to troubleshoot.</span></span> <span data-ttu-id="3b753-162">Další informace o této služby a jeho schopnosti najdete v tématu:</span><span class="sxs-lookup"><span data-stu-id="3b753-162">For more information about this service and its capability read:</span></span>

- [<span data-ttu-id="3b753-163">Použít šifrování disku v Azure Security Center</span><span class="sxs-lookup"><span data-stu-id="3b753-163">Apply disk encryption in Azure Security Center</span></span>](https://docs.microsoft.com/azure/security-center/security-center-apply-disk-encryption)
- [<span data-ttu-id="3b753-164">Šifrování virtuálního počítače Azure</span><span class="sxs-lookup"><span data-stu-id="3b753-164">Encrypt an Azure Virtual Machine</span></span>](https://docs.microsoft.com/azure/security-center/security-center-disk-encryption)
- [<span data-ttu-id="3b753-165">Šifrování na Rest Azure dat</span><span class="sxs-lookup"><span data-stu-id="3b753-165">Azure Data Encryption-at-Rest</span></span>](https://docs.microsoft.com/azure/security/azure-security-encryption-atrest)
