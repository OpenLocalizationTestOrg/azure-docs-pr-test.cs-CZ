---
title: "Spouštění analytických dotazů ad hoc pro více databází SQL Azure | Dokumentace Microsoftu"
description: "Spuštění analytics dotazů ad-hoc napříč více databází SQL v víceklientské aplikace Wingtip SaaS."
keywords: kurz k sql database
services: sql-database
documentationcenter: 
author: stevestein
manager: jhubbard
editor: 
ms.assetid: 
ms.service: sql-database
ms.custom: scale out apps
ms.workload: data-management
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 06/23/2017
ms.author: billgib; sstein
ms.openlocfilehash: c287fe5d6b333c749b0580b5253e7e46ac27232b
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 07/11/2017
---
# <a name="run-ad-hoc-analytics-queries-across-all-wingtip-saas-tenants"></a><span data-ttu-id="1b61e-104">Spuštění analytics dotazů ad-hoc napříč všichni klienti Wingtip SaaS</span><span class="sxs-lookup"><span data-stu-id="1b61e-104">Run ad-hoc analytics queries across all Wingtip SaaS tenants</span></span>

<span data-ttu-id="1b61e-105">V tomto kurzu spustíte distribuované dotazy napříč celou sadu klienta databáze, aby ad-hoc analytics.</span><span class="sxs-lookup"><span data-stu-id="1b61e-105">In this tutorial, you run distributed queries across the entire set of tenant databases to enable ad-hoc analytics.</span></span> <span data-ttu-id="1b61e-106">Elastické dotazu slouží k povolení distribuované dotazy, které vyžaduje, že že další analýze databáze nasazení (do katalogu serveru).</span><span class="sxs-lookup"><span data-stu-id="1b61e-106">Elastic Query is used to enable distributed queries, which requires an additional analytics database is deployed (to the catalog server).</span></span> <span data-ttu-id="1b61e-107">Tyto dotazy můžete extrahovat Statistika schovaný v každodenní provozních dat Wingtip SaaS aplikace.</span><span class="sxs-lookup"><span data-stu-id="1b61e-107">These queries can extract insights buried in the day-to-day operational data of the Wingtip SaaS app.</span></span>


<span data-ttu-id="1b61e-108">V tomto kurzu se dozvíte:</span><span class="sxs-lookup"><span data-stu-id="1b61e-108">In this tutorial you learn:</span></span>

> [!div class="checklist"]

> * <span data-ttu-id="1b61e-109">O globální zobrazení každou databázi, které umožňují efektivní dotazování mezi klienty</span><span class="sxs-lookup"><span data-stu-id="1b61e-109">About the global views in each database, that enable efficient querying across tenants</span></span>
> * <span data-ttu-id="1b61e-110">Postup nasazení databázi analýzy ad-hoc</span><span class="sxs-lookup"><span data-stu-id="1b61e-110">How to deploy an ad-hoc analytics database</span></span>
> * <span data-ttu-id="1b61e-111">Postup spuštění distribuovaných dotazů mezi všechny databáze klienta</span><span class="sxs-lookup"><span data-stu-id="1b61e-111">How to run distributed queries across all tenant databases</span></span>



<span data-ttu-id="1b61e-112">Předpokladem dokončení tohoto kurzu je splnění následujících požadavků:</span><span class="sxs-lookup"><span data-stu-id="1b61e-112">To complete this tutorial, make sure the following prerequisites are completed:</span></span>

* <span data-ttu-id="1b61e-113">Adresář Wingtip SaaS aplikace je nasazená.</span><span class="sxs-lookup"><span data-stu-id="1b61e-113">The Wingtip SaaS app is deployed.</span></span> <span data-ttu-id="1b61e-114">Nasazení za méně než pět minut najdete v tématu [nasazení a seznamte se s Wingtip SaaS aplikace](sql-database-saas-tutorial.md)</span><span class="sxs-lookup"><span data-stu-id="1b61e-114">To deploy in less than five minutes, see [Deploy and explore the Wingtip SaaS application](sql-database-saas-tutorial.md)</span></span>
* <span data-ttu-id="1b61e-115">Je nainstalované prostředí Azure PowerShell.</span><span class="sxs-lookup"><span data-stu-id="1b61e-115">Azure PowerShell is installed.</span></span> <span data-ttu-id="1b61e-116">Podrobnosti najdete v článku [Začínáme s prostředím Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps).</span><span class="sxs-lookup"><span data-stu-id="1b61e-116">For details, see [Getting started with Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps)</span></span>
* <span data-ttu-id="1b61e-117">SQL Server Management Studio (SSMS) je nainstalována.</span><span class="sxs-lookup"><span data-stu-id="1b61e-117">SQL Server Management Studio (SSMS) is installed.</span></span> <span data-ttu-id="1b61e-118">Chcete-li stáhnout a nainstalovat aplikace SSMS, přečtěte si téma [stáhnout SQL Server Management Studio (SSMS)](https://docs.microsoft.com/sql/ssms/download-sql-server-management-studio-ssms).</span><span class="sxs-lookup"><span data-stu-id="1b61e-118">To download and install SSMS, see [Download SQL Server Management Studio (SSMS)](https://docs.microsoft.com/sql/ssms/download-sql-server-management-studio-ssms).</span></span>


## <a name="ad-hoc-analytics-pattern"></a><span data-ttu-id="1b61e-119">Vzor analytics ad-hoc</span><span class="sxs-lookup"><span data-stu-id="1b61e-119">Ad-hoc analytics pattern</span></span>

<span data-ttu-id="1b61e-120">Jeden z velké příležitosti s aplikacemi SaaS, je použití velká množství dat klienta centrálně uložených v cloudu.</span><span class="sxs-lookup"><span data-stu-id="1b61e-120">One of the great opportunities with SaaS applications is to use the vast amount of tenant data stored centrally in the cloud.</span></span> <span data-ttu-id="1b61e-121">Tato data použijte a získáte přehled o operaci a využití vaší aplikace vašich klientů, jejich, předvolby, chování, uživatelů atd. Funkce vývoj, vylepšení použitelnost a další investice do vaší aplikace a služby, můžete tyto přehledy průvodce.</span><span class="sxs-lookup"><span data-stu-id="1b61e-121">Use this data to gain insights into the operation and usage of your application, your tenants, their users, preferences, behaviors, etc. These insights can guide feature development, usability improvements, and other investments in your apps and services.</span></span>

<span data-ttu-id="1b61e-122">V jedné databázi s více tenanty je přístup k těmto datům jednoduchý, ale třeba v případě distribuce mezi tisícovky databází se situace komplikuje.</span><span class="sxs-lookup"><span data-stu-id="1b61e-122">Accessing this data in a single multi-tenant database is easy, but not so easy when distributed at scale across potentially thousands of databases.</span></span> <span data-ttu-id="1b61e-123">Jeden z přístupů je použít [elastické dotazu](sql-database-elastic-query-overview.md), což umožňuje dotazování na distribuovanou sadu databází s společné schéma.</span><span class="sxs-lookup"><span data-stu-id="1b61e-123">One approach is to use [Elastic Query](sql-database-elastic-query-overview.md), which enables querying across a distributed set of databases with common schema.</span></span> <span data-ttu-id="1b61e-124">Elastické dotaz používá jeden *head* databáze, ve kterém jsou definovány externí tabulky, zrcadlení tabulky a zobrazení v databázích distribuované (klientů).</span><span class="sxs-lookup"><span data-stu-id="1b61e-124">Elastic Query uses a single *head* database in which external tables are defined that mirror tables or views in the distributed (tenant) databases.</span></span> <span data-ttu-id="1b61e-125">Dotazy odeslané do této hlavní databáze se kompilují a vzniká plán distribuovaného dotazu, který zajistí předávání částí dotazu potřebným tenantským databázím.</span><span class="sxs-lookup"><span data-stu-id="1b61e-125">Queries submitted to this head database are compiled to produce a distributed query plan, with portions of the query pushed down to the tenant databases as needed.</span></span> <span data-ttu-id="1b61e-126">Nástroj Elastic Query na základě mapy horizontálních oddílů v databázi katalogu poskytuje umístění databází tenantů.</span><span class="sxs-lookup"><span data-stu-id="1b61e-126">Elastic Query uses the shard map in the catalog database to provide the location of the tenant databases.</span></span> <span data-ttu-id="1b61e-127">Instalační program a dotaz jsou jednoduché, pomocí standardní [Transact-SQL](https://docs.microsoft.com/sql/t-sql/language-reference)a podporují ad hoc dotazy z nástroje, například Power BI a Excel.</span><span class="sxs-lookup"><span data-stu-id="1b61e-127">Setup and query are straightforward using standard [Transact-SQL](https://docs.microsoft.com/sql/t-sql/language-reference), and support ad-hoc querying from tools like Power BI and Excel.</span></span>

<span data-ttu-id="1b61e-128">Elastické dotazu distribucí dotazy mezi databázemi klienta, poskytuje okamžitý přehled o provozu provozními daty.</span><span class="sxs-lookup"><span data-stu-id="1b61e-128">By distributing queries across the tenant databases, Elastic Query provides immediate insight into live production data.</span></span> <span data-ttu-id="1b61e-129">Však jako elastické dotaz získává data ze potenciálně velký počet databází, latence dotazu může někdy být vyšší než pro odeslání do jedné databáze víceklientské ekvivalentní dotazy.</span><span class="sxs-lookup"><span data-stu-id="1b61e-129">However, as Elastic Query pulls data from potentially many databases, query latency can sometimes be higher than for equivalent queries submitted to a single multi-tenant database.</span></span> <span data-ttu-id="1b61e-130">Potřeba dát pozor při navrhování dotazuje minimalizovat objem dat, která je vrácena.</span><span class="sxs-lookup"><span data-stu-id="1b61e-130">Care should be taken when designing queries to minimize the data that is returned.</span></span> <span data-ttu-id="1b61e-131">Elastické dotazu je často nejvhodnější pro dotazy malých objemů dat v reálném čase a sestavování často používané nebo komplexní analytické dotazy nebo sestavy.</span><span class="sxs-lookup"><span data-stu-id="1b61e-131">Elastic Query is often best suited for querying small amounts of real-time data, as opposed to building frequently used or complex analytics queries or reports.</span></span> <span data-ttu-id="1b61e-132">Pokud dotazy neprovádí dobře, podívejte se na [plán spuštění](https://docs.microsoft.com/sql/relational-databases/performance/display-an-actual-execution-plan) jaká část dotazu bylo posunuto do vzdálené databáze a kolik dat se vrací.</span><span class="sxs-lookup"><span data-stu-id="1b61e-132">If queries don't perform well, look at the [execution plan](https://docs.microsoft.com/sql/relational-databases/performance/display-an-actual-execution-plan) to see what part of the query has been pushed down to the remote database and how much data is being returned.</span></span> <span data-ttu-id="1b61e-133">Dotazy, které vyžadují komplexní analytického zpracování může být lepší obsluhuje v některých případech extrahování dat klienta do vyhrazené databáze nebo datového skladu optimalizované pro analytické dotazy.</span><span class="sxs-lookup"><span data-stu-id="1b61e-133">Queries that require complex analytical processing may be better served in some cases by extracting tenant data into a dedicated database or data warehouse optimized for analytics queries.</span></span> <span data-ttu-id="1b61e-134">Tento vzor je podrobně popsaný [kurzu analýza klienta](sql-database-saas-tutorial-tenant-analytics.md).</span><span class="sxs-lookup"><span data-stu-id="1b61e-134">This pattern is explained in the [tenant analytics tutorial](sql-database-saas-tutorial-tenant-analytics.md).</span></span> 

## <a name="get-the-wingtip-application-scripts"></a><span data-ttu-id="1b61e-135">Získání skriptů aplikace Wingtip</span><span class="sxs-lookup"><span data-stu-id="1b61e-135">Get the Wingtip application scripts</span></span>

<span data-ttu-id="1b61e-136">Adresář Wingtip SaaS skripty a zdrojový kód aplikace, které jsou k dispozici v [WingtipSaaS](https://github.com/Microsoft/WingtipSaaS) úložiště github.</span><span class="sxs-lookup"><span data-stu-id="1b61e-136">The Wingtip SaaS scripts and application source code are available in the [WingtipSaaS](https://github.com/Microsoft/WingtipSaaS) github repo.</span></span> <span data-ttu-id="1b61e-137">[Postup stažení skripty Wingtip SaaS](sql-database-wtp-overview.md#download-and-unblock-the-wingtip-saas-scripts).</span><span class="sxs-lookup"><span data-stu-id="1b61e-137">[Steps to download the Wingtip SaaS scripts](sql-database-wtp-overview.md#download-and-unblock-the-wingtip-saas-scripts).</span></span>

## <a name="create-ticket-sales-data"></a><span data-ttu-id="1b61e-138">Vytvořit data prodeje lístků</span><span class="sxs-lookup"><span data-stu-id="1b61e-138">Create ticket sales data</span></span>

<span data-ttu-id="1b61e-139">Ke spouštění dotazů na zajímavějšího datové sady, vytvořte spuštěním lístku generátor prodejní data lístku.</span><span class="sxs-lookup"><span data-stu-id="1b61e-139">To run queries against a more interesting data set, create ticket sales data by running the ticket-generator.</span></span>

1. <span data-ttu-id="1b61e-140">V *prostředí PowerShell ISE*, otevřete... \\Learning moduly\\provozní Analytics\\ad hoc Analytics\\*ukázku AdhocAnalytics.ps1* skript a nastavte následující hodnoty:</span><span class="sxs-lookup"><span data-stu-id="1b61e-140">In the *PowerShell ISE*, open the ...\\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalytics.ps1* script and set the following values:</span></span>
   * <span data-ttu-id="1b61e-141">**$DemoScenario** = 1, **zakoupit lístky pro události na všechna místa**.</span><span class="sxs-lookup"><span data-stu-id="1b61e-141">**$DemoScenario** = 1, **Purchase tickets for events at all venues**.</span></span>
2. <span data-ttu-id="1b61e-142">Stiskněte klávesu **F5** generovat prodeje lístků a spusťte skript.</span><span class="sxs-lookup"><span data-stu-id="1b61e-142">Press **F5** to run the script and generate ticket sales.</span></span> <span data-ttu-id="1b61e-143">Je spuštěn skript, pokračujte kroky v tomto kurzu.</span><span class="sxs-lookup"><span data-stu-id="1b61e-143">While the script is running, continue the steps in this tutorial.</span></span> <span data-ttu-id="1b61e-144">Data lístku je dotazován v *spouštění dotazů ad-hoc distribuované* část, proto počkejte generátor lístek k dokončení, pokud je stále spuštěn, když dojde k tohoto cvičení.</span><span class="sxs-lookup"><span data-stu-id="1b61e-144">The ticket data is queried in the *Run ad-hoc distributed queries* section, so wait for the ticket generator to complete if it's still running when you get to that exercise.</span></span>

## <a name="explore-the-global-views"></a><span data-ttu-id="1b61e-145">Prozkoumejte globální zobrazení</span><span class="sxs-lookup"><span data-stu-id="1b61e-145">Explore the global views</span></span>

<span data-ttu-id="1b61e-146">Aplikace Wingtip SaaS vytvořená s využitím modelu klienta pro databáze, tak z hlediska jednoho klienta je definované schéma databáze klienta.</span><span class="sxs-lookup"><span data-stu-id="1b61e-146">The Wingtip SaaS application is built using a tenant-per-database model, so the tenant database schema is defined from a single-tenant perspective.</span></span> <span data-ttu-id="1b61e-147">Informace specifické pro klienta existuje v jedné tabulce *místo*, vždy má jeden řádek a je implementovaný jako haldy, bez primárního klíče.</span><span class="sxs-lookup"><span data-stu-id="1b61e-147">Tenant-specific information exists in one table, *Venue*, which always has a single row, and is implemented as a heap, without a primary key.</span></span> <span data-ttu-id="1b61e-148">Ostatní tabulky v schéma nemusíte mít relaci s *místo* tabulky, protože při běžném použití, se nikdy všech nejistých, které klient patří data.</span><span class="sxs-lookup"><span data-stu-id="1b61e-148">Other tables in the schema don't need to be related to the *Venue* table, because in normal use, there is never any doubt which tenant the data belongs to.</span></span>

<span data-ttu-id="1b61e-149">Ale při dotazování mezi všechny databáze, je důležité, aby elastické dotazu lze považovat data, pokud je součástí jedné logické databáze horizontálně dělené klientem.</span><span class="sxs-lookup"><span data-stu-id="1b61e-149">However, when querying across all databases, it's important that Elastic Query can treat the data as if it is part of a single logical database sharded by tenant.</span></span> <span data-ttu-id="1b61e-150">Jak toho docílit, sadu 'globální' zobrazení se přidají do databáze klienta daného projektu id klienta do každé z tabulek, které jsou předmětem dotazování globálně.</span><span class="sxs-lookup"><span data-stu-id="1b61e-150">To achieve this, a set of 'global' views are added to the tenant database that project a tenant id into each of the tables that are queried globally.</span></span> <span data-ttu-id="1b61e-151">Například *VenueEvents* zobrazení přidá počítaný *VenueId* na sloupce ze k projekci *události* tabulky.</span><span class="sxs-lookup"><span data-stu-id="1b61e-151">For example, the *VenueEvents* view adds a computed *VenueId* to the columns projected from the *Events* table.</span></span> <span data-ttu-id="1b61e-152">Definováním externí tabulky v databázi head přes *VenueEvents* (místo základní *události* tabulky), elastické dotazu je schopen nabízená dolů na základě spojení *VenueId*, mohou být provedeny souběžně na každém vzdálené databáze (ne na databázi head).</span><span class="sxs-lookup"><span data-stu-id="1b61e-152">By defining the external table in the head database over *VenueEvents* (rather than the underlying *Events* table), Elastic Query is able to push down joins based on *VenueId* so they can be executed in parallel on each remote database (rather than on the head database).</span></span> <span data-ttu-id="1b61e-153">Tím se výrazně snižuje množství dat, která je vrácena, což vede k podstatné zvýšení výkonu pro mnoho dotazů.</span><span class="sxs-lookup"><span data-stu-id="1b61e-153">This dramatically reduces the amount of data that is returned, which results in a substantial increase in performance for many queries.</span></span> <span data-ttu-id="1b61e-154">Tato globální zobrazení byly předem vytvořené v všechny databáze klienta (a v *basetenantdb*).</span><span class="sxs-lookup"><span data-stu-id="1b61e-154">These global views have been pre-created in all tenant databases (and in *basetenantdb*).</span></span>

1. <span data-ttu-id="1b61e-155">Otevřete aplikaci SSMS a [připojit k tenants1 -&lt;uživatele&gt; server](sql-database-wtp-overview.md#explore-database-schema-and-execute-sql-queries-using-ssms).</span><span class="sxs-lookup"><span data-stu-id="1b61e-155">Open SSMS and [connect to the tenants1-&lt;USER&gt; server](sql-database-wtp-overview.md#explore-database-schema-and-execute-sql-queries-using-ssms).</span></span>
2. <span data-ttu-id="1b61e-156">Rozbalte položku **databáze**, klikněte pravým tlačítkem na **contosoconcerthall**a vyberte **nový dotaz**.</span><span class="sxs-lookup"><span data-stu-id="1b61e-156">Expand **Databases**, right-click **contosoconcerthall**, and select **New Query**.</span></span>
3. <span data-ttu-id="1b61e-157">Spusťte následující dotazy a prozkoumejte rozdíl mezi tabulkami jednoho klienta a globální zobrazení:</span><span class="sxs-lookup"><span data-stu-id="1b61e-157">Run the following queries to explore the difference between the single-tenant tables and the global views:</span></span>

   ```T-SQL
   -- The base Venue table, that has no VenueId associated.
   SELECT * FROM Venue

   -- Notice the plural name 'Venues'. This view projects a VenueId column.
   SELECT * FROM Venues

   -- The base Events table, which has no VenueId column.
   SELECT * FROM Events

   -- This view projects the VenueId retrieved from the Venues table.
   SELECT * FROM VenueEvents
   ```

<span data-ttu-id="1b61e-158">V těchto zobrazeních *VenueId* se vypočítá jako hodnota hash místo názvu, ale žádné přístup může znamenat jedinečnou hodnotu.</span><span class="sxs-lookup"><span data-stu-id="1b61e-158">In these views, the *VenueId* is computed as a hash of the Venue name, but any approach could be used to introduce a unique value.</span></span> <span data-ttu-id="1b61e-159">Tento přístup je podobným způsobem, který je počítaný klíč klienta pro použití v katalogu.</span><span class="sxs-lookup"><span data-stu-id="1b61e-159">This approach is similar to the way the tenant key is computed for use in the catalog.</span></span>

<span data-ttu-id="1b61e-160">K prozkoumání definice *místa* zobrazení:</span><span class="sxs-lookup"><span data-stu-id="1b61e-160">To examine the definition of the *Venues* view:</span></span>

1. <span data-ttu-id="1b61e-161">V **Průzkumník objektů**, rozbalte položku **contosoconcethall** > **zobrazení**:</span><span class="sxs-lookup"><span data-stu-id="1b61e-161">In **Object Explorer**, expand **contosoconcethall** > **Views**:</span></span>

   ![zobrazení](media/sql-database-saas-tutorial-adhoc-analytics/views.png)

2. <span data-ttu-id="1b61e-163">Klikněte pravým tlačítkem na **dbo. Místa**.</span><span class="sxs-lookup"><span data-stu-id="1b61e-163">Right-click **dbo.Venues**.</span></span>
3. <span data-ttu-id="1b61e-164">Vyberte **skript zobrazení jako** > **vytvořit** > **nové okno editoru dotazů**</span><span class="sxs-lookup"><span data-stu-id="1b61e-164">Select **Script View as** > **CREATE To** > **New Query Editor Window**</span></span>

<span data-ttu-id="1b61e-165">Skript žádnému jinému *místo* zobrazení pro zobrazení, jak přidat *VenueId*.</span><span class="sxs-lookup"><span data-stu-id="1b61e-165">Script any of the other *Venue* views to see how they add the *VenueId*.</span></span>

## <a name="deploy-the-database-used-for-ad-hoc-distributed-queries"></a><span data-ttu-id="1b61e-166">Nasazení databáze používá pro ad-hoc distribuované dotazy</span><span class="sxs-lookup"><span data-stu-id="1b61e-166">Deploy the database used for ad-hoc distributed queries</span></span>

<span data-ttu-id="1b61e-167">Toto cvičení nasadí *adhocanalytics* databáze.</span><span class="sxs-lookup"><span data-stu-id="1b61e-167">This exercise deploys the *adhocanalytics* database.</span></span> <span data-ttu-id="1b61e-168">Toto je head databáze, která bude obsahovat schématu použitého k dotazování mezi všechny databáze klienta.</span><span class="sxs-lookup"><span data-stu-id="1b61e-168">This is the head database that will contain the schema used for querying across all tenant databases.</span></span> <span data-ttu-id="1b61e-169">Databáze je nasazený na existující server katalogu, které je server používá pro všechny databáze v ukázkové aplikace týkajících se správy.</span><span class="sxs-lookup"><span data-stu-id="1b61e-169">The database is deployed to the existing catalog server, which is the server used for all management-related databases in the sample app.</span></span>

1. <span data-ttu-id="1b61e-170">Otevřete skript ...\\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalytics.ps1* ve složce *PowerShell ISE* a nastavte následující hodnoty:</span><span class="sxs-lookup"><span data-stu-id="1b61e-170">Open ...\\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalytics.ps1* in the *PowerShell ISE* and set the following values:</span></span>
   * <span data-ttu-id="1b61e-171">**$DemoScenario** = 2, **Deploy Ad-hoc analytics database** (Nasadit analytickou databázi ad hoc).</span><span class="sxs-lookup"><span data-stu-id="1b61e-171">**$DemoScenario** = 2, **Deploy Ad-hoc analytics database**.</span></span>

2. <span data-ttu-id="1b61e-172">Stiskněte klávesu **F5** spusťte skript a vytvořit *adhocanalytics* databáze.</span><span class="sxs-lookup"><span data-stu-id="1b61e-172">Press **F5** to run the script and create the *adhocanalytics* database.</span></span>

<span data-ttu-id="1b61e-173">V další části přidáte schématu do databáze, může sloužit ke spuštění distribuovaných dotazů.</span><span class="sxs-lookup"><span data-stu-id="1b61e-173">In the next section, you add schema to the database so it can be used to run distributed queries.</span></span>

## <a name="configure-the-database-for-running-distributed-queries"></a><span data-ttu-id="1b61e-174">Konfigurace databáze pro spuštění distribuovaných dotazů</span><span class="sxs-lookup"><span data-stu-id="1b61e-174">Configure the database for running distributed queries</span></span>

<span data-ttu-id="1b61e-175">Tento postup přidá do databáze analýzy ad-hoc, která umožňuje dotazování mezi všechny databáze klienta schématu (externí zdroj dat a definice externí tabulky).</span><span class="sxs-lookup"><span data-stu-id="1b61e-175">This exercise adds schema (the external data source and external table definitions) to the ad-hoc analytics database that enables querying across all tenant databases.</span></span>

1. <span data-ttu-id="1b61e-176">Otevřete SQL Server Management Studio a připojte k databázi ad hoc analýzy, kterou jste vytvořili v předchozím kroku.</span><span class="sxs-lookup"><span data-stu-id="1b61e-176">Open SQL Server Management Studio, and connect to the Adhoc Analytics database you created in the previous step.</span></span> <span data-ttu-id="1b61e-177">Název databáze bude adhocanalytics.</span><span class="sxs-lookup"><span data-stu-id="1b61e-177">The name of the database will be adhocanalytics.</span></span>
2. <span data-ttu-id="1b61e-178">Otevřete ...\Learning Modules\Operational Analytics\Adhoc Analytics\ *inicializovat AdhocAnalyticsDB.sql* v aplikaci SSMS.</span><span class="sxs-lookup"><span data-stu-id="1b61e-178">Open ...\Learning Modules\Operational Analytics\Adhoc Analytics\ *Initialize-AdhocAnalyticsDB.sql* in SSMS.</span></span>
3. <span data-ttu-id="1b61e-179">Zkontrolujte skript SQL a vezměte na vědomí následující:</span><span class="sxs-lookup"><span data-stu-id="1b61e-179">Review the SQL script and note the following:</span></span>

   <span data-ttu-id="1b61e-180">Elastické dotazu pomocí přihlašovacích údajů platných pro databázi přístup ke každé databáze klienta.</span><span class="sxs-lookup"><span data-stu-id="1b61e-180">Elastic Query uses a database-scoped credential to access each of the tenant databases.</span></span> <span data-ttu-id="1b61e-181">Tato pověření musí být k dispozici ve všech databází a by měl obvykle být uděleno minimální práva potřebná k povolení těchto dotazů ad-hoc.</span><span class="sxs-lookup"><span data-stu-id="1b61e-181">This credential needs to be available in all the databases and should normally be granted the minimum rights required to enable these ad-hoc queries.</span></span>

    ![Vytvoření pověření](media/sql-database-saas-tutorial-adhoc-analytics/create-credential.png)

   <span data-ttu-id="1b61e-183">Zdroj externích dat, která je definována pomocí mapování horizontálních klienta v databázi katalogu.</span><span class="sxs-lookup"><span data-stu-id="1b61e-183">The external data source, that is defined to use the tenant shard map in the catalog database.</span></span> <span data-ttu-id="1b61e-184">Prostřednictvím tohoto jako zdroj externích dat jsou dotazy distribuovány do všech databází, které jsou zaregistrovány v katalogu při spuštění dotazu.</span><span class="sxs-lookup"><span data-stu-id="1b61e-184">By using this as the external data source, queries are distributed to all databases registered in the catalog when the query is run.</span></span> <span data-ttu-id="1b61e-185">Vzhledem k tomu, že názvy serverů se liší pro každé nasazení, získá tento skript inicializace umístění databáze katalogu načtením aktuální server (@@servername) němž se skript spustí.</span><span class="sxs-lookup"><span data-stu-id="1b61e-185">Because server names are different for each deployment, this initialization script gets the location of the catalog database by retrieving the current server (@@servername) where the script is executed.</span></span>

    ![Vytvoření externího zdroje dat](media/sql-database-saas-tutorial-adhoc-analytics/create-external-data-source.png)

   <span data-ttu-id="1b61e-187">Externí tabulky, které odkazují na globální zobrazení popsané v předchozí části a definovaná pomocí **distribuční = SHARDED(VenueId)**.</span><span class="sxs-lookup"><span data-stu-id="1b61e-187">The external tables that reference the global views described in the previous section, and defined with **DISTRIBUTION = SHARDED(VenueId)**.</span></span> <span data-ttu-id="1b61e-188">Protože každý *VenueId* mapuje jedné databáze, to zvyšuje výkon pro mnoho scénářů, jak je znázorněno v následujícím oddílu.</span><span class="sxs-lookup"><span data-stu-id="1b61e-188">Because each *VenueId* maps to a single database, this improves performance for many scenarios as shown in the next section.</span></span>

    ![Vytvoření externí tabulky](media/sql-database-saas-tutorial-adhoc-analytics/external-tables.png)

   <span data-ttu-id="1b61e-190">Místní tabulky *VenueTypes* , je vytvořeny a naplněny.</span><span class="sxs-lookup"><span data-stu-id="1b61e-190">The local table *VenueTypes* that is created and populated.</span></span> <span data-ttu-id="1b61e-191">Tuto referenční tabulku dat je běžné v všechny klienta databáze, tak může být reprezentován jako na místní tabulku a vyplněná běžné daty.</span><span class="sxs-lookup"><span data-stu-id="1b61e-191">This reference data table is common in all tenant databases, so it can be represented here as a local table and populated with the common data.</span></span> <span data-ttu-id="1b61e-192">Pro některé dotazy to může snížit množství dat přesunout mezi databázemi klienta a *adhocanalytics* databáze.</span><span class="sxs-lookup"><span data-stu-id="1b61e-192">For some queries this may reduce the amount of data moved between the tenant databases and the *adhocanalytics* database.</span></span>

    ![Vytvoření tabulky](media/sql-database-saas-tutorial-adhoc-analytics/create-table.png)

   <span data-ttu-id="1b61e-194">Pokud zahrnete referenční tabulky tímto způsobem, nezapomeňte aktualizovat schéma tabulky a data při každé aktualizaci databáze klienta.</span><span class="sxs-lookup"><span data-stu-id="1b61e-194">If you include reference tables in this manner, be sure to update the table schema and data whenever you update the tenant databases.</span></span>

4. <span data-ttu-id="1b61e-195">Stiskněte klávesu **F5** inicializaci a spuštění skriptu *adhocanalytics* databáze.</span><span class="sxs-lookup"><span data-stu-id="1b61e-195">Press **F5** to run the script and initialize the *adhocanalytics* database.</span></span> 

<span data-ttu-id="1b61e-196">Nyní můžete spustit distribuované dotazy a shromažďovat statistiky napříč všichni klienti!</span><span class="sxs-lookup"><span data-stu-id="1b61e-196">Now you can run distributed queries, and gather insights across all tenants!</span></span>

## <a name="run-ad-hoc-distributed-queries"></a><span data-ttu-id="1b61e-197">Spuštění dotazů ad-hoc distribuované</span><span class="sxs-lookup"><span data-stu-id="1b61e-197">Run ad-hoc distributed queries</span></span>

<span data-ttu-id="1b61e-198">Teď, když *adhocanalytics* databáze je nastavit, aby ihned začít a spustit některé distribuované dotazy.</span><span class="sxs-lookup"><span data-stu-id="1b61e-198">Now that the *adhocanalytics* database is set up, go ahead and run some distributed queries.</span></span> <span data-ttu-id="1b61e-199">Zahrnout plán spuštění lépe porozumět tomu, kde se zpracování dotazu děje.</span><span class="sxs-lookup"><span data-stu-id="1b61e-199">Include the execution plan for a better understanding of where the query processing is happening.</span></span> 

<span data-ttu-id="1b61e-200">Při kontrole plán spuštění, pozastavte ukazatel myši nad ikony plán podrobnosti.</span><span class="sxs-lookup"><span data-stu-id="1b61e-200">When inspecting the execution plan, hover over the plan icons for details.</span></span> 

<span data-ttu-id="1b61e-201">Je důležité si uvědomit, že nastavení **distribuční = SHARDED(VenueId)** když jsme definovali externí zdroj dat, zlepšuje výkon pro mnoho scénářů.</span><span class="sxs-lookup"><span data-stu-id="1b61e-201">Important to note, is that setting **DISTRIBUTION = SHARDED(VenueId)** when we defined the external data source, improves performance for many scenarios.</span></span> <span data-ttu-id="1b61e-202">Protože každý *VenueId* mapuje jedné databáze, filtrování je snadno provést vzdáleně, vrací pouze data, potřebujeme.</span><span class="sxs-lookup"><span data-stu-id="1b61e-202">Because each *VenueId* maps to a single database, filtering is easily done remotely, returning only the data we need.</span></span>

1. <span data-ttu-id="1b61e-203">Otevřete skript …\\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalyticsQueries.sql* v SSMS.</span><span class="sxs-lookup"><span data-stu-id="1b61e-203">Open ...\\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalyticsQueries.sql* in SSMS.</span></span>
2. <span data-ttu-id="1b61e-204">Zkontrolujte připojení k **adhocanalytics** databáze.</span><span class="sxs-lookup"><span data-stu-id="1b61e-204">Ensure you are connected to the **adhocanalytics** database.</span></span>
3. <span data-ttu-id="1b61e-205">Vyberte **dotazu** nabídky a klikněte na tlačítko **zahrnují skutečné naplánovat spuštění**</span><span class="sxs-lookup"><span data-stu-id="1b61e-205">Select the **Query** menu and click **Include Actual Execution Plan**</span></span>
4. <span data-ttu-id="1b61e-206">Zvýrazněte *místa, které jsou aktuálně registrované?* dotazu a stiskněte klávesu **F5**.</span><span class="sxs-lookup"><span data-stu-id="1b61e-206">Highlight the *Which venues are currently registered?* query, and press **F5**.</span></span>

   <span data-ttu-id="1b61e-207">Dotaz vrátí seznamu celý místo ilustrující způsob rychlé a snadné je k dotazování mezi všechny klienty a vrátit data z každého klienta.</span><span class="sxs-lookup"><span data-stu-id="1b61e-207">The query returns the entire venue list, illustrating how quick and easy it is to query across all tenants and return data from each tenant.</span></span>

   <span data-ttu-id="1b61e-208">Zkontrolujte plán a zjistíte, že náklady je vzdálený dotaz, protože jsme jednoduše přejdete na každou databázi klienta a výběrem informace místo.</span><span class="sxs-lookup"><span data-stu-id="1b61e-208">Inspect the plan and see that the entire cost is the remote query because we're simply going to each tenant database and selecting the venue information.</span></span>

   ![Vybrat * z dbo. Místa](media/sql-database-saas-tutorial-adhoc-analytics/query1-plan.png)

5. <span data-ttu-id="1b61e-210">Vyberte další dotaz a stiskněte klávesu **F5**.</span><span class="sxs-lookup"><span data-stu-id="1b61e-210">Select the next query, and press **F5**.</span></span>

   <span data-ttu-id="1b61e-211">Tento dotaz připojí data z databáze klienta a místní *VenueTypes* tabulky (místní počítač, protože je tabulka *adhocanalytics* databáze).</span><span class="sxs-lookup"><span data-stu-id="1b61e-211">This query joins data from the tenant databases and the local *VenueTypes* table (local, as its a table in the *adhocanalytics* database).</span></span>

   <span data-ttu-id="1b61e-212">Zkontrolujte plán a zjistíte, že většina náklady je vzdálený dotaz, protože jsme dotaz na informace místo každého klienta (dbo. Místa), a poté proveďte rychlé místní spojení s místní *VenueTypes* tabulka, která se zobrazí popisný název.</span><span class="sxs-lookup"><span data-stu-id="1b61e-212">Inspect the plan and see that the majority of cost is the remote query because we query each tenant's venue info (dbo.Venues), and then do a quick local join with the local *VenueTypes* table to display the friendly name.</span></span>

   ![Připojení k vzdálené a místní data](media/sql-database-saas-tutorial-adhoc-analytics/query2-plan.png)

6. <span data-ttu-id="1b61e-214">Nyní vybrat *den, kdy byly nejvíce lístků prodaných?* dotazu a stiskněte klávesu **F5**.</span><span class="sxs-lookup"><span data-stu-id="1b61e-214">Now select the *On which day were the most tickets sold?* query, and press **F5**.</span></span>

   <span data-ttu-id="1b61e-215">Tento dotaz nemá trochu složitější spojování a agregaci.</span><span class="sxs-lookup"><span data-stu-id="1b61e-215">This query does a bit more complex joining and aggregation.</span></span> <span data-ttu-id="1b61e-216">Co je důležité si uvědomit, je, že se vzdáleně provádí většinu zpracování a ještě jednou budeme navrácení pouze řádky, které potřebujeme, vrácení pouze jeden řádek pro každý místo agregační lístku prodej počet za den.</span><span class="sxs-lookup"><span data-stu-id="1b61e-216">What's important to note is that most of the processing is done remotely, and once again, we bring back only the rows we need, returning just a single row for each venue's aggregate ticket sale count per day.</span></span>

   ![query](media/sql-database-saas-tutorial-adhoc-analytics/query3-plan.png)


## <a name="next-steps"></a><span data-ttu-id="1b61e-218">Další kroky</span><span class="sxs-lookup"><span data-stu-id="1b61e-218">Next steps</span></span>

<span data-ttu-id="1b61e-219">V tomto kurzu jste se naučili:</span><span class="sxs-lookup"><span data-stu-id="1b61e-219">In this tutorial you learned how to:</span></span>

> [!div class="checklist"]

> * <span data-ttu-id="1b61e-220">Spouštění distribuovaných dotazů ve všech tenantských databázích</span><span class="sxs-lookup"><span data-stu-id="1b61e-220">Run distributed queries across all tenant databases</span></span>
> * <span data-ttu-id="1b61e-221">Nasazení databáze služby ad-hoc analýzy a přidejte do jeho spuštění distribuované dotazy schématu.</span><span class="sxs-lookup"><span data-stu-id="1b61e-221">Deploy an ad-hoc analytics database and add schema to it to run distributed queries.</span></span>


<span data-ttu-id="1b61e-222">Nyní zkuste [klienta Analytics kurzu](sql-database-saas-tutorial-tenant-analytics.md) prozkoumat extrakce dat k databázi samostatné analytics pro zpracování složitějších analýzy...</span><span class="sxs-lookup"><span data-stu-id="1b61e-222">Now try the [Tenant Analytics tutorial](sql-database-saas-tutorial-tenant-analytics.md) to explore extracting data to a separate analytics database for more complex analytics processing...</span></span>

## <a name="additional-resources"></a><span data-ttu-id="1b61e-223">Další zdroje</span><span class="sxs-lookup"><span data-stu-id="1b61e-223">Additional resources</span></span>

* <span data-ttu-id="1b61e-224">Další [návodů, které stavět na adresář Wingtip SaaS aplikace](sql-database-wtp-overview.md#sql-database-wingtip-saas-tutorials)</span><span class="sxs-lookup"><span data-stu-id="1b61e-224">Additional [tutorials that build upon the Wingtip SaaS application](sql-database-wtp-overview.md#sql-database-wingtip-saas-tutorials)</span></span>
* [<span data-ttu-id="1b61e-225">Elastic Query</span><span class="sxs-lookup"><span data-stu-id="1b61e-225">Elastic Query</span></span>](sql-database-elastic-query-overview.md)
