---
title: "aaaUsing správce obnovení toofix horizontálních mapování problémy | Microsoft Docs"
description: "Použít hello RecoveryManager třída toosolve problémy s horizontálního oddílu mapy"
services: sql-database
documentationcenter: 
manager: jhubbard
author: ddove
ms.assetid: 45520ca3-6903-4b39-88ba-1d41b22da9fe
ms.service: sql-database
ms.custom: scale out apps
ms.workload: sql-database
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 10/25/2016
ms.author: ddove
ms.openlocfilehash: 2218fb15122f1df466e65483480461e366317f2f
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 10/06/2017
---
# <a name="using-hello-recoverymanager-class-toofix-shard-map-problems"></a><span data-ttu-id="800be-103">Pomocí hello RecoveryManager třída toofix horizontálního oddílu mapy problémy</span><span class="sxs-lookup"><span data-stu-id="800be-103">Using hello RecoveryManager class toofix shard map problems</span></span>
<span data-ttu-id="800be-104">Hello [RecoveryManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.aspx) třída poskytuje ADO.Net aplikace hello možnost tooeasily zjistit a opravit nekonzistence mezi hello globální horizontálních mapy (GSM) a hello místní horizontálních mapy (LSM) v prostředí s horizontálně dělené databáze.</span><span class="sxs-lookup"><span data-stu-id="800be-104">hello [RecoveryManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.aspx) class provides ADO.Net applications hello ability tooeasily detect and correct any inconsistencies between hello global shard map (GSM) and hello local shard map (LSM) in a sharded database environment.</span></span> 

<span data-ttu-id="800be-105">Hello GSM a LSM sledovat hello mapování jednotlivých databází v horizontálně dělené prostředí.</span><span class="sxs-lookup"><span data-stu-id="800be-105">hello GSM and LSM track hello mapping of each database in a sharded environment.</span></span> <span data-ttu-id="800be-106">V některých případech zalomení probíhá mezi hello GSM a hello LSM.</span><span class="sxs-lookup"><span data-stu-id="800be-106">Occasionally, a break occurs between hello GSM and hello LSM.</span></span> <span data-ttu-id="800be-107">V takovém případě použijte hello RecoveryManager třída toodetect a opravit hello přerušení.</span><span class="sxs-lookup"><span data-stu-id="800be-107">In that case, use hello RecoveryManager class toodetect and repair hello break.</span></span>

<span data-ttu-id="800be-108">Hello RecoveryManager třída je součástí hello [klientské knihovny pro elastické databáze](sql-database-elastic-database-client-library.md).</span><span class="sxs-lookup"><span data-stu-id="800be-108">hello RecoveryManager class is part of hello [Elastic Database client library](sql-database-elastic-database-client-library.md).</span></span> 

![Mapování horizontálních][1]

<span data-ttu-id="800be-110">Definice podmínek, najdete v části [Glosář nástroje elastické databáze](sql-database-elastic-scale-glossary.md).</span><span class="sxs-lookup"><span data-stu-id="800be-110">For term definitions, see [Elastic Database tools glossary](sql-database-elastic-scale-glossary.md).</span></span> <span data-ttu-id="800be-111">jak hello toounderstand **ShardMapManager** je použité toomanage data v horizontálně dělené řešení, najdete v části [správu mapování horizontálních](sql-database-elastic-scale-shard-map-management.md).</span><span class="sxs-lookup"><span data-stu-id="800be-111">toounderstand how hello **ShardMapManager** is used toomanage data in a sharded solution, see [Shard map management](sql-database-elastic-scale-shard-map-management.md).</span></span>

## <a name="why-use-hello-recovery-manager"></a><span data-ttu-id="800be-112">Proč používat Správce hello obnovení?</span><span class="sxs-lookup"><span data-stu-id="800be-112">Why use hello recovery manager?</span></span>
<span data-ttu-id="800be-113">V prostředí s horizontálně dělené databáze není jednoho klienta na databázi a mnoho databází na serveru.</span><span class="sxs-lookup"><span data-stu-id="800be-113">In a sharded database environment, there is one tenant per database, and many databases per server.</span></span> <span data-ttu-id="800be-114">V prostředí hello může být také mnoho serverů.</span><span class="sxs-lookup"><span data-stu-id="800be-114">There can also be many servers in hello environment.</span></span> <span data-ttu-id="800be-115">Každou databázi je namapována v mapě horizontálního oddílu hello, takže volání může být směrované toohello správný server a databáze.</span><span class="sxs-lookup"><span data-stu-id="800be-115">Each database is mapped in hello shard map, so calls can be routed toohello correct server and database.</span></span> <span data-ttu-id="800be-116">Databáze se sledují podle tooa **horizontálního dělení klíč**, a je mu přiřazená každý horizontálního oddílu **rozsah hodnot klíče**.</span><span class="sxs-lookup"><span data-stu-id="800be-116">Databases are tracked according tooa **sharding key**, and each shard is assigned a **range of key values**.</span></span> <span data-ttu-id="800be-117">Například klíč horizontálního dělení může představovat hello zákazníka názvy z "D" příliš "F."</span><span class="sxs-lookup"><span data-stu-id="800be-117">For example, a sharding key may represent hello customer names from "D" too"F."</span></span> <span data-ttu-id="800be-118">Hello mapování horizontálních oddílů všechny (neboli databáze) a jejich mapování rozsahy jsou obsaženy v hello **globální horizontálních mapy (GSM)**.</span><span class="sxs-lookup"><span data-stu-id="800be-118">hello mapping of all shards (aka databases) and their mapping ranges are contained in hello **global shard map (GSM)**.</span></span> <span data-ttu-id="800be-119">Každá databáze také obsahuje mapu rozsahů hello obsažených v hello horizontálního oddílu, který se označuje jako hello **místní horizontálních mapy (LSM)**.</span><span class="sxs-lookup"><span data-stu-id="800be-119">Each database also contains a map of hello ranges contained on hello shard that is known as hello **local shard map (LSM)**.</span></span> <span data-ttu-id="800be-120">Když se aplikace připojí tooa horizontálního oddílu, hello mapování se uloží do mezipaměti s hello aplikací pro rychlé načítání.</span><span class="sxs-lookup"><span data-stu-id="800be-120">When an app connects tooa shard, hello mapping is cached with hello app for quick retrieval.</span></span> <span data-ttu-id="800be-121">Hello LSM je dat použité toovalidate do mezipaměti.</span><span class="sxs-lookup"><span data-stu-id="800be-121">hello LSM is used toovalidate cached data.</span></span> 

<span data-ttu-id="800be-122">Hello GSM a LSM se mohou stát synchronizována pro hello následujících důvodů:</span><span class="sxs-lookup"><span data-stu-id="800be-122">hello GSM and LSM may become out of sync for hello following reasons:</span></span>

1. <span data-ttu-id="800be-123">odstranění Hello horizontálních, jejichž rozsah předpokládá toono delší být používán nebo přejmenování horizontálního oddílu.</span><span class="sxs-lookup"><span data-stu-id="800be-123">hello deletion of a shard whose range is believed toono longer be in use, or renaming of a shard.</span></span> <span data-ttu-id="800be-124">Odstranění horizontálního oddílu vede **osamocené mapování horizontálních**.</span><span class="sxs-lookup"><span data-stu-id="800be-124">Deleting a shard results in an **orphaned shard mapping**.</span></span> <span data-ttu-id="800be-125">Podobně přejmenovat databázi, může způsobit mapování u osamocených horizontálního oddílu.</span><span class="sxs-lookup"><span data-stu-id="800be-125">Similarly, a renamed database can cause an orphaned shard mapping.</span></span> <span data-ttu-id="800be-126">V závislosti na hello záměr hello změny hello horizontálních může být nutné toobe odebrat nebo umístění horizontálního oddílu hello musí toobe aktualizovat.</span><span class="sxs-lookup"><span data-stu-id="800be-126">Depending on hello intent of hello change, hello shard may need toobe removed or hello shard location needs toobe updated.</span></span> <span data-ttu-id="800be-127">toorecover odstraněné databáze najdete v části [obnovit odstraněnou databázi](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="800be-127">toorecover a deleted database, see [Restore a deleted database](sql-database-recovery-using-backups.md).</span></span>
2. <span data-ttu-id="800be-128">Dojde k události geo-převzetí služeb při selhání.</span><span class="sxs-lookup"><span data-stu-id="800be-128">A geo-failover event occurs.</span></span> <span data-ttu-id="800be-129">toocontinue, jeden musíte aktualizovat hello název serveru a název databáze správce mapy horizontálního oddílu v hello aplikaci a pak podrobné informace o aktualizaci hello horizontálního oddílu mapování pro všechny horizontálních oddílů v mapě horizontálního oddílu.</span><span class="sxs-lookup"><span data-stu-id="800be-129">toocontinue, one must update hello server name, and database name of shard map manager in hello application and then update hello shard mapping details for all shards in a shard map.</span></span> <span data-ttu-id="800be-130">Pokud dojde k selhání geograficky, by je možné automatizovat tuto logiku obnovení v rámci pracovního postupu hello převzetí služeb při selhání.</span><span class="sxs-lookup"><span data-stu-id="800be-130">If there is a geo-failover, such recovery logic should be automated within hello failover workflow.</span></span> <span data-ttu-id="800be-131">Automatizace akce obnovení umožňuje hladký možnosti správy databází s povolenou geografickou a zabraňuje ruční lidského akce.</span><span class="sxs-lookup"><span data-stu-id="800be-131">Automating recovery actions enables a frictionless manageability for geo-enabled databases and avoids manual human actions.</span></span> <span data-ttu-id="800be-132">toolearn o toorecover možnosti databáze při výpadku datacentra, najdete v části [kontinuity podnikových procesů](sql-database-business-continuity.md) a [zotavení po havárii](sql-database-disaster-recovery.md).</span><span class="sxs-lookup"><span data-stu-id="800be-132">toolearn about options toorecover a database if there is a data center outage, see [Business Continuity](sql-database-business-continuity.md) and [Disaster Recovery](sql-database-disaster-recovery.md).</span></span>
3. <span data-ttu-id="800be-133">Buď horizontálního oddílu, nebo hello ShardMapManager databáze je obnovený tooan předchozí stav bodu.</span><span class="sxs-lookup"><span data-stu-id="800be-133">Either a shard or hello ShardMapManager database is restored tooan earlier point-in time.</span></span> <span data-ttu-id="800be-134">toolearn o bodu obnovení pomocí záloh, najdete v části [obnovení pomocí záloh](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="800be-134">toolearn about point in time recovery using backups, see [Recovery using backups](sql-database-recovery-using-backups.md).</span></span>

<span data-ttu-id="800be-135">Další informace o nástroje elastické databáze pro databázi SQL Azure, geografická replikace a obnovení najdete v tématu hello následující:</span><span class="sxs-lookup"><span data-stu-id="800be-135">For more information about Azure SQL Database Elastic Database tools, geo-replication and Restore, see hello following:</span></span> 

* [<span data-ttu-id="800be-136">Přehled: Cloudu obchodní kontinuitu a databáze zotavení po havárii s databází SQL</span><span class="sxs-lookup"><span data-stu-id="800be-136">Overview: Cloud business continuity and database disaster recovery with SQL Database</span></span>](sql-database-business-continuity.md) 
* [<span data-ttu-id="800be-137">Začínáme s nástroje elastické databáze</span><span class="sxs-lookup"><span data-stu-id="800be-137">Get started with elastic database tools</span></span>](sql-database-elastic-scale-get-started.md)  
* [<span data-ttu-id="800be-138">ShardMap správy</span><span class="sxs-lookup"><span data-stu-id="800be-138">ShardMap Management</span></span>](sql-database-elastic-scale-shard-map-management.md)

## <a name="retrieving-recoverymanager-from-a-shardmapmanager"></a><span data-ttu-id="800be-139">Načítání RecoveryManager z ShardMapManager</span><span class="sxs-lookup"><span data-stu-id="800be-139">Retrieving RecoveryManager from a ShardMapManager</span></span>
<span data-ttu-id="800be-140">prvním krokem Hello je toocreate RecoveryManager instance.</span><span class="sxs-lookup"><span data-stu-id="800be-140">hello first step is toocreate a RecoveryManager instance.</span></span> <span data-ttu-id="800be-141">Hello [GetRecoveryManager metoda](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getrecoverymanager.aspx) vrátí hello správce obnovení pro aktuální hello [ShardMapManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.aspx) instance.</span><span class="sxs-lookup"><span data-stu-id="800be-141">hello [GetRecoveryManager method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getrecoverymanager.aspx) returns hello recovery manager for hello current [ShardMapManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.aspx) instance.</span></span> <span data-ttu-id="800be-142">mapování nekonzistencím v hello horizontálních tooaddress, musí nejdřív načíst hello RecoveryManager pro mapu konkrétní horizontálních hello.</span><span class="sxs-lookup"><span data-stu-id="800be-142">tooaddress any inconsistencies in hello shard map, you must first retrieve hello RecoveryManager for hello particular shard map.</span></span> 

   ```
    ShardMapManager smm = ShardMapManagerFactory.GetSqlShardMapManager(smmConnnectionString,  
             ShardMapManagerLoadPolicy.Lazy);
             RecoveryManager rm = smm.GetRecoveryManager(); 
   ```

<span data-ttu-id="800be-143">V tomto příkladu je hello RecoveryManager inicializován ze hello ShardMapManager.</span><span class="sxs-lookup"><span data-stu-id="800be-143">In this example, hello RecoveryManager is initialized from hello ShardMapManager.</span></span> <span data-ttu-id="800be-144">Hello ShardMapManager obsahující ShardMap také již byla inicializována.</span><span class="sxs-lookup"><span data-stu-id="800be-144">hello ShardMapManager containing a ShardMap is also already initialized.</span></span> 

<span data-ttu-id="800be-145">Vzhledem k tomu, že tento kód aplikace zpracovává samotná mapa hello horizontálního oddílu, hello přihlašovací údaje použité metoda factory hello (v předchozím příkladu hello smmConnectionString) by měla být přihlašovací údaje, které mají oprávnění pro čtení a zápis v databázi GSM hello odkazuje hello připojovací řetězec.</span><span class="sxs-lookup"><span data-stu-id="800be-145">Since this application code manipulates hello shard map itself, hello credentials used in hello factory method (in hello preceding example, smmConnectionString) should be credentials that have read-write permissions on hello GSM database referenced by hello connection string.</span></span> <span data-ttu-id="800be-146">Tyto přihlašovací údaje se obvykle liší od připojení tooopen pověření použitá pro směrování závislé na data.</span><span class="sxs-lookup"><span data-stu-id="800be-146">These credentials are typically different from credentials used tooopen connections for data-dependent routing.</span></span> <span data-ttu-id="800be-147">Další informace najdete v tématu [pomocí přihlašovacích údajů v klientovi elastické databáze hello](sql-database-elastic-scale-manage-credentials.md).</span><span class="sxs-lookup"><span data-stu-id="800be-147">For more information, see [Using credentials in hello elastic database client](sql-database-elastic-scale-manage-credentials.md).</span></span>

## <a name="removing-a-shard-from-hello-shardmap-after-a-shard-is-deleted"></a><span data-ttu-id="800be-148">Odebrání horizontálního oddílu z hello ShardMap po odstranění horizontálního oddílu</span><span class="sxs-lookup"><span data-stu-id="800be-148">Removing a shard from hello ShardMap after a shard is deleted</span></span>
<span data-ttu-id="800be-149">Hello [DetachShard metoda](https://msdn.microsoft.com/library/azure/dn842083.aspx) odpojí hello zadané ID horizontálního oddílu z mapování horizontálních hello a odstraní mapování přidružené hello horizontálního oddílu.</span><span class="sxs-lookup"><span data-stu-id="800be-149">hello [DetachShard method](https://msdn.microsoft.com/library/azure/dn842083.aspx) detaches hello given shard from hello shard map and deletes mappings associated with hello shard.</span></span>  

* <span data-ttu-id="800be-150">Parametr umístění Hello je hello horizontálního oddílu umístění, konkrétně název serveru a název databáze, hello horizontálních odpojuje.</span><span class="sxs-lookup"><span data-stu-id="800be-150">hello location parameter is hello shard location, specifically server name and database name, of hello shard being detached.</span></span> 
* <span data-ttu-id="800be-151">Parametr shardMapName Hello je název mapování horizontálních hello.</span><span class="sxs-lookup"><span data-stu-id="800be-151">hello shardMapName parameter is hello shard map name.</span></span> <span data-ttu-id="800be-152">Toto je pouze při více mapami horizontálního oddílu spravuje hello vyžaduje správce mapy stejné ID horizontálního oddílu.</span><span class="sxs-lookup"><span data-stu-id="800be-152">This is only required when multiple shard maps are managed by hello same shard map manager.</span></span> <span data-ttu-id="800be-153">Volitelné.</span><span class="sxs-lookup"><span data-stu-id="800be-153">Optional.</span></span> 


> [!IMPORTANT]
> <span data-ttu-id="800be-154">Tento postup použijte pouze v případě, že jste si jisti, že hello rozsah pro mapování hello aktualizovat je prázdný.</span><span class="sxs-lookup"><span data-stu-id="800be-154">Use this technique only if you are certain that hello range for hello updated mapping is empty.</span></span> <span data-ttu-id="800be-155">metody Hello výše Neprovádět kontrolu pro rozsah hello přesouvání dat, proto je vhodné tooinclude zkontroluje ve vašem kódu.</span><span class="sxs-lookup"><span data-stu-id="800be-155">hello methods above do not check data for hello range being moved, so it is best tooinclude checks in your code.</span></span>
>

<span data-ttu-id="800be-156">V tomto příkladu odebere hello horizontálního oddílu mapy horizontálních oddílů.</span><span class="sxs-lookup"><span data-stu-id="800be-156">This example removes shards from hello shard map.</span></span> 

   ```
   rm.DetachShard(s.Location, customerMap);
   ``` 

<span data-ttu-id="800be-157">mapování horizontálních Hello odráží hello horizontálního oddílu umístění v hello GSM před hello odstranění hello horizontálního oddílu.</span><span class="sxs-lookup"><span data-stu-id="800be-157">hello shard map reflects hello shard location in hello GSM before hello deletion of hello shard.</span></span> <span data-ttu-id="800be-158">Protože hello horizontálních byla odstraněna, předpokládá se, bylo záměrné, hello horizontálního dělení klíče rozsah je již používán.</span><span class="sxs-lookup"><span data-stu-id="800be-158">Because hello shard was deleted, it is assumed this was intentional, and hello sharding key range is no longer in use.</span></span> <span data-ttu-id="800be-159">Pokud ne, můžete provést obnovení bodu v době.</span><span class="sxs-lookup"><span data-stu-id="800be-159">If not, you can execute point-in time restore.</span></span> <span data-ttu-id="800be-160">toorecover horizontálního oddílu hello z starší v daném okamžiku.</span><span class="sxs-lookup"><span data-stu-id="800be-160">toorecover hello shard from an earlier point-in-time.</span></span> <span data-ttu-id="800be-161">(V takovém případě zkontrolujte hello následující části toodetect horizontálního oddílu nekonzistence.) toorecover, najdete v části [bodu v době obnovení](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="800be-161">(In that case, review hello following section toodetect shard inconsistencies.) toorecover, see [Point in time recovery](sql-database-recovery-using-backups.md).</span></span>

<span data-ttu-id="800be-162">Vzhledem k tomu, že se předpokládá, že byl odstraněn databáze hello záměrně, hello konečné správu čištění akce je toodelete hello položka toohello horizontálních ve Správci mapy hello horizontálního oddílu.</span><span class="sxs-lookup"><span data-stu-id="800be-162">Since it is assumed hello database deletion was intentional, hello final administrative cleanup action is toodelete hello entry toohello shard in hello shard map manager.</span></span> <span data-ttu-id="800be-163">To zabraňuje aplikace hello z nechtěně zápis informace tooa rozsah, který není očekáván.</span><span class="sxs-lookup"><span data-stu-id="800be-163">This prevents hello application from inadvertently writing information tooa range that is not expected.</span></span>

## <a name="toodetect-mapping-differences"></a><span data-ttu-id="800be-164">rozdíly toodetect mapování</span><span class="sxs-lookup"><span data-stu-id="800be-164">toodetect mapping differences</span></span>
<span data-ttu-id="800be-165">Hello [DetectMappingDifferences metoda](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.detectmappingdifferences.aspx) vybere a vrátí jednu z hello horizontálního oddílu mapy (místní nebo globální) jako zdroj hello založená a sloučí mapování na obou horizontálního oddílu mapy (GSM a LSM).</span><span class="sxs-lookup"><span data-stu-id="800be-165">hello [DetectMappingDifferences method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.detectmappingdifferences.aspx) selects and returns one of hello shard maps (either local or global) as hello source of truth and reconciles mappings on both shard maps (GSM and LSM).</span></span>

   ```
   rm.DetectMappingDifferences(location, shardMapName);
   ```

* <span data-ttu-id="800be-166">Hello *umístění* určuje hello název serveru a název databáze.</span><span class="sxs-lookup"><span data-stu-id="800be-166">hello *location* specifies hello server name and database name.</span></span> 
* <span data-ttu-id="800be-167">Hello *shardMapName* parametr je název mapování horizontálních hello.</span><span class="sxs-lookup"><span data-stu-id="800be-167">hello *shardMapName* parameter is hello shard map name.</span></span> <span data-ttu-id="800be-168">Používá se pouze požadované Pokud více mapami horizontálního oddílu spravuje hello správce mapy stejné ID horizontálního oddílu.</span><span class="sxs-lookup"><span data-stu-id="800be-168">This is only required if multiple shard maps are managed by hello same shard map manager.</span></span> <span data-ttu-id="800be-169">Volitelné.</span><span class="sxs-lookup"><span data-stu-id="800be-169">Optional.</span></span> 

## <a name="tooresolve-mapping-differences"></a><span data-ttu-id="800be-170">rozdíly tooresolve mapování</span><span class="sxs-lookup"><span data-stu-id="800be-170">tooresolve mapping differences</span></span>
<span data-ttu-id="800be-171">Hello [ResolveMappingDifferences metoda](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.resolvemappingdifferences.aspx) vybere jeden hello horizontálního oddílu map (místní nebo globální) jako zdroj hello založená a sloučí mapování na obou horizontálního oddílu mapy (GSM a LSM).</span><span class="sxs-lookup"><span data-stu-id="800be-171">hello [ResolveMappingDifferences method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.resolvemappingdifferences.aspx) selects one of hello shard maps (either local or global) as hello source of truth and reconciles mappings on both shard maps (GSM and LSM).</span></span>

   ```
   ResolveMappingDifferences (RecoveryToken, MappingDifferenceResolution.KeepShardMapping);
   ```

* <span data-ttu-id="800be-172">Hello *RecoveryToken* parametr zobrazí rozdíly hello hello mapování mezi hello GSM a hello LSM pro konkrétní horizontálního oddílu hello.</span><span class="sxs-lookup"><span data-stu-id="800be-172">hello *RecoveryToken* parameter enumerates hello differences in hello mappings between hello GSM and hello LSM for hello specific shard.</span></span> 
* <span data-ttu-id="800be-173">Hello [MappingDifferenceResolution výčtu](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.mappingdifferenceresolution.aspx) je použité tooindicate hello metodu pro překlad hello rozdíl mezi mapování horizontálních hello.</span><span class="sxs-lookup"><span data-stu-id="800be-173">hello [MappingDifferenceResolution enumeration](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.mappingdifferenceresolution.aspx) is used tooindicate hello method for resolving hello difference between hello shard mappings.</span></span> 
* <span data-ttu-id="800be-174">**MappingDifferenceResolution.KeepShardMapping** se doporučuje, když hello LSM obsahuje mapování hello přesné, a proto by měl použít hello mapování horizontálních hello.</span><span class="sxs-lookup"><span data-stu-id="800be-174">**MappingDifferenceResolution.KeepShardMapping** is recommended that when hello LSM contains hello accurate mapping and therefore hello mapping in hello shard should be used.</span></span> <span data-ttu-id="800be-175">To je obvykle případ hello, pokud dojde převzetí služeb při selhání: horizontálního oddílu hello se nyní nachází na nový server.</span><span class="sxs-lookup"><span data-stu-id="800be-175">This is typically hello case if there is a failover: hello shard now resides on a new server.</span></span> <span data-ttu-id="800be-176">Vzhledem k tomu, že hello horizontálního oddílu musí být nejprve odebrány z hello GSM (pomocí metody RecoveryManager.DetachShard hello), mapování na hello GSM už existuje.</span><span class="sxs-lookup"><span data-stu-id="800be-176">Since hello shard must first be removed from hello GSM (using hello RecoveryManager.DetachShard method), a mapping no longer exists on hello GSM.</span></span> <span data-ttu-id="800be-177">Proto hello LSM musí být použité toore-vytvořit mapování horizontálních hello.</span><span class="sxs-lookup"><span data-stu-id="800be-177">Therefore, hello LSM must be used toore-establish hello shard mapping.</span></span>

## <a name="attach-a-shard-toohello-shardmap-after-a-shard-is-restored"></a><span data-ttu-id="800be-178">Připojte horizontálního oddílu toohello ShardMap po obnovení horizontálního oddílu</span><span class="sxs-lookup"><span data-stu-id="800be-178">Attach a shard toohello ShardMap after a shard is restored</span></span>
<span data-ttu-id="800be-179">Hello [AttachShard metoda](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.attachshard.aspx) připojí hello dané horizontálních toohello horizontálního oddílu mapy.</span><span class="sxs-lookup"><span data-stu-id="800be-179">hello [AttachShard method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.attachshard.aspx) attaches hello given shard toohello shard map.</span></span> <span data-ttu-id="800be-180">Potom zjistí nekonzistencím mapy horizontálního oddílu a aktualizuje hello mapování toomatch hello horizontálních okamžiku hello hello horizontálního oddílu obnovení.</span><span class="sxs-lookup"><span data-stu-id="800be-180">It then detects any shard map inconsistencies and updates hello mappings toomatch hello shard at hello point of hello shard restoration.</span></span> <span data-ttu-id="800be-181">Předpokládá se, že hello databáze je také přejmenovat tooreflect hello původní název databáze (dříve, než byla obnovena hello horizontálního oddílu), od bodu v době obnovení hello výchozí tooa novou databázi spolu s časovým razítkem hello.</span><span class="sxs-lookup"><span data-stu-id="800be-181">It is assumed that hello database is also renamed tooreflect hello original database name (before hello shard was restored), since hello point-in time restoration defaults tooa new database appended with hello timestamp.</span></span> 

   ```
   rm.AttachShard(location, shardMapName)
   ``` 

* <span data-ttu-id="800be-182">Hello *umístění* parametr je hello název serveru a název databáze, připojovaný horizontálních hello.</span><span class="sxs-lookup"><span data-stu-id="800be-182">hello *location* parameter is hello server name and database name, of hello shard being attached.</span></span> 
* <span data-ttu-id="800be-183">Hello *shardMapName* parametr je název mapování horizontálních hello.</span><span class="sxs-lookup"><span data-stu-id="800be-183">hello *shardMapName* parameter is hello shard map name.</span></span> <span data-ttu-id="800be-184">Toto je pouze při více mapami horizontálního oddílu spravuje hello vyžaduje správce mapy stejné ID horizontálního oddílu.</span><span class="sxs-lookup"><span data-stu-id="800be-184">This is only required when multiple shard maps are managed by hello same shard map manager.</span></span> <span data-ttu-id="800be-185">Volitelné.</span><span class="sxs-lookup"><span data-stu-id="800be-185">Optional.</span></span> 

<span data-ttu-id="800be-186">Tento příklad přidá horizontálního oddílu toohello horizontálního oddílu mapu, která byla nedávno obnovena z předchozí stav bodu v.</span><span class="sxs-lookup"><span data-stu-id="800be-186">This example adds a shard toohello shard map that has been recently restored from an earlier point-in time.</span></span> <span data-ttu-id="800be-187">Vzhledem k tomu, že byla obnovena horizontálních hello (konkrétně mapování horizontálních hello v hello LSM hello), je potenciálně nekonzistentní s položkou hello horizontálního oddílu v hello GSM.</span><span class="sxs-lookup"><span data-stu-id="800be-187">Since hello shard (namely hello mapping for hello shard in hello LSM) has been restored, it is potentially inconsistent with hello shard entry in hello GSM.</span></span> <span data-ttu-id="800be-188">Mimo tento příklad kódu hello horizontálních byla obnovena a přejmenovat toohello původní název databáze hello.</span><span class="sxs-lookup"><span data-stu-id="800be-188">Outside of this example code, hello shard was restored and renamed toohello original name of hello database.</span></span> <span data-ttu-id="800be-189">Vzhledem k tomu, že ho byla obnovena, předpokládá se, že je mapování hello v hello LSM hello důvěryhodné mapování.</span><span class="sxs-lookup"><span data-stu-id="800be-189">Since it was restored, it is assumed hello mapping in hello LSM is hello trusted mapping.</span></span> 

   ```
   rm.AttachShard(s.Location, customerMap); 
   var gs = rm.DetectMappingDifferences(s.Location); 
      foreach (RecoveryToken g in gs) 
       { 
       rm.ResolveMappingDifferences(g, MappingDifferenceResolution.KeepShardMapping); 
       } 
   ```

## <a name="updating-shard-locations-after-a-geo-failover-restore-of-hello-shards"></a><span data-ttu-id="800be-190">Aktualizace umístění horizontálního oddílu po geo-převzetí služeb při selhání (obnovení) horizontálních oddílů hello</span><span class="sxs-lookup"><span data-stu-id="800be-190">Updating shard locations after a geo-failover (restore) of hello shards</span></span>
<span data-ttu-id="800be-191">Pokud dojde k selhání geograficky, hello sekundární databáze se provádí zápis přístupný a že bude hello nové primární databáze.</span><span class="sxs-lookup"><span data-stu-id="800be-191">If there is a geo-failover, hello secondary database is made write accessible and becomes hello new primary database.</span></span> <span data-ttu-id="800be-192">Hello název hello serveru a potenciálně hello databáze (v závislosti na konfiguraci) se může lišit od původní primární hello.</span><span class="sxs-lookup"><span data-stu-id="800be-192">hello name of hello server, and potentially hello database (depending on your configuration), may be different from hello original primary.</span></span> <span data-ttu-id="800be-193">Proto hello položky mapování horizontálních hello v hello GSM a LSM musí být vyřešeny.</span><span class="sxs-lookup"><span data-stu-id="800be-193">Therefore hello mapping entries for hello shard in hello GSM and LSM must be fixed.</span></span> <span data-ttu-id="800be-194">Podobně pokud hello databáze je obnovený tooa jiný název nebo umístění nebo tooan dřívějšího bodu v čase, to může způsobit nekonzistence v rámci služby maps hello horizontálního oddílu.</span><span class="sxs-lookup"><span data-stu-id="800be-194">Similarly, if hello database is restored tooa different name or location, or tooan earlier point in time, this might cause inconsistencies in hello shard maps.</span></span> <span data-ttu-id="800be-195">Hello horizontálního oddílu mapy Manager zpracovává hello distribuční databáze správný toohello otevřená připojení.</span><span class="sxs-lookup"><span data-stu-id="800be-195">hello Shard Map Manager handles hello distribution of open connections toohello correct database.</span></span> <span data-ttu-id="800be-196">Distribuce je založena na datech hello v mapě hello horizontálního oddílu a hodnota hello hello horizontálního dělení klíče, který je cílem hello hello aplikace požadavku.</span><span class="sxs-lookup"><span data-stu-id="800be-196">Distribution is based on hello data in hello shard map and hello value of hello sharding key that is hello target of hello applications request.</span></span> <span data-ttu-id="800be-197">Po geo-převzetí služeb při selhání tyto informace musí být aktualizovány hello přesný název, název databáze a serveru mapování horizontálních hello obnovené databáze.</span><span class="sxs-lookup"><span data-stu-id="800be-197">After a geo-failover, this information must be updated with hello accurate server name, database name and shard mapping of hello recovered database.</span></span> 

## <a name="best-practices"></a><span data-ttu-id="800be-198">Osvědčené postupy</span><span class="sxs-lookup"><span data-stu-id="800be-198">Best practices</span></span>
<span data-ttu-id="800be-199">GEO-převzetí služeb při selhání a obnovení jsou operace, které jsou obvykle spravuje správce cloudu aplikace hello záměrně využitím jedna z funkcí kontinuity obchodních databází SQL Azure.</span><span class="sxs-lookup"><span data-stu-id="800be-199">Geo-failover and recovery are operations typically managed by a cloud administrator of hello application intentionally utilizing one of Azure SQL Databases business continuity features.</span></span> <span data-ttu-id="800be-200">Plánování kontinuity obchodních vyžaduje procesy, postupy a tooensure míry, který provoz firmy můžete pokračovat bez přerušení.</span><span class="sxs-lookup"><span data-stu-id="800be-200">Business continuity planning requires processes, procedures, and measures tooensure that business operations can continue without interruption.</span></span> <span data-ttu-id="800be-201">Hello metody dostupné jako část hello RecoveryManager třída by měla být použita v rámci této pracovní tok tooensure hello GSM a LSM budou kopírovány podle hello obnovení akce.</span><span class="sxs-lookup"><span data-stu-id="800be-201">hello methods available as part of hello RecoveryManager class should be used within this work flow tooensure hello GSM and LSM are kept up-to-date based on hello recovery action taken.</span></span> <span data-ttu-id="800be-202">Je pět základní kroky tooproperly zajištění hello GSM a LSM reflektoval přesné informace o hello po události převzetí služeb při selhání.</span><span class="sxs-lookup"><span data-stu-id="800be-202">There are five basic steps tooproperly ensuring hello GSM and LSM reflect hello accurate information after a failover event.</span></span> <span data-ttu-id="800be-203">Hello tooexecute kód aplikace, které tyto kroky můžete integrovat do existující nástroje a pracovní postup.</span><span class="sxs-lookup"><span data-stu-id="800be-203">hello application code tooexecute these steps can be integrated into existing tools and workflow.</span></span> 

1. <span data-ttu-id="800be-204">Načtení hello RecoveryManager z hello ShardMapManager.</span><span class="sxs-lookup"><span data-stu-id="800be-204">Retrieve hello RecoveryManager from hello ShardMapManager.</span></span> 
2. <span data-ttu-id="800be-205">Odpojte staré horizontálního oddílu hello z mapování horizontálních hello.</span><span class="sxs-lookup"><span data-stu-id="800be-205">Detach hello old shard from hello shard map.</span></span>
3. <span data-ttu-id="800be-206">Připojte hello nové horizontálního oddílu toohello horizontálního oddílu mapování, včetně nové umístění horizontálního oddílu hello.</span><span class="sxs-lookup"><span data-stu-id="800be-206">Attach hello new shard toohello shard map, including hello new shard location.</span></span>
4. <span data-ttu-id="800be-207">Rozpoznat nekonzistence v mapování mezi hello GSM a LSM hello.</span><span class="sxs-lookup"><span data-stu-id="800be-207">Detect inconsistencies in hello mapping between hello GSM and LSM.</span></span> 
5. <span data-ttu-id="800be-208">Rozdíly mezi hello GSM a hello LSM, důvěřující hello LSM vyřešte.</span><span class="sxs-lookup"><span data-stu-id="800be-208">Resolve differences between hello GSM and hello LSM, trusting hello LSM.</span></span> 

<span data-ttu-id="800be-209">Tento příklad provádí hello následující kroky:</span><span class="sxs-lookup"><span data-stu-id="800be-209">This example performs hello following steps:</span></span>

1. <span data-ttu-id="800be-210">Odebere hello horizontálního oddílu mapu, která odráží horizontálního oddílu umístění před převzetím služeb při selhání hello horizontálních oddílů.</span><span class="sxs-lookup"><span data-stu-id="800be-210">Removes shards from hello Shard Map that reflect shard locations before hello failover event.</span></span>
2. <span data-ttu-id="800be-211">Připojí horizontálních oddílů toohello horizontálního oddílu mapy odrážející hello nová horizontálního oddílu umístění (hello parametr "Configuration.SecondaryServer" je nový název serveru hello ale hello stejný název databáze).</span><span class="sxs-lookup"><span data-stu-id="800be-211">Attaches shards toohello Shard Map reflecting hello new shard locations (hello parameter "Configuration.SecondaryServer" is hello new server name but hello same database name).</span></span>
3. <span data-ttu-id="800be-212">Získá tokeny obnovení hello zjišťuje rozdíly mapování mezi hello GSM a hello LSM pro každý horizontálního oddílu.</span><span class="sxs-lookup"><span data-stu-id="800be-212">Retrieves hello recovery tokens by detecting mapping differences between hello GSM and hello LSM for each shard.</span></span> 
4. <span data-ttu-id="800be-213">Přeloží hello nekonzistence mapováním důvěřující hello z hello LSM každý horizontálního oddílu.</span><span class="sxs-lookup"><span data-stu-id="800be-213">Resolves hello inconsistencies by trusting hello mapping from hello LSM of each shard.</span></span> 
   
   ```
   var shards = smm.GetShards(); 
   foreach (shard s in shards) 
   { 
     if (s.Location.Server == Configuration.PrimaryServer) 
   
         { 
          ShardLocation slNew = new ShardLocation(Configuration.SecondaryServer, s.Location.Database); 
   
          rm.DetachShard(s.Location); 
   
          rm.AttachShard(slNew); 
   
          var gs = rm.DetectMappingDifferences(slNew); 
   
          foreach (RecoveryToken g in gs) 
            { 
               rm.ResolveMappingDifferences(g, MappingDifferenceResolution.KeepShardMapping); 
            } 
        } 
    } 
   ```

[!INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

<!--Image references-->
[1]: ./media/sql-database-elastic-database-recovery-manager/recovery-manager.png

