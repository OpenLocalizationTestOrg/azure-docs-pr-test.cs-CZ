---
title: "Klientská knihovna pro aaaUsing elastické databáze s platformou Entity Framework | Microsoft Docs"
description: "Pomocí klientské knihovny pro elastické databáze a Entity Framework pro kódování databází"
services: sql-database
documentationcenter: 
manager: jhubbard
author: torsteng
editor: 
ms.assetid: b9c3065b-cb92-41be-aa7f-deba23e7e159
ms.service: sql-database
ms.custom: scale out apps
ms.workload: sql-database
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 03/06/2017
ms.author: torsteng
ms.openlocfilehash: 917f6d28d9855c0b42afe2c008613a9bbb3ec6b6
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 10/06/2017
---
# <a name="elastic-database-client-library-with-entity-framework"></a><span data-ttu-id="efba3-103">Klientská knihovna pro elastické databáze s platformou Entity Framework</span><span class="sxs-lookup"><span data-stu-id="efba3-103">Elastic Database client library with Entity Framework</span></span>
<span data-ttu-id="efba3-104">Tento dokument ukazuje hello změny v aplikaci rozhraní Entity Framework, které jsou potřebné toointegrate s hello [nástroje elastické databáze](sql-database-elastic-scale-introduction.md).</span><span class="sxs-lookup"><span data-stu-id="efba3-104">This document shows hello changes in an Entity Framework application that are needed toointegrate with hello [Elastic Database tools](sql-database-elastic-scale-introduction.md).</span></span> <span data-ttu-id="efba3-105">Hello zaměřuje se na skládání [horizontálního oddílu mapy správu](sql-database-elastic-scale-shard-map-management.md) a [závislé na data směrování](sql-database-elastic-scale-data-dependent-routing.md) s hello Entity Framework **Code First** přístup.</span><span class="sxs-lookup"><span data-stu-id="efba3-105">hello focus is on composing [shard map management](sql-database-elastic-scale-shard-map-management.md) and [data-dependent routing](sql-database-elastic-scale-data-dependent-routing.md) with hello Entity Framework **Code First** approach.</span></span> <span data-ttu-id="efba3-106">Hello [Code nejprve - novou databázi](http://msdn.microsoft.com/data/jj193542.aspx) kurz pro EF slouží jako našem příkladu spuštěné v tomto dokumentu.</span><span class="sxs-lookup"><span data-stu-id="efba3-106">hello [Code First - New Database](http://msdn.microsoft.com/data/jj193542.aspx) tutorial for EF serves as our running example throughout this document.</span></span> <span data-ttu-id="efba3-107">Ukázkový kód Hello doplňujícími tento dokument je součástí nástroje elastické databáze sada ukázky v hello Visual Studio – ukázky kódu.</span><span class="sxs-lookup"><span data-stu-id="efba3-107">hello sample code accompanying this document is part of elastic database tools' set of samples in hello Visual Studio Code Samples.</span></span>

## <a name="downloading-and-running-hello-sample-code"></a><span data-ttu-id="efba3-108">Stažení a spuštění hello ukázkový kód</span><span class="sxs-lookup"><span data-stu-id="efba3-108">Downloading and Running hello Sample Code</span></span>
<span data-ttu-id="efba3-109">toodownload hello kód v tomto článku:</span><span class="sxs-lookup"><span data-stu-id="efba3-109">toodownload hello code for this article:</span></span>

* <span data-ttu-id="efba3-110">Visual Studio 2012 nebo novější je povinný.</span><span class="sxs-lookup"><span data-stu-id="efba3-110">Visual Studio 2012 or later is required.</span></span> 
* <span data-ttu-id="efba3-111">Stáhnout hello [elastické databáze nástroje pro Azure SQL – ukázka integrace Entity Framework](https://code.msdn.microsoft.com/windowsapps/Elastic-Scale-with-Azure-bae904ba) z webu MSDN.</span><span class="sxs-lookup"><span data-stu-id="efba3-111">Download hello [Elastic DB Tools for Azure SQL - Entity Framework Integration sample](https://code.msdn.microsoft.com/windowsapps/Elastic-Scale-with-Azure-bae904ba) from MSDN.</span></span> <span data-ttu-id="efba3-112">Rozbalte hello ukázka tooa umístění dle vlastního výběru.</span><span class="sxs-lookup"><span data-stu-id="efba3-112">Unzip hello sample tooa location of your choosing.</span></span>
* <span data-ttu-id="efba3-113">Spusťte Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="efba3-113">Start Visual Studio.</span></span> 
* <span data-ttu-id="efba3-114">V sadě Visual Studio vyberte soubor -> Otevřít projekt nebo řešení.</span><span class="sxs-lookup"><span data-stu-id="efba3-114">In Visual Studio, select File -> Open Project/Solution.</span></span> 
* <span data-ttu-id="efba3-115">V hello **otevřeného projektu** dialogové okno, přejděte toohello ukázka jste stáhli a vyberte **EntityFrameworkCodeFirst.sln** tooopen hello ukázka.</span><span class="sxs-lookup"><span data-stu-id="efba3-115">In hello **Open Project** dialog, navigate toohello sample you downloaded and select **EntityFrameworkCodeFirst.sln** tooopen hello sample.</span></span> 

<span data-ttu-id="efba3-116">Ukázka hello toorun, je třeba toocreate tři prázdné databáze ve službě Azure SQL Database:</span><span class="sxs-lookup"><span data-stu-id="efba3-116">toorun hello sample, you need toocreate three empty databases in Azure SQL Database:</span></span>

* <span data-ttu-id="efba3-117">Horizontálního oddílu mapa správce databáze</span><span class="sxs-lookup"><span data-stu-id="efba3-117">Shard Map Manager database</span></span>
* <span data-ttu-id="efba3-118">Databáze horizontálního oddílu 1</span><span class="sxs-lookup"><span data-stu-id="efba3-118">Shard 1 database</span></span>
* <span data-ttu-id="efba3-119">Databáze horizontálního oddílu 2</span><span class="sxs-lookup"><span data-stu-id="efba3-119">Shard 2 database</span></span>

<span data-ttu-id="efba3-120">Po vytvoření těchto databází, vyplňte hello zástupného v **Program.cs** se název serveru Azure SQL DB, hello názvy databáze a databáze toohello tooconnect přihlašovací údaje.</span><span class="sxs-lookup"><span data-stu-id="efba3-120">Once you have created these databases, fill in hello place holders in **Program.cs** with your Azure SQL DB server name, hello database names and your credentials tooconnect toohello databases.</span></span> <span data-ttu-id="efba3-121">Vytvoření hello řešení v sadě Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="efba3-121">Build hello solution in Visual Studio.</span></span> <span data-ttu-id="efba3-122">Visual Studio stáhne hello požadované balíčky NuGet pro klientské knihovny pro elastické databáze hello Entity Framework a přechodná chyba zpracování jako součást procesu sestavení hello.</span><span class="sxs-lookup"><span data-stu-id="efba3-122">Visual Studio will download hello required NuGet packages for hello elastic database client library, Entity Framework, and Transient Fault handling as part of hello build process.</span></span> <span data-ttu-id="efba3-123">Ujistěte se, že probíhá obnovení balíčků NuGet je povolena pro vaše řešení.</span><span class="sxs-lookup"><span data-stu-id="efba3-123">Make sure that restoring NuGet packages is enabled for your solution.</span></span> <span data-ttu-id="efba3-124">Toto nastavení můžete povolit kliknutím pravým tlačítkem na soubor řešení hello v hello Průzkumníka řešení Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="efba3-124">You can enable this setting by right-clicking on hello solution file in hello Visual Studio Solution Explorer.</span></span> 

## <a name="entity-framework-workflows"></a><span data-ttu-id="efba3-125">Pracovní postupy Entity Framework</span><span class="sxs-lookup"><span data-stu-id="efba3-125">Entity Framework workflows</span></span>
<span data-ttu-id="efba3-126">Vývojáři Entity Framework spoléhají na jednom z hello následující čtyři pracovních toobuild aplikace a trvalost tooensure pro objekty aplikací:</span><span class="sxs-lookup"><span data-stu-id="efba3-126">Entity Framework developers rely on one of hello following four workflows toobuild applications and tooensure persistence for application objects:</span></span> 

* <span data-ttu-id="efba3-127">**Code First (nová databáze)**: hello EF vývojáře vytvoří v kódu aplikace hello hello model a pak EF generuje hello databáze z něj.</span><span class="sxs-lookup"><span data-stu-id="efba3-127">**Code First (New Database)**: hello EF developer creates hello model in hello application code and then EF generates hello database from it.</span></span> 
* <span data-ttu-id="efba3-128">**Code First (existující databáze)**: hello vývojáře umožňuje EF generování kódu aplikace hello hello modelu z existující databáze.</span><span class="sxs-lookup"><span data-stu-id="efba3-128">**Code First (Existing Database)**: hello developer lets EF generate hello application code for hello model from an existing database.</span></span>
* <span data-ttu-id="efba3-129">**Model první**: hello vývojáře vytvoří hello model v EF designeru hello a pak EF vytvoří hello databázi z modelu hello.</span><span class="sxs-lookup"><span data-stu-id="efba3-129">**Model First**: hello developer creates hello model in hello EF designer and then EF creates hello database from hello model.</span></span>
* <span data-ttu-id="efba3-130">**Databáze první**: hello developer používá EF tooling tooinfer hello modelu z existující databáze.</span><span class="sxs-lookup"><span data-stu-id="efba3-130">**Database First**: hello developer uses EF tooling tooinfer hello model from an existing database.</span></span> 

<span data-ttu-id="efba3-131">Spravovat všechny tyto přístupy spoléhají na tootransparently třídy DbContext hello připojení k databázi a schéma databáze pro aplikaci.</span><span class="sxs-lookup"><span data-stu-id="efba3-131">All these approaches rely on hello DbContext class tootransparently manage database connections and database schema for an application.</span></span> <span data-ttu-id="efba3-132">Jak se budeme zabývat podrobněji později v dokumentu hello jiné konstruktory na základní třídy DbContext hello povolit pro různé úrovně kontroly nad vytváření připojení, databáze vytváření zavádění a schéma.</span><span class="sxs-lookup"><span data-stu-id="efba3-132">As we will discuss in more detail later in hello document, different constructors on hello DbContext base class allow for different levels of control over connection creation, database bootstrapping and schema creation.</span></span> <span data-ttu-id="efba3-133">Problémy jsou vyvolány především hello skutečnost, že správa připojení databáze hello poskytovaná v rámci EF protíná s hello data závislé směrování rozhraní poskytuje možnosti správy připojení hello pomocí klientské knihovny pro elastické databáze hello.</span><span class="sxs-lookup"><span data-stu-id="efba3-133">Challenges arise primarily from hello fact that hello database connection management provided by EF intersects with hello connection management capabilities of hello data dependent routing interfaces provided by hello elastic database client library.</span></span> 

## <a name="elastic-database-tools-assumptions"></a><span data-ttu-id="efba3-134">Předpoklady nástroje elastické databáze</span><span class="sxs-lookup"><span data-stu-id="efba3-134">Elastic database tools assumptions</span></span>
<span data-ttu-id="efba3-135">Definice podmínek, najdete v části [Glosář nástroje elastické databáze](sql-database-elastic-scale-glossary.md).</span><span class="sxs-lookup"><span data-stu-id="efba3-135">For term definitions, see [Elastic Database tools glossary](sql-database-elastic-scale-glossary.md).</span></span>

<span data-ttu-id="efba3-136">Klientská knihovna pro elastické databáze definovat oddíly názvem shardlets data aplikací.</span><span class="sxs-lookup"><span data-stu-id="efba3-136">With elastic database client library, you define partitions of your application data called shardlets.</span></span> <span data-ttu-id="efba3-137">Shardlets jsou identifikovány klíč horizontálního dělení a jsou namapované toospecific databáze.</span><span class="sxs-lookup"><span data-stu-id="efba3-137">Shardlets are identified by a sharding key and are mapped toospecific databases.</span></span> <span data-ttu-id="efba3-138">Aplikace může mít libovolný počet databází, podle potřeby a distribuci hello shardlets tooprovide dost kapacity nebo výkonu zadána aktuální obchodní požadavky.</span><span class="sxs-lookup"><span data-stu-id="efba3-138">An application may have as many databases as needed and distribute hello shardlets tooprovide enough capacity or performance given current business requirements.</span></span> <span data-ttu-id="efba3-139">mapování Hello horizontálního dělení hodnoty klíče toohello databází ukládá horizontálního oddílu mapu poskytované hello elastické databáze klientských rozhraní API.</span><span class="sxs-lookup"><span data-stu-id="efba3-139">hello mapping of sharding key values toohello databases is stored by a shard map provided by hello elastic database client APIs.</span></span> <span data-ttu-id="efba3-140">Říkáme tato funkce **horizontálního oddílu mapy správu**, nebo pro zkrácení SMM.</span><span class="sxs-lookup"><span data-stu-id="efba3-140">We call this capability **Shard Map Management**, or SMM for short.</span></span> <span data-ttu-id="efba3-141">mapování horizontálních Hello slouží také jako hello zprostředkovatele připojení k databázi pro požadavky, které zajišťují klíč horizontálního dělení.</span><span class="sxs-lookup"><span data-stu-id="efba3-141">hello shard map also serves as hello broker of database connections for requests that carry a sharding key.</span></span> <span data-ttu-id="efba3-142">Označujeme toothis funkce jako **závislé na data směrování**.</span><span class="sxs-lookup"><span data-stu-id="efba3-142">We refer toothis capability as **data-dependent routing**.</span></span> 

<span data-ttu-id="efba3-143">správce mapy horizontálního oddílu Hello chrání uživatelé z nekonzistentní zobrazení do shardlet data, která může dojít, když se děje souběžných shardlet operace správy (například přemístění dat z jedné horizontálních tooanother).</span><span class="sxs-lookup"><span data-stu-id="efba3-143">hello shard map manager protects users from inconsistent views into shardlet data that can occur when concurrent shardlet management operations (such as relocating data from one shard tooanother) are happening.</span></span> <span data-ttu-id="efba3-144">toodo tedy hello horizontálního oddílu mapy spravuje hello knihovně zprostředkovatele hello databáze připojení klienta pro aplikaci.</span><span class="sxs-lookup"><span data-stu-id="efba3-144">toodo so, hello shard maps managed by hello client library broker hello database connections for an application.</span></span> <span data-ttu-id="efba3-145">To umožňuje hello horizontálního oddílu mapy funkce tooautomatically kill připojení k databázi při operacích správy horizontálního oddílu by mohlo mít vliv hello shardlet, který byl vytvořen hello připojení pro.</span><span class="sxs-lookup"><span data-stu-id="efba3-145">This allows hello shard map functionality tooautomatically kill a database connection when shard management operations could impact hello shardlet that hello connection has been created for.</span></span> <span data-ttu-id="efba3-146">Tento postup musí toointegrate s některými EF na funkce, jako je například vytváření nových připojení z existující jeden toocheck existence databáze.</span><span class="sxs-lookup"><span data-stu-id="efba3-146">This approach needs toointegrate with some of EF’s functionality, such as creating new connections from an existing one toocheck for database existence.</span></span> <span data-ttu-id="efba3-147">Obecně platí, naše pozorování bylo, že standardní konstruktory DbContext hello pouze fungovat spolehlivě pro připojení uzavřené databáze, které se dají bezpečně klonovat pro EF práci.</span><span class="sxs-lookup"><span data-stu-id="efba3-147">In general, our observation has been that hello standard DbContext constructors only work reliably for closed database connections that can safely be cloned for EF work.</span></span> <span data-ttu-id="efba3-148">Princip návrhu Hello elastické databáze místo toho je tooonly zprostředkovatele otevřít připojení.</span><span class="sxs-lookup"><span data-stu-id="efba3-148">hello design principle of elastic database instead is tooonly broker opened connections.</span></span> <span data-ttu-id="efba3-149">Může být jeden vezměte v úvahu uzavřením připojení zprostředkované pomocí klientské knihovny hello před blokováním přes toohello EF DbContext může vyřešit tento problém.</span><span class="sxs-lookup"><span data-stu-id="efba3-149">One might think that closing a connection brokered by hello client library before handing it over toohello EF DbContext may solve this issue.</span></span> <span data-ttu-id="efba3-150">Ale zavřením hello připojení a spoléhat na EF toore otevřete ho, jeden foregoes kontroly ověřování a konzistence hello provádí hello knihovně.</span><span class="sxs-lookup"><span data-stu-id="efba3-150">However, by closing hello connection and relying on EF toore-open it, one foregoes hello validation and consistency checks performed by hello library.</span></span> <span data-ttu-id="efba3-151">funkce migrace Hello v EF, ale používá tyto hello toomanage připojení základní schéma databáze tak, že je transparentní toohello aplikace.</span><span class="sxs-lookup"><span data-stu-id="efba3-151">hello migrations functionality in EF, however, uses these connections toomanage hello underlying database schema in a way that is transparent toohello application.</span></span> <span data-ttu-id="efba3-152">V ideálním případě by jsme jako tooretain a kombinace všechny tyto funkce z klientské knihovny pro elastické databáze hello i EF v hello stejná aplikace.</span><span class="sxs-lookup"><span data-stu-id="efba3-152">Ideally, we would like tooretain and combine all these capabilities from both hello elastic database client library and EF in hello same application.</span></span> <span data-ttu-id="efba3-153">Hello následující část popisuje tyto vlastnosti a požadavky podrobněji.</span><span class="sxs-lookup"><span data-stu-id="efba3-153">hello following section discusses these properties and requirements in more detail.</span></span> 

## <a name="requirements"></a><span data-ttu-id="efba3-154">Požadavky</span><span class="sxs-lookup"><span data-stu-id="efba3-154">Requirements</span></span>
<span data-ttu-id="efba3-155">Při práci s hello klientské knihovny pro elastické databáze a Entity Framework rozhraní API, chceme tooretain hello následující vlastnosti:</span><span class="sxs-lookup"><span data-stu-id="efba3-155">When working with both hello elastic database client library and Entity Framework APIs, we want tooretain hello following properties:</span></span> 

* <span data-ttu-id="efba3-156">**Škálováním na více systémů**: tooadd nebo odebrat databáze z hello datové vrstvy hello horizontálně dělené aplikace podle potřeby pro požadavky na kapacitu hello aplikace hello.</span><span class="sxs-lookup"><span data-stu-id="efba3-156">**Scale-out**: tooadd or remove databases from hello data tier of hello sharded application as necessary for hello capacity demands of hello application.</span></span> <span data-ttu-id="efba3-157">To znamená kontrolu nad hello hello vytváření a odstraňování databází a databází toomanage rozhraní API map hello elastické databáze horizontálního oddílu manager a mapování shardlets jeho použití.</span><span class="sxs-lookup"><span data-stu-id="efba3-157">This means control over hello hello creation and deletion of databases and using hello elastic database shard map manager APIs toomanage databases, and mappings of shardlets.</span></span> 
* <span data-ttu-id="efba3-158">**Konzistence**: aplikace hello používá horizontálního dělení a používá hello závislé směrování funkce dat Klientská knihovna pro hello.</span><span class="sxs-lookup"><span data-stu-id="efba3-158">**Consistency**: hello application employs sharding, and uses hello data dependent routing capabilities of hello client library.</span></span> <span data-ttu-id="efba3-159">tooavoid poškození nebo výsledky dotazu nesprávný připojení jsou zprostředkované přes správce mapy hello horizontálního oddílu.</span><span class="sxs-lookup"><span data-stu-id="efba3-159">tooavoid corruption or wrong query results, connections are brokered through hello shard map manager.</span></span> <span data-ttu-id="efba3-160">Zachová také ověření a konzistence.</span><span class="sxs-lookup"><span data-stu-id="efba3-160">This also retains validation and consistency.</span></span>
* <span data-ttu-id="efba3-161">**Code First**: tooretain hello pohodlím, které představuje první zlepší EF na kódu.</span><span class="sxs-lookup"><span data-stu-id="efba3-161">**Code First**: tooretain hello convenience of EF’s code first paradigm.</span></span> <span data-ttu-id="efba3-162">V Code First jsou třídy v aplikaci hello namapované transparentně toohello základní struktury databáze.</span><span class="sxs-lookup"><span data-stu-id="efba3-162">In Code First, classes in hello application are mapped transparently toohello underlying database structures.</span></span> <span data-ttu-id="efba3-163">kód aplikace Hello komunikuje s DbSets, který maskování většinu aspektů hello základní zpracování databáze.</span><span class="sxs-lookup"><span data-stu-id="efba3-163">hello application code interacts with DbSets that mask most aspects involved in hello underlying database processing.</span></span>
* <span data-ttu-id="efba3-164">**Schéma**: rozhraní Entity Framework zpracovává vytvoření schématu počáteční databáze a následné schématu vývoj pomocí migrace.</span><span class="sxs-lookup"><span data-stu-id="efba3-164">**Schema**: Entity Framework handles initial database schema creation and subsequent schema evolution through migrations.</span></span> <span data-ttu-id="efba3-165">Zachováním tyto funkce, je snadné jako hello zpracovaní dat přizpůsobení vaší aplikace.</span><span class="sxs-lookup"><span data-stu-id="efba3-165">By retaining these capabilities, adapting your app is easy as hello data evolves.</span></span> 

<span data-ttu-id="efba3-166">Hello pokynů dá pokyn, jak toosatisfy tyto požadavky pro Code First aplikací pomocí nástroje elastické databáze.</span><span class="sxs-lookup"><span data-stu-id="efba3-166">hello following guidance instructs how toosatisfy these requirements for Code First applications using elastic database tools.</span></span> 

## <a name="data-dependent-routing-using-ef-dbcontext"></a><span data-ttu-id="efba3-167">Data závislé směrování pomocí EF DbContext</span><span class="sxs-lookup"><span data-stu-id="efba3-167">Data dependent routing using EF DbContext</span></span>
<span data-ttu-id="efba3-168">Databázová připojení s platformou Entity Framework se obvykle spravují prostřednictvím měly podtřídy **DbContext**.</span><span class="sxs-lookup"><span data-stu-id="efba3-168">Database connections with Entity Framework are typically managed through subclasses of **DbContext**.</span></span> <span data-ttu-id="efba3-169">Vytvořit tyto podtřídy odvozené z **DbContext**.</span><span class="sxs-lookup"><span data-stu-id="efba3-169">Create these subclasses by deriving from **DbContext**.</span></span> <span data-ttu-id="efba3-170">Toto je, kde můžete definovat vaše **DbSets** které implementují hello databáze zálohována kolekce objektů CLR pro vaši aplikaci.</span><span class="sxs-lookup"><span data-stu-id="efba3-170">This is where you define your **DbSets** that implement hello database-backed collections of CLR objects for your application.</span></span> <span data-ttu-id="efba3-171">V kontextu hello data závislé směrování abychom mohli identifikovat několik užitečné vlastnosti, které nemají nutně další EF code první aplikaci scénáře:</span><span class="sxs-lookup"><span data-stu-id="efba3-171">In hello context of data dependent routing, we can identify several helpful properties that do not necessarily hold for other EF code first application scenarios:</span></span> 

* <span data-ttu-id="efba3-172">Hello databáze již existuje a je zaregistrován v mapě horizontálního oddílu hello elastické databáze.</span><span class="sxs-lookup"><span data-stu-id="efba3-172">hello database already exists and has been registered in hello elastic database shard map.</span></span> 
* <span data-ttu-id="efba3-173">schéma Hello hello aplikace je již nasazené toohello databáze (vysvětlení níže).</span><span class="sxs-lookup"><span data-stu-id="efba3-173">hello schema of hello application has already been deployed toohello database (explained below).</span></span> 
* <span data-ttu-id="efba3-174">Jsou závislé na data směrování připojení toohello databáze zprostředkované podle hello horizontálního oddílu mapy.</span><span class="sxs-lookup"><span data-stu-id="efba3-174">Data-dependent routing connections toohello database are brokered by hello shard map.</span></span> 

<span data-ttu-id="efba3-175">toointegrate **DbContexts** s závislé na data směrování pro Škálováním na více systémů:</span><span class="sxs-lookup"><span data-stu-id="efba3-175">toointegrate **DbContexts** with data-dependent routing for scale-out:</span></span>

1. <span data-ttu-id="efba3-176">Vytvořit fyzická databáze připojení prostřednictvím rozhraní klienta elastické databáze hello hello horizontálního oddílu mapa správce,</span><span class="sxs-lookup"><span data-stu-id="efba3-176">Create physical database connections through hello elastic database client interfaces of hello shard map manager,</span></span> 
2. <span data-ttu-id="efba3-177">Zabalení hello připojení s hello **DbContext** podtřídy</span><span class="sxs-lookup"><span data-stu-id="efba3-177">Wrap hello connection with hello **DbContext** subclass</span></span>
3. <span data-ttu-id="efba3-178">Předat připojení hello do hello **DbContext** základní třídy tooensure všechny hello zpracování na straně EF hello se také stane.</span><span class="sxs-lookup"><span data-stu-id="efba3-178">Pass hello connection down into hello **DbContext** base classes tooensure all hello processing on hello EF side happens as well.</span></span> 

<span data-ttu-id="efba3-179">Hello následující příklad kódu ukazuje tento přístup.</span><span class="sxs-lookup"><span data-stu-id="efba3-179">hello following code example illustrates this approach.</span></span> <span data-ttu-id="efba3-180">(Tento kód se taky v hello doplňujícími projektu sady Visual Studio)</span><span class="sxs-lookup"><span data-stu-id="efba3-180">(This code is also in hello accompanying Visual Studio project)</span></span>

    public class ElasticScaleContext<T> : DbContext
    {
    public DbSet<Blog> Blogs { get; set; }
    …

        // C'tor for data dependent routing. This call will open a validated connection 
        // routed toohello proper shard by hello shard map manager. 
        // Note that hello base class c'tor call will fail for an open connection
        // if migrations need toobe done and SQL credentials are used. This is hello reason for hello 
        // separation of c'tors into hello data-dependent routing case (this c'tor) and hello internal c'tor for new shards.
        public ElasticScaleContext(ShardMap shardMap, T shardingKey, string connectionStr)
            : base(CreateDDRConnection(shardMap, shardingKey, connectionStr), 
            true /* contextOwnsConnection */)
        {
        }

        // Only static methods are allowed in calls into base class c'tors.
        private static DbConnection CreateDDRConnection(
        ShardMap shardMap, 
        T shardingKey, 
        string connectionStr)
        {
            // No initialization
            Database.SetInitializer<ElasticScaleContext<T>>(null);

            // Ask shard map toobroker a validated connection for hello given key
            SqlConnection conn = shardMap.OpenConnectionForKey<T>
                                (shardingKey, connectionStr, ConnectionOptions.Validate);
            return conn;
        }    

## <a name="main-points"></a><span data-ttu-id="efba3-181">Hlavní body</span><span class="sxs-lookup"><span data-stu-id="efba3-181">Main points</span></span>
* <span data-ttu-id="efba3-182">Nový konstruktor nahrazuje hello výchozí konstruktor v podtřídami DbContext hello</span><span class="sxs-lookup"><span data-stu-id="efba3-182">A new constructor replaces hello default constructor in hello DbContext subclass</span></span> 
* <span data-ttu-id="efba3-183">new – konstruktor Hello trvá hello argumenty, které jsou požadovány pro závislé směrování dat přes klientské knihovny pro elastické databáze:</span><span class="sxs-lookup"><span data-stu-id="efba3-183">hello new constructor takes hello arguments that are required for data dependent routing through elastic database client library:</span></span>
  
  * <span data-ttu-id="efba3-184">Hello horizontálního oddílu mapy tooaccess hello rozhraní směrování závislé na data</span><span class="sxs-lookup"><span data-stu-id="efba3-184">hello shard map tooaccess hello data-dependent routing interfaces,</span></span>
  * <span data-ttu-id="efba3-185">Hello horizontálního dělení klíče tooidentify hello shardlet,</span><span class="sxs-lookup"><span data-stu-id="efba3-185">hello sharding key tooidentify hello shardlet,</span></span>
  * <span data-ttu-id="efba3-186">připojovací řetězec s hello přihlašovací údaje pro hello závislé na data směrování připojení toohello horizontálních.</span><span class="sxs-lookup"><span data-stu-id="efba3-186">a connection string with hello credentials for hello data-dependent routing connection toohello shard.</span></span> 
* <span data-ttu-id="efba3-187">konstruktor základní třídy toohello volání Hello bere detour v statickou metodu, která provádí všechny kroky hello potřebné pro směrování závislé na data.</span><span class="sxs-lookup"><span data-stu-id="efba3-187">hello call toohello base class constructor takes a detour into a static method that performs all hello steps necessary for data-dependent routing.</span></span> 
  
  * <span data-ttu-id="efba3-188">Hello OpenConnectionForKey volání rozhraní klienta elastické databáze hello používá na hello horizontálního oddílu mapy tooestablish otevřené připojení.</span><span class="sxs-lookup"><span data-stu-id="efba3-188">It uses hello OpenConnectionForKey call of hello elastic database client interfaces on hello shard map tooestablish an open connection.</span></span>
  * <span data-ttu-id="efba3-189">mapování horizontálních Hello vytvoří horizontálního hello otevřené připojení toohello oddílu, který obsahuje hello shardlet pro zadaný klíč horizontálního dělení hello.</span><span class="sxs-lookup"><span data-stu-id="efba3-189">hello shard map creates hello open connection toohello shard that holds hello shardlet for hello given sharding key.</span></span>
  * <span data-ttu-id="efba3-190">Toto otevřené připojení je předán zpět toohello základní třída konstruktoru DbContext tooindicate, aby toto připojení není toobe používané EF místo EF automaticky vytvořit nové připojení.</span><span class="sxs-lookup"><span data-stu-id="efba3-190">This open connection is passed back toohello base class constructor of DbContext tooindicate that this connection is toobe used by EF instead of letting EF create a new connection automatically.</span></span> <span data-ttu-id="efba3-191">Toto připojení hello způsob, jak má byla označené klientem elastické databáze hello rozhraní API, tak, aby ho může zaručit konzistenci v rámci operace správy mapy horizontálního oddílu.</span><span class="sxs-lookup"><span data-stu-id="efba3-191">This way hello connection has been tagged by hello elastic database client API so that it can guarantee consistency under shard map management operations.</span></span>

<span data-ttu-id="efba3-192">Použijte konstruktor nové hello podtřídy DbContext místo hello výchozí konstruktor v kódu.</span><span class="sxs-lookup"><span data-stu-id="efba3-192">Use hello new constructor for your DbContext subclass instead of hello default constructor in your code.</span></span> <span data-ttu-id="efba3-193">Zde naleznete příklad:</span><span class="sxs-lookup"><span data-stu-id="efba3-193">Here is an example:</span></span> 

    // Create and save a new blog.

    Console.Write("Enter a name for a new blog: "); 
    var name = Console.ReadLine(); 

    using (var db = new ElasticScaleContext<int>( 
                            sharding.ShardMap,  
                            tenantId1,  
                            connStrBldr.ConnectionString)) 
    { 
        var blog = new Blog { Name = name }; 
        db.Blogs.Add(blog); 
        db.SaveChanges(); 

        // Display all Blogs for tenant 1 
        var query = from b in db.Blogs 
                    orderby b.Name 
                    select b; 
     … 
    }

<span data-ttu-id="efba3-194">new – konstruktor Hello otevře hello horizontálních toohello připojení, která obsahuje data hello pro hello shardlet identifikovaný hello hodnotu **tenantid1**.</span><span class="sxs-lookup"><span data-stu-id="efba3-194">hello new constructor opens hello connection toohello shard that holds hello data for hello shardlet identified by hello value of **tenantid1**.</span></span> <span data-ttu-id="efba3-195">Hello kód v hello **pomocí** bloku zůstává beze změny tooaccess hello **DbSet** pro blogy pomocí EF na hello horizontálního oddílu pro **tenantid1**.</span><span class="sxs-lookup"><span data-stu-id="efba3-195">hello code in hello **using** block stays unchanged tooaccess hello **DbSet** for blogs using EF on hello shard for **tenantid1**.</span></span> <span data-ttu-id="efba3-196">Tato operace změní sémantiku pro hello kód v hello použití bloku tak, že všechny databázové operace jsou nyní obor jeden horizontálního oddílu toohello kde **tenantid1** je uložen.</span><span class="sxs-lookup"><span data-stu-id="efba3-196">This changes semantics for hello code in hello using block such that all database operations are now scoped toohello one shard where **tenantid1** is kept.</span></span> <span data-ttu-id="efba3-197">Například dotaz LINQ přes hello blogy **DbSet** by vrátit pouze uložené na aktuální horizontálního oddílu hello blogy, ale není hello těch, které jsou uložené na jiné horizontálních oddílů.</span><span class="sxs-lookup"><span data-stu-id="efba3-197">For instance, a LINQ query over hello blogs **DbSet** would only return blogs stored on hello current shard, but not hello ones stored on other shards.</span></span>  

#### <a name="transient-faults-handling"></a><span data-ttu-id="efba3-198">Zpracování přechodné chyby</span><span class="sxs-lookup"><span data-stu-id="efba3-198">Transient faults handling</span></span>
<span data-ttu-id="efba3-199">Hello postupy společnosti Microsoft Patterns team publikované hello [hello přechodné chyby zpracování bloku aplikace](https://msdn.microsoft.com/library/dn440719.aspx).</span><span class="sxs-lookup"><span data-stu-id="efba3-199">hello Microsoft Patterns & Practices team published hello [hello Transient Fault Handling Application Block](https://msdn.microsoft.com/library/dn440719.aspx).</span></span> <span data-ttu-id="efba3-200">Hello knihovně se používá v kombinaci s EF Klientská knihovna pro elastické škálování.</span><span class="sxs-lookup"><span data-stu-id="efba3-200">hello library is used with elastic scale client library in combination with EF.</span></span> <span data-ttu-id="efba3-201">Však zajistěte, že všechny přechodný výjimka vrátí tooa místě, kde jsme můžete zajistit, že tento nový konstruktor hello je používána po přechodná chyba tak, aby všechny nové připojení pokus se uskuteční pomocí hello konstruktory, které jsme mít tweaked.</span><span class="sxs-lookup"><span data-stu-id="efba3-201">However, ensure that any transient exception returns tooa place where we can ensure that hello new constructor is being used after a transient fault so that any new connection attempt is made using hello constructors we have tweaked.</span></span> <span data-ttu-id="efba3-202">Správné není zaručena horizontálního oddílu, a neexistují žádné záruky hello připojení připojení toohello, jinak hodnota zachovaný jako změny dojít toohello horizontálního oddílu mapy.</span><span class="sxs-lookup"><span data-stu-id="efba3-202">Otherwise, a connection toohello correct shard is not guaranteed, and there are no assurances hello connection is maintained as changes toohello shard map occur.</span></span> 

<span data-ttu-id="efba3-203">Hello následující příklad kódu ukazuje, jak zásady opakování SQL lze použít kolem hello nové **DbContext** podtřídami konstruktory:</span><span class="sxs-lookup"><span data-stu-id="efba3-203">hello following code sample illustrates how a SQL retry policy can be used around hello new **DbContext** subclass constructors:</span></span> 

    SqlDatabaseUtils.SqlRetryPolicy.ExecuteAction(() => 
    { 
        using (var db = new ElasticScaleContext<int>( 
                                sharding.ShardMap,  
                                tenantId1,  
                                connStrBldr.ConnectionString)) 
            { 
                    var blog = new Blog { Name = name }; 
                    db.Blogs.Add(blog); 
                    db.SaveChanges(); 
            … 
            } 
        }); 

<span data-ttu-id="efba3-204">**SqlDatabaseUtils.SqlRetryPolicy** v hello výše uvedený kód je definovaný jako **SqlDatabaseTransientErrorDetectionStrategy** s počtem opakování 10 a 5 sekund čekací dobu mezi opakovanými pokusy.</span><span class="sxs-lookup"><span data-stu-id="efba3-204">**SqlDatabaseUtils.SqlRetryPolicy** in hello code above is defined as a **SqlDatabaseTransientErrorDetectionStrategy** with a retry count of 10, and 5 seconds wait time between retries.</span></span> <span data-ttu-id="efba3-205">Tento přístup je podobné toohello pokyny pro EF a uživatel spustil transakce (viz [omezení s opakováním strategie provádění (EF6 a vyšší)](http://msdn.microsoft.com/data/dn307226).</span><span class="sxs-lookup"><span data-stu-id="efba3-205">This approach is similar toohello guidance for EF and user-initiated transactions (see [Limitations with Retrying Execution Strategies (EF6 onwards)](http://msdn.microsoft.com/data/dn307226).</span></span> <span data-ttu-id="efba3-206">Obě situace vyžadují tohoto programu hello aplikace řídí hello oboru toowhich hello přechodný výjimka vrátí: tooeither znovu otevřete hello transakce, nebo (jak je znázorněno) vytvořte znovu hello kontext z hello správné konstruktor, používá hello elastické databáze Klientská knihovna.</span><span class="sxs-lookup"><span data-stu-id="efba3-206">Both situations require that hello application program controls hello scope toowhich hello transient exception returns: tooeither reopen hello transaction, or (as shown) recreate hello context from hello proper constructor that uses hello elastic database client library.</span></span>

<span data-ttu-id="efba3-207">Hello toocontrol třeba kde přechodné výjimky trvat nám zpět v oboru také vylučuje hello použití předdefinované hello **SqlAzureExecutionStrategy** dodávaný s EF.</span><span class="sxs-lookup"><span data-stu-id="efba3-207">hello need toocontrol where transient exceptions take us back in scope also precludes hello use of hello built-in **SqlAzureExecutionStrategy** that comes with EF.</span></span> <span data-ttu-id="efba3-208">**SqlAzureExecutionStrategy** by znovu otevřít připojení, ale nechcete použít **OpenConnectionForKey** a proto všechny hello ověření, které se provádí v rámci hello obejít **OpenConnectionForKey** volání.</span><span class="sxs-lookup"><span data-stu-id="efba3-208">**SqlAzureExecutionStrategy** would reopen a connection but not use **OpenConnectionForKey** and therefore bypass all hello validation that is performed as part of hello **OpenConnectionForKey** call.</span></span> <span data-ttu-id="efba3-209">Místo toho ukázka kódu hello používá integrované hello **DefaultExecutionStrategy** také dodávaný s EF.</span><span class="sxs-lookup"><span data-stu-id="efba3-209">Instead, hello code sample uses hello built-in **DefaultExecutionStrategy** that also comes with EF.</span></span> <span data-ttu-id="efba3-210">Na rozdíl od svazků příliš**SqlAzureExecutionStrategy**, funguje správně v kombinaci s hello zásady opakování z přechodných chyb.</span><span class="sxs-lookup"><span data-stu-id="efba3-210">As opposed too**SqlAzureExecutionStrategy**, it works correctly in combination with hello retry policy from Transient Fault Handling.</span></span> <span data-ttu-id="efba3-211">Zásady spouštění Hello je nastavena v hello **ElasticScaleDbConfiguration** třídy.</span><span class="sxs-lookup"><span data-stu-id="efba3-211">hello execution policy is set in hello **ElasticScaleDbConfiguration** class.</span></span> <span data-ttu-id="efba3-212">Všimněte si, že jsme se rozhodli není toouse **DefaultSqlExecutionStrategy** vzhledem k tomu, že ho navrhuje toouse **SqlAzureExecutionStrategy** Pokud dojde k přechodné výjimky - který vede toowrong chování, jak je popsáno.</span><span class="sxs-lookup"><span data-stu-id="efba3-212">Note that we decided not toouse **DefaultSqlExecutionStrategy** since it suggests toouse **SqlAzureExecutionStrategy** if transient exceptions occur - which would lead toowrong behavior as discussed.</span></span> <span data-ttu-id="efba3-213">Další informace o různých opakování zásady hello a EF najdete v tématu [odolnost připojení v EF](http://msdn.microsoft.com/data/dn456835.aspx).</span><span class="sxs-lookup"><span data-stu-id="efba3-213">For more information on hello different retry policies and EF, see [Connection Resiliency in EF](http://msdn.microsoft.com/data/dn456835.aspx).</span></span>     

#### <a name="constructor-rewrites"></a><span data-ttu-id="efba3-214">Konstruktor přepisů</span><span class="sxs-lookup"><span data-stu-id="efba3-214">Constructor rewrites</span></span>
<span data-ttu-id="efba3-215">Hello výše uvedené příklady kódu ilustrují hello výchozí konstruktor znovu zapíše potřebné pro vaši aplikaci v pořadí toouse datech závislé směrování s hello Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="efba3-215">hello code examples above illustrate hello default constructor re-writes required for your application in order toouse  data dependent routing with hello Entity Framework.</span></span> <span data-ttu-id="efba3-216">Následující tabulka Hello umožňuje zobecnit konstruktory tooother tento přístup.</span><span class="sxs-lookup"><span data-stu-id="efba3-216">hello following table generalizes this approach tooother constructors.</span></span> 

| <span data-ttu-id="efba3-217">Aktuální – konstruktor</span><span class="sxs-lookup"><span data-stu-id="efba3-217">Current Constructor</span></span> | <span data-ttu-id="efba3-218">Přepsaná konstruktor pro data</span><span class="sxs-lookup"><span data-stu-id="efba3-218">Rewritten Constructor for data</span></span> | <span data-ttu-id="efba3-219">Základní – konstruktor</span><span class="sxs-lookup"><span data-stu-id="efba3-219">Base Constructor</span></span> | <span data-ttu-id="efba3-220">Poznámky</span><span class="sxs-lookup"><span data-stu-id="efba3-220">Notes</span></span> |
| --- | --- | --- | --- |
| <span data-ttu-id="efba3-221">MyContext()</span><span class="sxs-lookup"><span data-stu-id="efba3-221">MyContext()</span></span> |<span data-ttu-id="efba3-222">ElasticScaleContext (ShardMap, TKey)</span><span class="sxs-lookup"><span data-stu-id="efba3-222">ElasticScaleContext(ShardMap, TKey)</span></span> |<span data-ttu-id="efba3-223">DbContext (DbConnection, bool)</span><span class="sxs-lookup"><span data-stu-id="efba3-223">DbContext(DbConnection, bool)</span></span> |<span data-ttu-id="efba3-224">Hello připojení musí toobe funkce hello horizontálního oddílu mapy a hello závislé na data směrování klíče.</span><span class="sxs-lookup"><span data-stu-id="efba3-224">hello connection needs toobe a function of hello shard map and hello data-dependent routing key.</span></span> <span data-ttu-id="efba3-225">Vytvoření automatického připojení k průchodu tooby správcem EF a místo toho pomocí hello horizontálního oddílu mapy toobroker hello připojení.</span><span class="sxs-lookup"><span data-stu-id="efba3-225">You need tooby-pass automatic connection creation by EF and instead use hello shard map toobroker hello connection.</span></span> |
| <span data-ttu-id="efba3-226">MyContext(string)</span><span class="sxs-lookup"><span data-stu-id="efba3-226">MyContext(string)</span></span> |<span data-ttu-id="efba3-227">ElasticScaleContext (ShardMap, TKey)</span><span class="sxs-lookup"><span data-stu-id="efba3-227">ElasticScaleContext(ShardMap, TKey)</span></span> |<span data-ttu-id="efba3-228">DbContext (DbConnection, bool)</span><span class="sxs-lookup"><span data-stu-id="efba3-228">DbContext(DbConnection, bool)</span></span> |<span data-ttu-id="efba3-229">připojení Hello je funkce hello horizontálního oddílu mapy a hello závislé na data směrování klíče.</span><span class="sxs-lookup"><span data-stu-id="efba3-229">hello connection is a function of hello shard map and hello data-dependent routing key.</span></span> <span data-ttu-id="efba3-230">Pevné databázové název nebo připojovací řetězec nebude fungovat jako jejich obejít ověřování pomocí mapování horizontálních hello.</span><span class="sxs-lookup"><span data-stu-id="efba3-230">A fixed database name or connection string will not work as they by-pass validation by hello shard map.</span></span> |
| <span data-ttu-id="efba3-231">MyContext(DbCompiledModel)</span><span class="sxs-lookup"><span data-stu-id="efba3-231">MyContext(DbCompiledModel)</span></span> |<span data-ttu-id="efba3-232">ElasticScaleContext (ShardMap TKey, DbCompiledModel)</span><span class="sxs-lookup"><span data-stu-id="efba3-232">ElasticScaleContext(ShardMap, TKey, DbCompiledModel)</span></span> |<span data-ttu-id="efba3-233">DbContext (DbConnection, DbCompiledModel, logická hodnota)</span><span class="sxs-lookup"><span data-stu-id="efba3-233">DbContext(DbConnection, DbCompiledModel, bool)</span></span> |<span data-ttu-id="efba3-234">Hello připojení budou vytvořeny pro zadaný klíč mapy a horizontálního dělení horizontálního oddílu s modelem hello poskytuje hello.</span><span class="sxs-lookup"><span data-stu-id="efba3-234">hello connection will get created for hello given shard map and sharding key with hello model provided.</span></span> <span data-ttu-id="efba3-235">kompilované modelu Hello se předají na základní c'tor toohello.</span><span class="sxs-lookup"><span data-stu-id="efba3-235">hello compiled model will be passed on toohello base c’tor.</span></span> |
| <span data-ttu-id="efba3-236">MyContext (DbConnection, bool)</span><span class="sxs-lookup"><span data-stu-id="efba3-236">MyContext(DbConnection, bool)</span></span> |<span data-ttu-id="efba3-237">ElasticScaleContext (ShardMap TKey, logická hodnota)</span><span class="sxs-lookup"><span data-stu-id="efba3-237">ElasticScaleContext(ShardMap, TKey, bool)</span></span> |<span data-ttu-id="efba3-238">DbContext (DbConnection, bool)</span><span class="sxs-lookup"><span data-stu-id="efba3-238">DbContext(DbConnection, bool)</span></span> |<span data-ttu-id="efba3-239">Hello připojení musí toobe odvodit z mapy hello horizontálního oddílu a klíč hello.</span><span class="sxs-lookup"><span data-stu-id="efba3-239">hello connection needs toobe inferred from hello shard map and hello key.</span></span> <span data-ttu-id="efba3-240">Jako vstup nemůže být zadaný (Pokud je tento vstup byl již pomocí mapy hello horizontálního oddílu a klíč hello).</span><span class="sxs-lookup"><span data-stu-id="efba3-240">It cannot be provided as an input (unless that input was already using hello shard map and hello key).</span></span> <span data-ttu-id="efba3-241">Hello logickou hodnotu, budou předány.</span><span class="sxs-lookup"><span data-stu-id="efba3-241">hello Boolean will be passed on.</span></span> |
| <span data-ttu-id="efba3-242">MyContext (string, DbCompiledModel)</span><span class="sxs-lookup"><span data-stu-id="efba3-242">MyContext(string, DbCompiledModel)</span></span> |<span data-ttu-id="efba3-243">ElasticScaleContext (ShardMap TKey, DbCompiledModel)</span><span class="sxs-lookup"><span data-stu-id="efba3-243">ElasticScaleContext(ShardMap, TKey, DbCompiledModel)</span></span> |<span data-ttu-id="efba3-244">DbContext (DbConnection, DbCompiledModel, logická hodnota)</span><span class="sxs-lookup"><span data-stu-id="efba3-244">DbContext(DbConnection, DbCompiledModel, bool)</span></span> |<span data-ttu-id="efba3-245">Hello připojení musí toobe odvodit z mapy hello horizontálního oddílu a klíč hello.</span><span class="sxs-lookup"><span data-stu-id="efba3-245">hello connection needs toobe inferred from hello shard map and hello key.</span></span> <span data-ttu-id="efba3-246">Jako vstup nemůže být zadaný (Pokud je tento vstup byl pomocí mapy hello horizontálního oddílu a klíč hello).</span><span class="sxs-lookup"><span data-stu-id="efba3-246">It cannot be provided as an input (unless that input was using hello shard map and hello key).</span></span> <span data-ttu-id="efba3-247">kompilované modelu Hello se předají.</span><span class="sxs-lookup"><span data-stu-id="efba3-247">hello compiled model will be passed on.</span></span> |
| <span data-ttu-id="efba3-248">MyContext (ObjectContext, bool)</span><span class="sxs-lookup"><span data-stu-id="efba3-248">MyContext(ObjectContext, bool)</span></span> |<span data-ttu-id="efba3-249">ElasticScaleContext (ShardMap, TKey, ObjectContext, bool)</span><span class="sxs-lookup"><span data-stu-id="efba3-249">ElasticScaleContext(ShardMap, TKey, ObjectContext, bool)</span></span> |<span data-ttu-id="efba3-250">DbContext (ObjectContext, bool)</span><span class="sxs-lookup"><span data-stu-id="efba3-250">DbContext(ObjectContext, bool)</span></span> |<span data-ttu-id="efba3-251">new – konstruktor Hello musí tooensure, který jakékoli připojení, v hello ObjectContext předán jako vstup je znovu směrované tooa připojení spravuje elastické škálování.</span><span class="sxs-lookup"><span data-stu-id="efba3-251">hello new constructor needs tooensure that any connection in hello ObjectContext passed as an input is re-routed tooa connection managed by Elastic Scale.</span></span> <span data-ttu-id="efba3-252">Podrobnou diskuzi o ObjectContexts je nad rámec tohoto dokumentu hello.</span><span class="sxs-lookup"><span data-stu-id="efba3-252">A detailed discussion of ObjectContexts is beyond hello scope of this document.</span></span> |
| <span data-ttu-id="efba3-253">MyContext (DbConnection, DbCompiledModel, logická hodnota)</span><span class="sxs-lookup"><span data-stu-id="efba3-253">MyContext(DbConnection, DbCompiledModel,bool)</span></span> |<span data-ttu-id="efba3-254">ElasticScaleContext (ShardMap, bool TKey, DbCompiledModel)</span><span class="sxs-lookup"><span data-stu-id="efba3-254">ElasticScaleContext(ShardMap, TKey, DbCompiledModel, bool)</span></span> |<span data-ttu-id="efba3-255">DbContext (DbConnection, DbCompiledModel, logická hodnota);</span><span class="sxs-lookup"><span data-stu-id="efba3-255">DbContext(DbConnection, DbCompiledModel, bool);</span></span> |<span data-ttu-id="efba3-256">Hello připojení musí toobe odvodit z mapy hello horizontálního oddílu a klíč hello.</span><span class="sxs-lookup"><span data-stu-id="efba3-256">hello connection needs toobe inferred from hello shard map and hello key.</span></span> <span data-ttu-id="efba3-257">Hello připojení nelze zadat jako vstup (Pokud je tento vstup byl již pomocí mapy hello horizontálního oddílu a klíč hello).</span><span class="sxs-lookup"><span data-stu-id="efba3-257">hello connection cannot be provided as an input (unless that input was already using hello shard map and hello key).</span></span> <span data-ttu-id="efba3-258">Model a logickou hodnotu jsou předány na toohello – základní třída – konstruktor.</span><span class="sxs-lookup"><span data-stu-id="efba3-258">Model and Boolean are passed on toohello base class constructor.</span></span> |

## <a name="shard-schema-deployment-through-ef-migrations"></a><span data-ttu-id="efba3-259">Nasazení schématu horizontálního oddílu pomocí EF migrace</span><span class="sxs-lookup"><span data-stu-id="efba3-259">Shard schema deployment through EF migrations</span></span>
<span data-ttu-id="efba3-260">Správa automatického schématu je pro vaše pohodlí poskytované hello Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="efba3-260">Automatic schema management is a convenience provided by hello Entity Framework.</span></span> <span data-ttu-id="efba3-261">V kontextu hello aplikací pomocí nástroje elastické databáze chceme tooretain této schopnosti tooautomatically zřídit hello schématu toonewly vytvořit horizontálních oddílů po přidání aplikace horizontálně dělené toohello databáze.</span><span class="sxs-lookup"><span data-stu-id="efba3-261">In hello context of applications using elastic database tools, we want tooretain this capability tooautomatically provision hello schema toonewly created shards when databases are added toohello sharded application.</span></span> <span data-ttu-id="efba3-262">případem primárního použití Hello je kapacita tooincrease na datové vrstvě hello pro horizontálně dělenou aplikací s využitím EF.</span><span class="sxs-lookup"><span data-stu-id="efba3-262">hello primary use case is tooincrease capacity at hello data tier for sharded applications using EF.</span></span> <span data-ttu-id="efba3-263">S horizontálně dělené aplikací postavené na EF spoléhat na EF na funkce pro správu schématu snižuje hello databáze správy úsilí.</span><span class="sxs-lookup"><span data-stu-id="efba3-263">Relying on EF’s capabilities for schema management reduces hello database administration effort with a sharded application built on EF.</span></span> 

<span data-ttu-id="efba3-264">Nasazení schématu pomocí migrace EF funguje nejlépe na **nebyla otevřena připojení**.</span><span class="sxs-lookup"><span data-stu-id="efba3-264">Schema deployment through EF migrations works best on **unopened connections**.</span></span> <span data-ttu-id="efba3-265">Toto je na rozdíl od scénář toohello pro data závislé směrování, které jsou závislé na hello otevřít připojení poskytované hello elastické databáze klientského rozhraní API.</span><span class="sxs-lookup"><span data-stu-id="efba3-265">This is in contrast toohello scenario for data dependent routing that relies on hello opened connection provided by hello elastic database client API.</span></span> <span data-ttu-id="efba3-266">Další rozdíl je požadavek konzistence hello: při žádoucí tooensure konzistence pro všechny závislé na data směrování připojení tooprotect proti manipulaci mapy souběžných horizontálního oddílu, se nejedná o problém s novou databází tooa počáteční schématu nasazení který má ještě není zaregistrována v mapě hello horizontálního oddílu a ještě není byl přidělen toohold shardlets.</span><span class="sxs-lookup"><span data-stu-id="efba3-266">Another difference is hello consistency requirement: While desirable tooensure consistency for all data-dependent routing connections tooprotect against concurrent shard map manipulation, it is not a concern with initial schema deployment tooa new database that has not yet been registered in hello shard map, and not yet been allocated toohold shardlets.</span></span> <span data-ttu-id="efba3-267">Jsme můžete proto spoléhají na standardní databázi připojení pro tento scénáře, jako názvem na rozdíl od směrování toodata závislé.</span><span class="sxs-lookup"><span data-stu-id="efba3-267">We can therefore rely on regular database connections for this scenarios, as opposed toodata-dependent routing.</span></span>  

<span data-ttu-id="efba3-268">To vede tooan přístup, kde nasazení schématu pomocí EF migrace je úzce spojeny s hello registrace nové databáze hello jako horizontálního oddílu v mapě horizontálního oddílu aplikace hello.</span><span class="sxs-lookup"><span data-stu-id="efba3-268">This leads tooan approach where schema deployment through EF migrations is tightly coupled with hello registration of hello new database as a shard in hello application’s shard map.</span></span> <span data-ttu-id="efba3-269">To závisí na hello následující požadavky:</span><span class="sxs-lookup"><span data-stu-id="efba3-269">This relies on hello following prerequisites:</span></span> 

* <span data-ttu-id="efba3-270">Hello databáze již existuje.</span><span class="sxs-lookup"><span data-stu-id="efba3-270">hello database has already been created.</span></span> 
* <span data-ttu-id="efba3-271">Hello databáze je prázdná – drží žádné schéma uživatele a žádná uživatelská data.</span><span class="sxs-lookup"><span data-stu-id="efba3-271">hello database is empty - it holds no user schema and no user data.</span></span>
* <span data-ttu-id="efba3-272">Hello databáze nelze ještě přistupovat prostřednictvím rozhraní API hello elastické databáze klienta pro směrování závislé na data.</span><span class="sxs-lookup"><span data-stu-id="efba3-272">hello database cannot yet be accessed through hello elastic database client APIs for data-dependent routing.</span></span> 

<span data-ttu-id="efba3-273">Tyto požadavky splněny, můžeme vytvořit běžný zrušení otevřenou **SqlConnection** tookick vypnout EF migrace pro nasazení schématu.</span><span class="sxs-lookup"><span data-stu-id="efba3-273">With these prerequisites in place, we can create a regular un-opened **SqlConnection** tookick off EF migrations for schema deployment.</span></span> <span data-ttu-id="efba3-274">Následující ukázka kódu Hello ukazuje tento přístup.</span><span class="sxs-lookup"><span data-stu-id="efba3-274">hello following code sample illustrates this approach.</span></span> 

        // Enter a new shard - i.e. an empty database - toohello shard map, allocate a first tenant tooit  
        // and kick off EF intialization of hello database toodeploy schema 

        public void RegisterNewShard(string server, string database, string connStr, int key) 
        { 

            Shard shard = this.ShardMap.CreateShard(new ShardLocation(server, database)); 

            SqlConnectionStringBuilder connStrBldr = new SqlConnectionStringBuilder(connStr); 
            connStrBldr.DataSource = server; 
            connStrBldr.InitialCatalog = database; 

            // Go into a DbContext tootrigger migrations and schema deployment for hello new shard. 
            // This requires an un-opened connection. 
            using (var db = new ElasticScaleContext<int>(connStrBldr.ConnectionString)) 
            { 
                // Run a query tooengage EF migrations 
                (from b in db.Blogs 
                    select b).Count(); 
            } 

            // Register hello mapping of hello tenant toohello shard in hello shard map. 
            // After this step, data-dependent routing on hello shard map can be used 

            this.ShardMap.CreatePointMapping(key, shard); 
        } 


<span data-ttu-id="efba3-275">Tento příklad ukazuje hello metoda **RegisterNewShard** , registry hello horizontálního oddílu v mapě hello horizontálního oddílu, nasadí hello schématu prostřednictvím EF migrace a ukládá mapování horizontálních klíče toohello horizontálního dělení.</span><span class="sxs-lookup"><span data-stu-id="efba3-275">This sample shows hello method **RegisterNewShard** that registers hello shard in hello shard map, deploys hello schema through EF migrations, and stores a mapping of a sharding key toohello shard.</span></span> <span data-ttu-id="efba3-276">Přitom spoléhá na konstruktoru hello **DbContext** podtřídami (**ElasticScaleContext** v ukázce hello), která má jako vstup připojovací řetězec SQL.</span><span class="sxs-lookup"><span data-stu-id="efba3-276">It relies on a constructor of hello **DbContext** subclass (**ElasticScaleContext** in hello sample) that takes a SQL connection string as input.</span></span> <span data-ttu-id="efba3-277">Kód Hello tento konstruktor je jednoduché, jako následující příklad ukazuje hello:</span><span class="sxs-lookup"><span data-stu-id="efba3-277">hello code of this constructor is straight-forward, as hello following example shows:</span></span> 

        // C'tor toodeploy schema and migrations tooa new shard 
        protected internal ElasticScaleContext(string connectionString) 
            : base(SetInitializerForConnection(connectionString)) 
        { 
        } 

        // Only static methods are allowed in calls into base class c'tors 
        private static string SetInitializerForConnection(string connnectionString) 
        { 
            // We want existence checks so that hello schema can get deployed 
            Database.SetInitializer<ElasticScaleContext<T>>( 
        new CreateDatabaseIfNotExists<ElasticScaleContext<T>>()); 

            return connnectionString; 
        } 

<span data-ttu-id="efba3-278">Jeden použili hello verzi hello konstruktor zděděn ze základní třídy hello.</span><span class="sxs-lookup"><span data-stu-id="efba3-278">One might have used hello version of hello constructor inherited from hello base class.</span></span> <span data-ttu-id="efba3-279">Ale hello tooensure potřebám kód, který hello výchozí inicializátoru pro EF se používá při připojování.</span><span class="sxs-lookup"><span data-stu-id="efba3-279">But hello code needs tooensure that hello default initializer for EF is used when connecting.</span></span> <span data-ttu-id="efba3-280">Proto hello krátké detour do hello statickou metodu před voláním do konstruktoru základní třídy hello s hello připojovací řetězec.</span><span class="sxs-lookup"><span data-stu-id="efba3-280">Hence hello short detour into hello static method before calling into hello base class constructor with hello connection string.</span></span> <span data-ttu-id="efba3-281">Všimněte si, že hello registrace horizontálních oddílů měly být spuštěny v jiné aplikace domény nebo proces tooensure které hello inicializátoru nastavení pro EF nejsou v konfliktu.</span><span class="sxs-lookup"><span data-stu-id="efba3-281">Note that hello registration of shards should run in a different app domain or process tooensure that hello initializer settings for EF do not conflict.</span></span> 

## <a name="limitations"></a><span data-ttu-id="efba3-282">Omezení</span><span class="sxs-lookup"><span data-stu-id="efba3-282">Limitations</span></span>
<span data-ttu-id="efba3-283">přístupy Hello uvedených v tomto dokumentu za následek několik omezení:</span><span class="sxs-lookup"><span data-stu-id="efba3-283">hello approaches outlined in this document entail a couple of limitations:</span></span> 

* <span data-ttu-id="efba3-284">EF aplikace, které používají **LocalDb** nejprve toomigrate tooa standardní databázi systému SQL Server před použitím klientské knihovny pro elastické databáze.</span><span class="sxs-lookup"><span data-stu-id="efba3-284">EF applications that use **LocalDb** first need toomigrate tooa regular SQL Server database before using elastic database client library.</span></span> <span data-ttu-id="efba3-285">Horizontální navýšení kapacity aplikace prostřednictvím horizontálního dělení s elastickým Škálováním není možné pomocí **LocalDb**.</span><span class="sxs-lookup"><span data-stu-id="efba3-285">Scaling out an application through sharding with Elastic Scale is not possible with **LocalDb**.</span></span> <span data-ttu-id="efba3-286">Všimněte si, že vývoj můžete nadále používat **LocalDb**.</span><span class="sxs-lookup"><span data-stu-id="efba3-286">Note that development can still use **LocalDb**.</span></span> 
* <span data-ttu-id="efba3-287">Jakékoli změny toohello aplikace, která implikují změny schématu databáze potřebovat toogo prostřednictvím EF migrace na všechny horizontálních oddílů.</span><span class="sxs-lookup"><span data-stu-id="efba3-287">Any changes toohello application that imply database schema changes need toogo through EF migrations on all shards.</span></span> <span data-ttu-id="efba3-288">Hello ukázkový kód pro tento dokument není ukazují, jak toodo to.</span><span class="sxs-lookup"><span data-stu-id="efba3-288">hello sample code for this document does not demonstrate how toodo this.</span></span> <span data-ttu-id="efba3-289">Zvažte použití Update-Database s ConnectionString parametr tooiterate přes všechny horizontálních oddílů; nebo extrakce hello T-SQL skriptu pro hello čeká na migraci pomocí Update-Database s hello - možnost skript a použijte hello T-SQL skriptu tooyour horizontálních oddílů.</span><span class="sxs-lookup"><span data-stu-id="efba3-289">Consider using Update-Database with a ConnectionString parameter tooiterate over all shards; or extract hello T-SQL script for hello pending migration using Update-Database with hello -Script option and apply hello T-SQL script tooyour shards.</span></span>  
* <span data-ttu-id="efba3-290">Zadaný požadavek, se předpokládá, že určeno klíčem horizontálního dělení hello poskytované hello žádost, všechny její zpracování databáze je obsažena v jedné horizontálního oddílu.</span><span class="sxs-lookup"><span data-stu-id="efba3-290">Given a request, it is assumed that all of its database processing is contained within a single shard as identified by hello sharding key provided by hello request.</span></span> <span data-ttu-id="efba3-291">Však tento předpoklad vždy nemá hodnotu true.</span><span class="sxs-lookup"><span data-stu-id="efba3-291">However, this assumption does not always hold true.</span></span> <span data-ttu-id="efba3-292">Například když není možné toomake horizontálního dělení klíč, který je k dispozici.</span><span class="sxs-lookup"><span data-stu-id="efba3-292">For example, when it is not possible toomake a sharding key available.</span></span> <span data-ttu-id="efba3-293">tooaddress se hello klientské knihovny poskytuje hello **MultiShardQuery** třídu, která implementuje abstraktní připojení pro dotazování přes několik horizontálních oddílů.</span><span class="sxs-lookup"><span data-stu-id="efba3-293">tooaddress this, hello client library provides hello **MultiShardQuery** class that implements a connection abstraction for querying over several shards.</span></span> <span data-ttu-id="efba3-294">Učení toouse hello **MultiShardQuery** v kombinaci s EF je nad rámec tohoto dokumentu hello</span><span class="sxs-lookup"><span data-stu-id="efba3-294">Learning toouse hello **MultiShardQuery** in combination with EF is beyond hello scope of this document</span></span>

## <a name="conclusion"></a><span data-ttu-id="efba3-295">Závěr</span><span class="sxs-lookup"><span data-stu-id="efba3-295">Conclusion</span></span>
<span data-ttu-id="efba3-296">EF aplikace může prostřednictvím hello kroků uvedených v tomto dokumentu, použít schopností hello elastické databáze klientské knihovny pro data závislé směrování podle refaktoring konstruktory hello **DbContext** podtřídy použít v hello EF aplikace.</span><span class="sxs-lookup"><span data-stu-id="efba3-296">Through hello steps outlined in this document, EF applications can use hello elastic database client library's capability for data dependent routing by refactoring constructors of hello **DbContext** subclasses used in hello EF application.</span></span> <span data-ttu-id="efba3-297">Toto omezení hello změny požadované toothose umístí kde **DbContext** třídy již existují.</span><span class="sxs-lookup"><span data-stu-id="efba3-297">This limits hello  changes required toothose places where **DbContext** classes already exist.</span></span> <span data-ttu-id="efba3-298">Kromě toho EF aplikace můžete pokračovat toobenefit z nasazení automatické schéma kombinací hello kroky, které vyvolání hello nezbytné EF migrace s registrací hello nové horizontálních oddílů a mapování v mapě hello horizontálního oddílu.</span><span class="sxs-lookup"><span data-stu-id="efba3-298">In addition, EF applications can continue toobenefit from automatic schema deployment by combining hello steps that invoke hello necessary EF migrations with hello registration of new shards and mappings in hello shard map.</span></span> 

[!INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

<!--Image references-->
[1]: ./media/sql-database-elastic-scale-use-entity-framework-applications-visual-studio/sample.png
