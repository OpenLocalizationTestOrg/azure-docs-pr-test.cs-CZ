---
title: "Azure Resource Manager a ověřování služby Active Directory | Microsoft Docs"
description: "Příručka pro vývojáře k ověřování pomocí rozhraní API Správce prostředků Azure a Azure Active Directory pro integraci aplikace s jiných předplatných Azure."
services: azure-resource-manager,active-directory
documentationcenter: na
author: dushyantgill
manager: timlt
editor: tysonn
ms.assetid: 17b2b40d-bf42-4c7d-9a88-9938409c5088
ms.service: azure-resource-manager
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: identity
ms.date: 12/27/2016
ms.author: dugill;tomfitz
ms.openlocfilehash: 7830dc4774652f4d108e98660dce3bcea7b32d05
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 07/11/2017
---
# <a name="use-resource-manager-authentication-api-to-access-subscriptions"></a><span data-ttu-id="ee7d4-103">Ověřování pomocí Správce prostředků rozhraní API pro odběry přístup</span><span class="sxs-lookup"><span data-stu-id="ee7d4-103">Use Resource Manager authentication API to access subscriptions</span></span>
## <a name="introduction"></a><span data-ttu-id="ee7d4-104">Úvod</span><span class="sxs-lookup"><span data-stu-id="ee7d4-104">Introduction</span></span>
<span data-ttu-id="ee7d4-105">Pokud jste vývojář softwaru, který potřebuje vytvořit aplikaci, která spravuje prostředky Azure zákazníka, toto téma ukazuje, jak k ověření prostřednictvím rozhraní API Správce prostředků Azure a získat přístup k prostředkům v jiných předplatných.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-105">If you are a software developer who needs to create an app that manages customer's Azure resources, this topic shows you how to authenticate with the Azure Resource Manager APIs and gain access to resources in other subscriptions.</span></span>

<span data-ttu-id="ee7d4-106">Aplikaci můžete získat přístup k rozhraní API Resource Manager v několika způsoby:</span><span class="sxs-lookup"><span data-stu-id="ee7d4-106">Your app can access the Resource Manager APIs in couple of ways:</span></span>

1. <span data-ttu-id="ee7d4-107">**Uživatel + přístup k aplikaci**: pro aplikace, která přistupují k prostředkům jménem přihlášeného uživatele.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-107">**User + app access**: for apps that access resources on behalf of a signed-in user.</span></span> <span data-ttu-id="ee7d4-108">Tento postup funguje pro aplikace, jako třeba webové aplikace a nástroje příkazového řádku, které pracují s pouze "interaktivní Správa" prostředků Azure.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-108">This approach works for apps, such as web apps and command-line tools, that deal with only "interactive management" of Azure resources.</span></span>
2. <span data-ttu-id="ee7d4-109">**Přístup jen aplikace**: pro aplikace, které běží démon služeb a naplánované úlohy.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-109">**App-only access**: for apps that run daemon services and scheduled jobs.</span></span> <span data-ttu-id="ee7d4-110">Identity aplikace jsou udělena přímý přístup k prostředkům.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-110">The app's identity is granted direct access to the resources.</span></span> <span data-ttu-id="ee7d4-111">Tento postup funguje pro aplikace, které potřebují dlouhodobé bezobslužných (bezobslužná instalace) přístup k Azure.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-111">This approach works for apps that need long-term headless (unattended) access to Azure.</span></span>

<span data-ttu-id="ee7d4-112">Toto téma obsahuje podrobné pokyny k vytvoření aplikace, která aktivuje obě tyto metody ověřování.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-112">This topic provides step-by-step instructions to create an app that employs both these authorization methods.</span></span> <span data-ttu-id="ee7d4-113">Ukazuje, jak provádět každý krok REST API nebo C#.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-113">It shows how to perform each step with REST API or C#.</span></span> <span data-ttu-id="ee7d4-114">Kompletní aplikace ASP.NET MVC je k dispozici na [https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense](https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense).</span><span class="sxs-lookup"><span data-stu-id="ee7d4-114">The complete ASP.NET MVC application is available at [https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense](https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense).</span></span>

## <a name="what-the-web-app-does"></a><span data-ttu-id="ee7d4-115">Jaké jsou webové aplikace</span><span class="sxs-lookup"><span data-stu-id="ee7d4-115">What the web app does</span></span>
<span data-ttu-id="ee7d4-116">Webové aplikace:</span><span class="sxs-lookup"><span data-stu-id="ee7d4-116">The web app:</span></span>

1. <span data-ttu-id="ee7d4-117">Přihlásí uživatele služby Azure.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-117">Signs-in an Azure user.</span></span>
2. <span data-ttu-id="ee7d4-118">Požádá uživatele a udělit přístup k webové aplikaci do Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-118">Asks user to grant the web app access to Resource Manager.</span></span>
3. <span data-ttu-id="ee7d4-119">Získá uživatele + přístupový token aplikace pro přístup k Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-119">Gets user + app access token for accessing Resource Manager.</span></span>
4. <span data-ttu-id="ee7d4-120">Volání Resource Manager a přiřadit role v odběru, který poskytuje přístup k dlouhodobé aplikaci k předplatnému instanční objekt aplikace používá token (z kroku 3).</span><span class="sxs-lookup"><span data-stu-id="ee7d4-120">Uses token (from step 3) to call Resource Manager and assign the app's service principal to a role in the subscription, which gives the app long-term access to the subscription.</span></span>
5. <span data-ttu-id="ee7d4-121">Získá jen aplikace přístupový token.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-121">Gets app-only access token.</span></span>
6. <span data-ttu-id="ee7d4-122">Token (z kroku 5) se používá ke správě prostředků v předplatném prostřednictvím Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-122">Uses token (from step 5) to manage resources in the subscription through Resource Manager.</span></span>

<span data-ttu-id="ee7d4-123">Zde je postup začátku do konce webové aplikace.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-123">Here's the end-to-end flow of the web application.</span></span>

![Tok ověření správce prostředků](./media/resource-manager-api-authentication/Auth-Swim-Lane.png)

<span data-ttu-id="ee7d4-125">Jako uživatel zadejte id odběru pro odběr, který chcete použít:</span><span class="sxs-lookup"><span data-stu-id="ee7d4-125">As a user, you provide the subscription id for the subscription you want to use:</span></span>

![Zadejte id předplatného](./media/resource-manager-api-authentication/sample-ux-1.png)

<span data-ttu-id="ee7d4-127">Vyberte účet, který chcete použít pro přihlášení.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-127">Select the account to use for logging in.</span></span>

![Vyberte účet](./media/resource-manager-api-authentication/sample-ux-2.png)

<span data-ttu-id="ee7d4-129">Zadejte svoje přihlašovací údaje.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-129">Provide your credentials.</span></span>

![Zadejte přihlašovací údaje](./media/resource-manager-api-authentication/sample-ux-3.png)

<span data-ttu-id="ee7d4-131">Aplikaci udělte přístup k vašemu předplatnému Azure:</span><span class="sxs-lookup"><span data-stu-id="ee7d4-131">Grant the app access to your Azure subscriptions:</span></span>

![Udělení přístupu](./media/resource-manager-api-authentication/sample-ux-4.png)

<span data-ttu-id="ee7d4-133">Správa odběrů připojené:</span><span class="sxs-lookup"><span data-stu-id="ee7d4-133">Manage your connected subscriptions:</span></span>

![Připojení odběru](./media/resource-manager-api-authentication/sample-ux-7.png)

## <a name="register-application"></a><span data-ttu-id="ee7d4-135">Registrace aplikace</span><span class="sxs-lookup"><span data-stu-id="ee7d4-135">Register application</span></span>
<span data-ttu-id="ee7d4-136">Než začnete, kódování, zaregistrujte vaší webové aplikace s Azure Active Directory (AD).</span><span class="sxs-lookup"><span data-stu-id="ee7d4-136">Before you start coding, register your web app with Azure Active Directory (AD).</span></span> <span data-ttu-id="ee7d4-137">Registrace aplikace vytvoří centrální identitu pro vaši aplikaci ve službě Azure AD.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-137">The app registration creates a central identity for your app in Azure AD.</span></span> <span data-ttu-id="ee7d4-138">Že obsahuje základní informace o vaší aplikaci jako ID klienta OAuth, adresy URL odpovědí a přihlašovací údaje, které vaše aplikace používá k ověření a přístup k rozhraní API Správce Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-138">It holds basic information about your application like OAuth Client ID, Reply URLs, and credentials that your application uses to authenticate and access Azure Resource Manager APIs.</span></span> <span data-ttu-id="ee7d4-139">Registrace aplikací taky zaznamenává různé delegovaných oprávnění, které aplikace potřebuje při přístupu k Microsoft APIs jménem uživatele.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-139">The app registration also records the various delegated permissions that your application needs when accessing Microsoft APIs on behalf of the user.</span></span>

<span data-ttu-id="ee7d4-140">Vzhledem k tomu, že vaše aplikace přístup k jiné předplatné, musíte ho nakonfigurovat jako víceklientské aplikace.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-140">Because your app accesses other subscription, you must configure it as a multi-tenant application.</span></span> <span data-ttu-id="ee7d4-141">K provedení ověření, zadejte domény přidružené k vaší služby Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-141">To pass validation, provide a domain associated with your Azure Active Directory.</span></span> <span data-ttu-id="ee7d4-142">Pokud chcete zobrazit domény přidružené k vaší služby Azure Active Directory, přihlaste se k [portálu classic](https://manage.windowsazure.com).</span><span class="sxs-lookup"><span data-stu-id="ee7d4-142">To see the domains associated with your Azure Active Directory, log in to the [classic portal](https://manage.windowsazure.com).</span></span> <span data-ttu-id="ee7d4-143">Vyberte služby Azure Active Directory a pak vyberte **domény**.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-143">Select your Azure Active Directory and then select **Domains**.</span></span>

<span data-ttu-id="ee7d4-144">Následující příklad ukazuje, jak zaregistrovat aplikaci pomocí Azure PowerShell.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-144">The following example shows how to register the app by using Azure PowerShell.</span></span> <span data-ttu-id="ee7d4-145">Musíte mít nejnovější verzi prostředí Azure PowerShell pro tento příkaz fungovat (srpna 2016).</span><span class="sxs-lookup"><span data-stu-id="ee7d4-145">You must have the latest version (August 2016) of Azure PowerShell for this command to work.</span></span>

    $app = New-AzureRmADApplication -DisplayName "{app name}" -HomePage "https://{your domain}/{app name}" -IdentifierUris "https://{your domain}/{app name}" -Password "{your password}" -AvailableToOtherTenants $true

<span data-ttu-id="ee7d4-146">Přihlásit se jako aplikace AD, musíte aplikaci id a hesla.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-146">To log in as the AD application, you need the application id and password.</span></span> <span data-ttu-id="ee7d4-147">Pokud chcete zobrazit id aplikace, která je vrácena z předchozí příkaz, použijte:</span><span class="sxs-lookup"><span data-stu-id="ee7d4-147">To see the application id that is returned from the previous command, use:</span></span>

    $app.ApplicationId

<span data-ttu-id="ee7d4-148">Následující příklad ukazuje, jak pro registraci aplikace pomocí rozhraní příkazového řádku Azure.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-148">The following example shows how to register the app by using Azure CLI.</span></span>

    azure ad app create --name {app name} --home-page https://{your domain}/{app name} --identifier-uris https://{your domain}/{app name} --password {your password} --available true

<span data-ttu-id="ee7d4-149">Výsledky budou zahrnovat AppId, který je třeba při ověřování jako aplikace.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-149">The results include the AppId, which you need when authenticating as the application.</span></span>

### <a name="optional-configuration---certificate-credential"></a><span data-ttu-id="ee7d4-150">Volitelné konfigurace – certifikát přihlašovacích údajů</span><span class="sxs-lookup"><span data-stu-id="ee7d4-150">Optional configuration - certificate credential</span></span>
<span data-ttu-id="ee7d4-151">Azure AD podporuje přihlašovací údaje certifikátu pro aplikace: vytvoření certifikátu podepsaného svým držitelem, zachovat privátní klíč a přidejte veřejný klíč registrace aplikace Azure AD.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-151">Azure AD also supports certificate credentials for applications: you create a self-signed cert, keep the private key, and add the public key to your Azure AD application registration.</span></span> <span data-ttu-id="ee7d4-152">Pro ověřování vaše aplikace odešle malé datové části do služby Azure AD podepsaná pomocí soukromého klíče a Azure AD ověří podpis pomocí veřejného klíče, který je zaregistrovaný.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-152">For authentication, your application sends a small payload to Azure AD signed using your private key, and Azure AD validates the signature using the public key that you registered.</span></span>

<span data-ttu-id="ee7d4-153">Informace o vytvoření aplikace AD pomocí certifikátu najdete v tématu [použití Azure PowerShell k vytvoření objektu služby pro přístup k prostředkům](resource-group-authenticate-service-principal.md#create-service-principal-with-certificate-from-certificate-authority) nebo [použití Azure CLI pro vytvoření objektu služby pro přístup k prostředkům](resource-group-authenticate-service-principal-cli.md#create-service-principal-with-certificate) .</span><span class="sxs-lookup"><span data-stu-id="ee7d4-153">For information about creating an AD app with a certificate, see [Use Azure PowerShell to create a service principal to access resources](resource-group-authenticate-service-principal.md#create-service-principal-with-certificate-from-certificate-authority) or [Use Azure CLI to create a service principal to access resources](resource-group-authenticate-service-principal-cli.md#create-service-principal-with-certificate).</span></span>

## <a name="get-tenant-id-from-subscription-id"></a><span data-ttu-id="ee7d4-154">Získání id klienta z id předplatného</span><span class="sxs-lookup"><span data-stu-id="ee7d4-154">Get tenant id from subscription id</span></span>
<span data-ttu-id="ee7d4-155">K žádosti o token, který slouží k volání Resource Manager, aplikace musí znát ID klienta Azure AD klienta, který je hostitelem předplatné Azure.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-155">To request a token that can be used to call Resource Manager, your application needs to know the tenant ID of the Azure AD tenant that hosts the Azure subscription.</span></span> <span data-ttu-id="ee7d4-156">S největší pravděpodobností vaši uživatelé věděli, jejich ID předplatného, ale nemusí věděli, jejich klienta ID pro Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-156">Most likely, your users know their subscription ids, but they might not know their tenant ids for Azure Active Directory.</span></span> <span data-ttu-id="ee7d4-157">Chcete-li získat id uživatele klienta, požádejte uživatele, pro id předplatného.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-157">To get the user's tenant id, ask the user for the subscription id.</span></span> <span data-ttu-id="ee7d4-158">Při odesílání žádosti o předplatném, zadejte toto id předplatného:</span><span class="sxs-lookup"><span data-stu-id="ee7d4-158">Provide that subscription id when sending a request about the subscription:</span></span>

    https://management.azure.com/subscriptions/{subscription-id}?api-version=2015-01-01

<span data-ttu-id="ee7d4-159">Žádost se nezdaří, protože uživatel nebyl ještě přihlášen, ale můžete načíst id klienta z odpovědi.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-159">The request fails because the user has not logged in yet, but you can retrieve the tenant id from the response.</span></span> <span data-ttu-id="ee7d4-160">V této výjimky načíst id klienta z hodnotu hlavičky odpovědi pro **WWW-Authenticate**.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-160">In that exception, retrieve the tenant id from the response header value for **WWW-Authenticate**.</span></span> <span data-ttu-id="ee7d4-161">Zobrazí tuto implementaci v [GetDirectoryForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L20) metoda.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-161">You see this implementation in the [GetDirectoryForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L20) method.</span></span>

## <a name="get-user--app-access-token"></a><span data-ttu-id="ee7d4-162">Získat uživatele + přístupový token aplikace</span><span class="sxs-lookup"><span data-stu-id="ee7d4-162">Get user + app access token</span></span>
<span data-ttu-id="ee7d4-163">Vaše aplikace přesměruje uživatele do služby Azure AD s OAuth 2.0 autorizovat požadavek – k ověření přihlašovacích údajů uživatele a získat zpátky autorizační kód.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-163">Your application redirects the user to Azure AD with an OAuth 2.0 Authorize Request - to authenticate the user's credentials and get back an authorization code.</span></span> <span data-ttu-id="ee7d4-164">Vaše aplikace používá autorizační kód se získat přístupový token pro Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-164">Your application uses the authorization code to get an access token for Resource Manager.</span></span> <span data-ttu-id="ee7d4-165">[ConnectSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/Controllers/HomeController.cs#L42) metoda vytvoří žádost o ověření.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-165">The [ConnectSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/Controllers/HomeController.cs#L42) method creates the authorization request.</span></span>

<span data-ttu-id="ee7d4-166">Toto téma ukazuje požadavky REST API pro ověření uživatele.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-166">This topic shows the REST API requests to authenticate the user.</span></span> <span data-ttu-id="ee7d4-167">Pomocné knihovny můžete použít také k provedení ověření v kódu.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-167">You can also use helper libraries to perform authentication in your code.</span></span> <span data-ttu-id="ee7d4-168">Další informace o tyto knihovny najdete v tématu [knihovny Azure Active Directory Authentication](../active-directory/active-directory-authentication-libraries.md).</span><span class="sxs-lookup"><span data-stu-id="ee7d4-168">For more information about these libraries, see [Azure Active Directory Authentication Libraries](../active-directory/active-directory-authentication-libraries.md).</span></span> <span data-ttu-id="ee7d4-169">Pokyny k integraci správy identit v aplikaci najdete v tématu [Příručka pro vývojáře Azure Active Directory](../active-directory/active-directory-developers-guide.md).</span><span class="sxs-lookup"><span data-stu-id="ee7d4-169">For guidance on integrating identity management in an application, see [Azure Active Directory developer's guide](../active-directory/active-directory-developers-guide.md).</span></span>

### <a name="auth-request-oauth-20"></a><span data-ttu-id="ee7d4-170">Žádost o ověření (OAuth 2.0)</span><span class="sxs-lookup"><span data-stu-id="ee7d4-170">Auth request (OAuth 2.0)</span></span>
<span data-ttu-id="ee7d4-171">Vydejte Open ID Connect/OAuth2.0 autorizovat požadavku koncového bodu Azure AD Authorize:</span><span class="sxs-lookup"><span data-stu-id="ee7d4-171">Issue an Open ID Connect/OAuth2.0 Authorize Request to the Azure AD Authorize endpoint:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Authorize

<span data-ttu-id="ee7d4-172">Jsou popsané v tématu parametrů řetězce dotazu, které jsou k dispozici pro tento požadavek [autorizační kód požadavku](../active-directory/develop/active-directory-protocols-oauth-code.md#request-an-authorization-code) tématu.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-172">The query string parameters that are available for this request are described in the [request an authorization code](../active-directory/develop/active-directory-protocols-oauth-code.md#request-an-authorization-code) topic.</span></span>

<span data-ttu-id="ee7d4-173">Následující příklad ukazuje, jak požádat o OAuth2.0 autorizace:</span><span class="sxs-lookup"><span data-stu-id="ee7d4-173">The following example shows how to request OAuth2.0 authorization:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Authorize?client_id=a0448380-c346-4f9f-b897-c18733de9394&response_mode=query&response_type=code&redirect_uri=http%3a%2f%2fwww.vipswapper.com%2fcloudsense%2fAccount%2fSignIn&resource=https%3a%2f%2fgraph.windows.net%2f&domain_hint=live.com

<span data-ttu-id="ee7d4-174">Azure AD ověřuje uživatele a v případě potřeby požádá uživatele a udělit oprávnění k aplikaci.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-174">Azure AD authenticates the user, and, if necessary, asks the user to grant permission to the app.</span></span> <span data-ttu-id="ee7d4-175">Adresa URL odpovědi aplikace vrátí autorizační kód.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-175">It returns the authorization code to the Reply URL of your application.</span></span> <span data-ttu-id="ee7d4-176">V závislosti na požadované response_mode, Azure AD buď odešle zpět data v řetězci dotazu nebo jako následná data.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-176">Depending on the requested response_mode, Azure AD either sends back the data in query string or as post data.</span></span>

    code=AAABAAAAiL****FDMZBUwZ8eCAA&session_state=2d16bbce-d5d1-443f-acdf-75f6b0ce8850

### <a name="auth-request-open-id-connect"></a><span data-ttu-id="ee7d4-177">Žádost o ověření (Open ID Connect)</span><span class="sxs-lookup"><span data-stu-id="ee7d4-177">Auth request (Open ID Connect)</span></span>
<span data-ttu-id="ee7d4-178">Pokud chcete nejen pro přístup k Azure Resource Manager jménem uživatele, ale také umožnit uživatelům přihlášení k aplikaci pomocí svého účtu Azure AD, vydejte Open ID připojení autorizaci požadavků.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-178">If you not only wish to access Azure Resource Manager on behalf of the user, but also allow the user to sign in to your application using their Azure AD account, issue an Open ID Connect Authorize Request.</span></span> <span data-ttu-id="ee7d4-179">Aplikace s Open ID Connect také přijímá požadavku id_token z Azure AD, které aplikace můžete používat k přihlášení uživatele.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-179">With Open ID Connect, your application also receives an id_token from Azure AD that your app can use to sign in the user.</span></span>

<span data-ttu-id="ee7d4-180">Jsou popsané v tématu parametrů řetězce dotazu, které jsou k dispozici pro tento požadavek [odeslání žádosti o přihlášení](../active-directory/develop/active-directory-protocols-openid-connect-code.md#send-the-sign-in-request) tématu.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-180">The query string parameters that are available for this request are described in the [Send the sign-in request](../active-directory/develop/active-directory-protocols-openid-connect-code.md#send-the-sign-in-request) topic.</span></span>

<span data-ttu-id="ee7d4-181">Jedná se o příklad Open ID Connect žádost:</span><span class="sxs-lookup"><span data-stu-id="ee7d4-181">An example Open ID Connect request is:</span></span>

     https://login.microsoftonline.com/{tenant-id}/OAuth2/Authorize?client_id=a0448380-c346-4f9f-b897-c18733de9394&response_mode=form_post&response_type=code+id_token&redirect_uri=http%3a%2f%2fwww.vipswapper.com%2fcloudsense%2fAccount%2fSignIn&resource=https%3a%2f%2fgraph.windows.net%2f&scope=openid+profile&nonce=63567Dc4MDAw&domain_hint=live.com&state=M_12tMyKaM8

<span data-ttu-id="ee7d4-182">Azure AD ověřuje uživatele a v případě potřeby požádá uživatele a udělit oprávnění k aplikaci.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-182">Azure AD authenticates the user, and, if necessary, asks the user to grant permission to the app.</span></span> <span data-ttu-id="ee7d4-183">Adresa URL odpovědi aplikace vrátí autorizační kód.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-183">It returns the authorization code to the Reply URL of your application.</span></span> <span data-ttu-id="ee7d4-184">V závislosti na požadované response_mode, Azure AD buď odešle zpět data v řetězci dotazu nebo jako následná data.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-184">Depending on the requested response_mode, Azure AD either sends back the data in query string or as post data.</span></span>

<span data-ttu-id="ee7d4-185">Příklad Open ID Connect odpověď je:</span><span class="sxs-lookup"><span data-stu-id="ee7d4-185">An example Open ID Connect response is:</span></span>

    code=AAABAAAAiL*****I4rDWd7zXsH6WUjlkIEQxIAA&id_token=eyJ0eXAiOiJKV1Q*****T3GrzzSFxg&state=M_12tMyKaM8&session_state=2d16bbce-d5d1-443f-acdf-75f6b0ce8850

### <a name="token-request-oauth20-code-grant-flow"></a><span data-ttu-id="ee7d4-186">Žádosti o token (OAuth2.0 kód Grant toku)</span><span class="sxs-lookup"><span data-stu-id="ee7d4-186">Token request (OAuth2.0 Code Grant Flow)</span></span>
<span data-ttu-id="ee7d4-187">Teď, když vaše aplikace přijal autorizační kód z Azure AD, je čas k získání tokenu přístupu pro Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-187">Now that your application has received the authorization code from Azure AD, it is time to get the access token for Azure Resource Manager.</span></span>  <span data-ttu-id="ee7d4-188">POST OAuth2.0 kódu Grant tokenu požadavek na koncový bod Azure AD Token:</span><span class="sxs-lookup"><span data-stu-id="ee7d4-188">Post an OAuth2.0 Code Grant Token Request to the Azure AD Token endpoint:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Token

<span data-ttu-id="ee7d4-189">Jsou popsané v tématu parametrů řetězce dotazu, které jsou k dispozici pro tento požadavek [použít autorizační kód](../active-directory/develop/active-directory-protocols-oauth-code.md#use-the-authorization-code-to-request-an-access-token) tématu.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-189">The query string parameters that are available for this request are described in the [use the authorization code](../active-directory/develop/active-directory-protocols-oauth-code.md#use-the-authorization-code-to-request-an-access-token) topic.</span></span>

<span data-ttu-id="ee7d4-190">Následující příklad ukazuje žádost o token grant kód s pověřením heslo:</span><span class="sxs-lookup"><span data-stu-id="ee7d4-190">The following example shows a request for code grant token with password credential:</span></span>

    POST https://login.microsoftonline.com/7fe877e6-a150-4992-bbfe-f517e304dfa0/oauth2/token HTTP/1.1

    Content-Type: application/x-www-form-urlencoded
    Content-Length: 1012

    grant_type=authorization_code&code=AAABAAAAiL9Kn2Z*****L1nVMH3Z5ESiAA&redirect_uri=http%3A%2F%2Flocalhost%3A62080%2FAccount%2FSignIn&client_id=a0448380-c346-4f9f-b897-c18733de9394&client_secret=olna84E8*****goScOg%3D

<span data-ttu-id="ee7d4-191">Při práci s přihlašovací údaje certifikátu, vytvořte Token pro webové JSON (JWT) a přihlašovací (RSA SHA256) pomocí soukromého klíče certifikátu pověření vaší aplikace.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-191">When working with certificate credentials, create a JSON Web Token (JWT) and sign (RSA SHA256) using the private key of your application's certificate credential.</span></span> <span data-ttu-id="ee7d4-192">Typy deklarací identity pro daný token, jsou uvedeny v [deklarace tokenů JWT](../active-directory/develop/active-directory-protocols-oauth-code.md#jwt-token-claims).</span><span class="sxs-lookup"><span data-stu-id="ee7d4-192">The claim types for the token are shown in [JWT token claims](../active-directory/develop/active-directory-protocols-oauth-code.md#jwt-token-claims).</span></span> <span data-ttu-id="ee7d4-193">Odkaz, najdete v článku [knihovna ověřování Active Directory (.NET) kód](https://github.com/AzureAD/azure-activedirectory-library-for-dotnet/blob/dev/src/ADAL.PCL.Desktop/CryptographyHelper.cs) k podepisování tokenů JWT Assertion klienta.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-193">For reference, see the [Active Directory Auth Library (.NET) code](https://github.com/AzureAD/azure-activedirectory-library-for-dotnet/blob/dev/src/ADAL.PCL.Desktop/CryptographyHelper.cs) to sign Client Assertion JWT tokens.</span></span>

<span data-ttu-id="ee7d4-194">Najdete v článku [Open ID Connect specifikace](http://openid.net/specs/openid-connect-core-1_0.html#ClientAuthentication) podrobnosti o ověření klienta.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-194">See the [Open ID Connect spec](http://openid.net/specs/openid-connect-core-1_0.html#ClientAuthentication) for details on client authentication.</span></span>

<span data-ttu-id="ee7d4-195">Následující příklad ukazuje žádost o token grant kód s certifikát přihlašovacích údajů:</span><span class="sxs-lookup"><span data-stu-id="ee7d4-195">The following example shows a request for code grant token with certificate credential:</span></span>

    POST https://login.microsoftonline.com/7fe877e6-a150-4992-bbfe-f517e304dfa0/oauth2/token HTTP/1.1

    Content-Type: application/x-www-form-urlencoded
    Content-Length: 1012

    grant_type=authorization_code&code=AAABAAAAiL9Kn2Z*****L1nVMH3Z5ESiAA&redirect_uri=http%3A%2F%2Flocalhost%3A62080%2FAccount%2FSignIn&client_id=a0448380-c346-4f9f-b897-c18733de9394&client_assertion_type=urn%3Aietf%3Aparams%3Aoauth%3Aclient-assertion-type%3Ajwt-bearer&client_assertion=eyJhbG*****Y9cYo8nEjMyA

<span data-ttu-id="ee7d4-196">Odpověď příklad pro kód udělit token:</span><span class="sxs-lookup"><span data-stu-id="ee7d4-196">An example response for code grant token:</span></span>

    HTTP/1.1 200 OK

    {"token_type":"Bearer","expires_in":"3599","expires_on":"1432039858","not_before":"1432035958","resource":"https://management.core.windows.net/","access_token":"eyJ0eXAiOiJKV1Q****M7Cw6JWtfY2lGc5A","refresh_token":"AAABAAAAiL9Kn2Z****55j-sjnyYgAA","scope":"user_impersonation","id_token":"eyJ0eXAiOiJKV*****-drP1J3P-HnHi9Rr46kGZnukEBH4dsg"}

#### <a name="handle-code-grant-token-response"></a><span data-ttu-id="ee7d4-197">Zpracování odpovědi tokenu grant kódu</span><span class="sxs-lookup"><span data-stu-id="ee7d4-197">Handle code grant token response</span></span>
<span data-ttu-id="ee7d4-198">Úspěšné odpovědi tokenu obsahuje (uživatele + aplikace) přístupový token pro Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-198">A successful token response contains the (user + app) access token for Azure Resource Manager.</span></span> <span data-ttu-id="ee7d4-199">Vaše aplikace používá token přístupu pro přístup k prostředku správce jménem uživatele.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-199">Your application uses this access token to access Resource Manager on behalf of the user.</span></span> <span data-ttu-id="ee7d4-200">Životnost přístupové tokeny vydané službou Azure AD je jedna hodina.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-200">The lifetime of access tokens issued by Azure AD is one hour.</span></span> <span data-ttu-id="ee7d4-201">Není pravděpodobné, že vaše webová aplikace musí obnovit (uživatele + aplikace) přístupový token.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-201">It is unlikely that your web application needs to renew the (user + app) access token.</span></span> <span data-ttu-id="ee7d4-202">Pokud je potřeba obnovit přístupový token, použijte token obnovení, které aplikace přijímá v odpovědi tokenu.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-202">If it needs to renew the access token, use the refresh token that your application receives in the token response.</span></span> <span data-ttu-id="ee7d4-203">POST OAuth2.0 tokenu požadavek na koncový bod Azure AD Token:</span><span class="sxs-lookup"><span data-stu-id="ee7d4-203">Post an OAuth2.0 Token Request to the Azure AD Token endpoint:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Token

<span data-ttu-id="ee7d4-204">Parametry, které chcete použít s požadavkem, aktualizace jsou popsané v [aktualizovat přístupový token](../active-directory/develop/active-directory-protocols-oauth-code.md#refreshing-the-access-tokens).</span><span class="sxs-lookup"><span data-stu-id="ee7d4-204">The parameters to use with the refresh request are described in [refreshing the access token](../active-directory/develop/active-directory-protocols-oauth-code.md#refreshing-the-access-tokens).</span></span>

<span data-ttu-id="ee7d4-205">Následující příklad ukazuje způsob použití aktualizace tokenu:</span><span class="sxs-lookup"><span data-stu-id="ee7d4-205">The following example shows how to use the refresh token:</span></span>

    POST https://login.microsoftonline.com/7fe877e6-a150-4992-bbfe-f517e304dfa0/oauth2/token HTTP/1.1

    Content-Type: application/x-www-form-urlencoded
    Content-Length: 1012

    grant_type=refresh_token&refresh_token=AAABAAAAiL9Kn2Z****55j-sjnyYgAA&client_id=a0448380-c346-4f9f-b897-c18733de9394&client_secret=olna84E8*****goScOg%3D

<span data-ttu-id="ee7d4-206">Tokeny obnovení lze získat nové přístupové tokeny pro Azure Resource Manager, ale nejsou vhodné pro offline přístup k vaší aplikací.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-206">Although refresh tokens can be used to get new access tokens for Azure Resource Manager, they are not suitable for offline access by your application.</span></span> <span data-ttu-id="ee7d4-207">Doba platnosti tokenů aktualizace je omezený a tokeny obnovení je vázána na uživatele.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-207">The refresh tokens lifetime is limited, and refresh tokens are bound to the user.</span></span> <span data-ttu-id="ee7d4-208">Pokud uživatel opustí organizaci, zruší aplikace pomocí obnovovacího tokenu přístupu.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-208">If the user leaves the organization, the application using the refresh token loses access.</span></span> <span data-ttu-id="ee7d4-209">Tento přístup není vhodný pro aplikace, které jsou používány týmy ke správě svých prostředků Azure.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-209">This approach isn't suitable for applications that are used by teams to manage their Azure resources.</span></span>

## <a name="check-if-user-can-assign-access-to-subscription"></a><span data-ttu-id="ee7d4-210">Zkontrolujte, pokud uživatele lze přiřadit přístup k předplatnému</span><span class="sxs-lookup"><span data-stu-id="ee7d4-210">Check if user can assign access to subscription</span></span>
<span data-ttu-id="ee7d4-211">Aplikace nyní obsahuje token pro přístup k Azure Resource Manager jménem uživatele.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-211">Your application now has a token to access Azure Resource Manager on behalf of the user.</span></span> <span data-ttu-id="ee7d4-212">Dalším krokem je připojení aplikace k předplatnému.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-212">The next step is to connect your app to the subscription.</span></span> <span data-ttu-id="ee7d4-213">Po připojení, aplikace spravovat těchto předplatných, i v případě, že uživatel není přítomen (dlouhodobé offline přístup).</span><span class="sxs-lookup"><span data-stu-id="ee7d4-213">After connecting, your app can manage those subscriptions even when the user isn't present (long-term offline access).</span></span>

<span data-ttu-id="ee7d4-214">Pro každé předplatné pro připojení, volejte [seznamu oprávnění správce prostředků](https://docs.microsoft.com/rest/api/authorization/permissions) rozhraní API k určení, zda má uživatel práva pro správu přístupu pro předplatné.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-214">For each subscription to connect, call the [Resource Manager list permissions](https://docs.microsoft.com/rest/api/authorization/permissions) API to determine whether the user has access management rights for the subscription.</span></span>

<span data-ttu-id="ee7d4-215">[UserCanManagerAccessForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L44) metoda ukázkovou aplikaci ASP.NET MVC implementuje toto volání.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-215">The [UserCanManagerAccessForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L44) method of the ASP.NET MVC sample app implements this call.</span></span>

<span data-ttu-id="ee7d4-216">Následující příklad ukazuje, jak požádat o oprávnění uživatele na předplatném.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-216">The following example shows how to request a user's permissions on a subscription.</span></span> <span data-ttu-id="ee7d4-217">83cfe939-2402-4581-b761-4f59b0a041e4 je id předplatného.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-217">83cfe939-2402-4581-b761-4f59b0a041e4 is the id of the subscription.</span></span>

    GET https://management.azure.com/subscriptions/83cfe939-2402-4581-b761-4f59b0a041e4/providers/microsoft.authorization/permissions?api-version=2015-07-01 HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJKV1QiLC***lwO1mM7Cw6JWtfY2lGc5A

<span data-ttu-id="ee7d4-218">Příklad odpovědi a získejte oprávnění uživatele na základě předplatného je:</span><span class="sxs-lookup"><span data-stu-id="ee7d4-218">An example of the response to get user's permissions on subscription is:</span></span>

    HTTP/1.1 200 OK

    {"value":[{"actions":["*"],"notActions":["Microsoft.Authorization/*/Write","Microsoft.Authorization/*/Delete"]},{"actions":["*/read"],"notActions":[]}]}

<span data-ttu-id="ee7d4-219">Oprávnění rozhraní API vrátí více oprávnění.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-219">The permissions API returns multiple permissions.</span></span> <span data-ttu-id="ee7d4-220">Každé oprávnění se skládá z povolených akcí (akce) a zakázané akce (notactions).</span><span class="sxs-lookup"><span data-stu-id="ee7d4-220">Each permission consists of allowed actions (actions) and disallowed actions (notactions).</span></span> <span data-ttu-id="ee7d4-221">Pokud je přítomen v seznamu povolených akcí všechna oprávnění a nejsou k dispozici v seznamu notactions tohoto oprávnění, má uživatel k provedení této akce.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-221">If an action is present in the allowed actions list of any permission and not present in the notactions list of that permission, the user is allowed to perform that action.</span></span> <span data-ttu-id="ee7d4-222">**Microsoft.Authorization/RoleAssignments/Write** je akce, který uděluje přístup práva pro správu.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-222">**microsoft.authorization/roleassignments/write** is the action that that grants access management rights.</span></span> <span data-ttu-id="ee7d4-223">Aplikace musí analyzovat výsledek oprávnění pro hledání shody regex na tento řetězec akce v akce a notactions jednotlivých oprávnění.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-223">Your application must parse the permissions result to look for a regex match on this action string in the actions and notactions of each permission.</span></span>

## <a name="get-app-only-access-token"></a><span data-ttu-id="ee7d4-224">Získání tokenu přístupu jen aplikace</span><span class="sxs-lookup"><span data-stu-id="ee7d4-224">Get app-only access token</span></span>
<span data-ttu-id="ee7d4-225">Teď víte, pokud uživatele lze přiřadit přístup k předplatnému Azure.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-225">Now, you know if the user can assign access to the Azure subscription.</span></span> <span data-ttu-id="ee7d4-226">Další kroky jsou:</span><span class="sxs-lookup"><span data-stu-id="ee7d4-226">The next steps are:</span></span>

1. <span data-ttu-id="ee7d4-227">Přiřadíte příslušné role RBAC identity aplikace v předplatném.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-227">Assign the appropriate RBAC role to your application's identity on the subscription.</span></span>
2. <span data-ttu-id="ee7d4-228">Ověření přiřazení přístupu pomocí dotazů na oprávnění aplikace v předplatném nebo přístupem k Resource Manager pomocí tokenu jen aplikace.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-228">Validate the access assignment by querying for the Application's permission on the subscription or by accessing Resource Manager using app-only token.</span></span>
3. <span data-ttu-id="ee7d4-229">Zaznamenejte připojení ve struktuře vaší aplikace "připojené odběry" data - uložením id předplatného.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-229">Record the connection in your applications "connected subscriptions" data structure - persisting the id of the subscription.</span></span>

<span data-ttu-id="ee7d4-230">Podíváme blíže v prvním kroku.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-230">Let's look closer at the first step.</span></span> <span data-ttu-id="ee7d4-231">Pokud chcete přiřadit příslušné role RBAC identitu aplikace, je třeba určit:</span><span class="sxs-lookup"><span data-stu-id="ee7d4-231">To assign the appropriate RBAC role to the application's identity, you must determine:</span></span>

* <span data-ttu-id="ee7d4-232">Id objektu identity aplikace v uživatele Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="ee7d4-232">The object id of your application's identity in the user's Azure Active Directory</span></span>
* <span data-ttu-id="ee7d4-233">Identifikátor role RBAC, který vaše aplikace vyžaduje na předplatné</span><span class="sxs-lookup"><span data-stu-id="ee7d4-233">The identifier of the RBAC role that your application requires on the subscription</span></span>

<span data-ttu-id="ee7d4-234">Když se aplikace ověřuje uživatele z Azure AD, vytvoří objekt služby zabezpečení pro vaši aplikaci v této službě Azure AD.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-234">When your application authenticates a user from an Azure AD, it creates a service principal object for your application in that Azure AD.</span></span> <span data-ttu-id="ee7d4-235">Azure umožňuje role RBAC přiřazení objekty služby udělit přímý přístup k odpovídající aplikace na prostředky Azure.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-235">Azure allows RBAC roles to be assigned to service principals to grant direct access to corresponding applications on Azure resources.</span></span> <span data-ttu-id="ee7d4-236">Tato akce je přesně co chceme provést.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-236">This action is exactly what we wish to do.</span></span> <span data-ttu-id="ee7d4-237">Dotaz rozhraní Azure AD Graph API k určení identifikátor objektu služby vaší aplikace v přihlášeného uživatele je Azure AD.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-237">Query the Azure AD Graph API to determine the identifier of the service principal of your application in the signed-in user's Azure AD.</span></span>

<span data-ttu-id="ee7d4-238">Můžete mít pouze přístupový token pro Azure Resource Manager – budete potřebovat nový přístupový token pro volání rozhraní Azure AD Graph API.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-238">You only have an access token for Azure Resource Manager - you need a new access token to call the Azure AD Graph API.</span></span> <span data-ttu-id="ee7d4-239">Každá aplikace ve službě Azure AD má oprávnění k dotazování vlastní objekt zabezpečení služby, stačí jen aplikace přístupový token.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-239">Every application in Azure AD has permission to query its own service principal object, so an app-only access token is sufficient.</span></span>

<a id="app-azure-ad-graph" />

### <a name="get-app-only-access-token-for-azure-ad-graph-api"></a><span data-ttu-id="ee7d4-240">Získání tokenu přístupu jen pro aplikace pro Azure AD Graph API</span><span class="sxs-lookup"><span data-stu-id="ee7d4-240">Get app-only access token for Azure AD Graph API</span></span>
<span data-ttu-id="ee7d4-241">K ověření vaší aplikace a získat token do Azure AD Graph API, vydávat OAuth2.0 udělení pověření klienta žádosti o token toku koncový bod tokenu Azure AD (**https://login.microsoftonline.com/ {directory_domain_name} / OAuth2/Token**).</span><span class="sxs-lookup"><span data-stu-id="ee7d4-241">To authenticate your app and get a token to Azure AD Graph API, issue a Client Credential Grant OAuth2.0 flow token request to Azure AD token endpoint (**https://login.microsoftonline.com/{directory_domain_name}/OAuth2/Token**).</span></span>

<span data-ttu-id="ee7d4-242">[GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs) metoda ukázkové aplikace ASP.net MVC získá přístup jen aplikace tokenu pro rozhraní Graph API pomocí knihovny Active Directory Authentication Library pro .NET.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-242">The [GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs) method of the ASP.net MVC sample application gets an app-only access token for Graph API using the Active Directory Authentication Library for .NET.</span></span>

<span data-ttu-id="ee7d4-243">Jsou popsané v tématu parametrů řetězce dotazu, které jsou k dispozici pro tento požadavek [žádosti o Token k přístupu](../active-directory/develop/active-directory-protocols-oauth-service-to-service.md#request-an-access-token) tématu.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-243">The query string parameters that are available for this request are described in the [Request an Access Token](../active-directory/develop/active-directory-protocols-oauth-service-to-service.md#request-an-access-token) topic.</span></span>

<span data-ttu-id="ee7d4-244">Požadavek příklad token udělení pověření klienta:</span><span class="sxs-lookup"><span data-stu-id="ee7d4-244">An example request for client credential grant token:</span></span>

    POST https://login.microsoftonline.com/62e173e9-301e-423e-bcd4-29121ec1aa24/oauth2/token HTTP/1.1
    Content-Type: application/x-www-form-urlencoded
    Content-Length: 187</pre>
    <pre>grant_type=client_credentials&client_id=a0448380-c346-4f9f-b897-c18733de9394&resource=https%3A%2F%2Fgraph.windows.net%2F &client_secret=olna8C*****Og%3D

<span data-ttu-id="ee7d4-245">Odpověď příklad token udělení pověření klienta:</span><span class="sxs-lookup"><span data-stu-id="ee7d4-245">An example response for client credential grant token:</span></span>

    HTTP/1.1 200 OK

    {"token_type":"Bearer","expires_in":"3599","expires_on":"1432039862","not_before":"1432035962","resource":"https://graph.windows.net/","access_token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik1uQ19WWmNBVGZNNXBPWWlKSE1iYTlnb0VLWSIsImtpZCI6Ik1uQ19WWmNBVGZNNXBPWWlKSE1iYTlnb0VLWSJ9.eyJhdWQiOiJodHRwczovL2dyYXBoLndpbmRv****G5gUTV-kKorR-pg"}

### <a name="get-objectid-of-application-service-principal-in-user-azure-ad"></a><span data-ttu-id="ee7d4-246">Získejte ObjectId aplikace instanční objekt v uživatele Azure AD</span><span class="sxs-lookup"><span data-stu-id="ee7d4-246">Get ObjectId of application service principal in user Azure AD</span></span>
<span data-ttu-id="ee7d4-247">Nyní, použijte jen aplikace přístupového tokenu k dotazu [objekty služby Azure AD Graph](https://msdn.microsoft.com/Library/Azure/Ad/Graph/api/entity-and-complex-type-reference#serviceprincipal-entity) rozhraní API pro zjištění objektu Id aplikace instančního objektu v adresáři.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-247">Now, use the app-only access token to query the [Azure AD Graph Service Principals](https://msdn.microsoft.com/Library/Azure/Ad/Graph/api/entity-and-complex-type-reference#serviceprincipal-entity) API to determine the Object Id of the application's service principal in the directory.</span></span>

<span data-ttu-id="ee7d4-248">[GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs#) metoda ukázkové aplikace ASP.net MVC implementuje toto volání.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-248">The [GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs#) method of the ASP.net MVC sample application implements this call.</span></span>

<span data-ttu-id="ee7d4-249">Následující příklad ukazuje, jak požádat o aplikace instanční objekt.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-249">The following example shows how to request an application's service principal.</span></span> <span data-ttu-id="ee7d4-250">a0448380-c346-4f9f-b897-c18733de9394 je id klienta aplikace.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-250">a0448380-c346-4f9f-b897-c18733de9394 is the client id of the application.</span></span>

    GET https://graph.windows.net/62e173e9-301e-423e-bcd4-29121ec1aa24/servicePrincipals?api-version=1.5&$filter=appId%20eq%20'a0448380-c346-4f9f-b897-c18733de9394' HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJK*****-kKorR-pg

<span data-ttu-id="ee7d4-251">Následující příklad ukazuje hlavní odpověď na žádost o služby aplikace</span><span class="sxs-lookup"><span data-stu-id="ee7d4-251">The following example shows a response to the request for an application's service principal</span></span>

    HTTP/1.1 200 OK

    {"odata.metadata":"https://graph.windows.net/62e173e9-301e-423e-bcd4-29121ec1aa24/$metadata#directoryObjects/Microsoft.DirectoryServices.ServicePrincipal","value":[{"odata.type":"Microsoft.DirectoryServices.ServicePrincipal","objectType":"ServicePrincipal","objectId":"9b5018d4-6951-42ed-8a92-f11ec283ccec","deletionTimestamp":null,"accountEnabled":true,"appDisplayName":"CloudSense","appId":"a0448380-c346-4f9f-b897-c18733de9394","appOwnerTenantId":"62e173e9-301e-423e-bcd4-29121ec1aa24","appRoleAssignmentRequired":false,"appRoles":[],"displayName":"CloudSense","errorUrl":null,"homepage":"http://www.vipswapper.com/cloudsense","keyCredentials":[],"logoutUrl":null,"oauth2Permissions":[{"adminConsentDescription":"Allow the application to access CloudSense on behalf of the signed-in user.","adminConsentDisplayName":"Access CloudSense","id":"b7b7338e-683a-4796-b95e-60c10380de1c","isEnabled":true,"type":"User","userConsentDescription":"Allow the application to access CloudSense on your behalf.","userConsentDisplayName":"Access CloudSense","value":"user_impersonation"}],"passwordCredentials":[],"preferredTokenSigningKeyThumbprint":null,"publisherName":"vipswapper"quot;,"replyUrls":["http://www.vipswapper.com/cloudsense","http://www.vipswapper.com","http://vipswapper.com","http://vipswapper.azurewebsites.net","http://localhost:62080"],"samlMetadataUrl":null,"servicePrincipalNames":["http://www.vipswapper.com/cloudsense","a0448380-c346-4f9f-b897-c18733de9394"],"tags":["WindowsAzureActiveDirectoryIntegratedApp"]}]}

### <a name="get-azure-rbac-role-identifier"></a><span data-ttu-id="ee7d4-252">Získat identifikátor role Azure RBAC</span><span class="sxs-lookup"><span data-stu-id="ee7d4-252">Get Azure RBAC role identifier</span></span>
<span data-ttu-id="ee7d4-253">Přiřadit příslušné role RBAC k hlavní službě, je třeba určit identifikátor role Azure RBAC.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-253">To assign the appropriate RBAC role to your service principal, you must determine the identifier of the Azure RBAC role.</span></span>

<span data-ttu-id="ee7d4-254">Pravé role RBAC pro aplikaci:</span><span class="sxs-lookup"><span data-stu-id="ee7d4-254">The right RBAC role for your application:</span></span>

* <span data-ttu-id="ee7d4-255">Pokud vaše aplikace sleduje pouze odběru, beze změn, vyžaduje pouze oprávnění čtečky u předplatného.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-255">If your application only monitors the subscription, without making any changes, it requires only reader permissions on the subscription.</span></span> <span data-ttu-id="ee7d4-256">Přiřazení **čtečky** role.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-256">Assign the **Reader** role.</span></span>
* <span data-ttu-id="ee7d4-257">Pokud vaše aplikace spravuje Azure předplatného, vytváření, úpravy nebo odstranění entity, vyžaduje oprávnění přispěvatele.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-257">If your application manages Azure the subscription, creating/modifying/deleting entities, it requires one of the contributor permissions.</span></span>
  * <span data-ttu-id="ee7d4-258">Pokud chcete spravovat konkrétní typ prostředku, přiřadíte role Přispěvatel konkrétní prostředky (Přispěvatel virtuálních počítačů, Přispěvatel sítě, Přispěvatel účet úložiště, atd.)</span><span class="sxs-lookup"><span data-stu-id="ee7d4-258">To manage a particular type of resource, assign the resource-specific contributor roles (Virtual Machine Contributor, Virtual Network Contributor, Storage Account Contributor, etc.)</span></span>
  * <span data-ttu-id="ee7d4-259">Ke správě libovolného typu prostředku, přiřadit **Přispěvatel** role.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-259">To manage any resource type, assign the **Contributor** role.</span></span>

<span data-ttu-id="ee7d4-260">Přiřazení role pro vaši aplikaci se zobrazí uživatelům, takže vyberte nejmenší požadované oprávnění.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-260">The role assignment for your application is visible to users, so select the least-required privilege.</span></span>

<span data-ttu-id="ee7d4-261">Volání [definice role správce prostředků rozhraní API](https://docs.microsoft.com/rest/api/authorization/roledefinitions) seznamu role Azure RBAC a hledání pak iterace v výsledek, který má najít definice požadované role podle názvu.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-261">Call the [Resource Manager role definition API](https://docs.microsoft.com/rest/api/authorization/roledefinitions) to list all Azure RBAC roles and search then iterate over the result to find the desired role definition by name.</span></span>

<span data-ttu-id="ee7d4-262">[GetRoleId](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L246) metoda ukázkovou aplikaci ASP.net MVC implementuje toto volání.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-262">The [GetRoleId](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L246) method of the ASP.net MVC sample app implements this call.</span></span>

<span data-ttu-id="ee7d4-263">Následující příklad žádost ukazuje, jak získat identifikátor role Azure RBAC.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-263">The following request example shows how to get Azure RBAC role identifier.</span></span> <span data-ttu-id="ee7d4-264">09cbd307-aa71-4aca-b346-5f253e6e3ebb je id předplatného.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-264">09cbd307-aa71-4aca-b346-5f253e6e3ebb is the id of the subscription.</span></span>

    GET https://management.azure.com/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions?api-version=2015-07-01 HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJKV*****fY2lGc5

<span data-ttu-id="ee7d4-265">Odpověď je v následujícím formátu:</span><span class="sxs-lookup"><span data-stu-id="ee7d4-265">The response is in the following format:</span></span>

    HTTP/1.1 200 OK

    {"value":[{"properties":{"roleName":"API Management Service Contributor","type":"BuiltInRole","description":"Lets you manage API Management services, but not access to them.","scope":"/","permissions":[{"actions":["Microsoft.ApiManagement/Services/*","Microsoft.Authorization/*/read","Microsoft.Resources/subscriptions/resources/read","Microsoft.Resources/subscriptions/resourceGroups/read","Microsoft.Resources/subscriptions/resourceGroups/resources/read","Microsoft.Resources/subscriptions/resourceGroups/deployments/*","Microsoft.Insights/alertRules/*","Microsoft.Support/*"],"notActions":[]}]},"id":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/312a565d-c81f-4fd8-895a-4e21e48d571c","type":"Microsoft.Authorization/roleDefinitions","name":"312a565d-c81f-4fd8-895a-4e21e48d571c"},{"properties":{"roleName":"Application Insights Component Contributor","type":"BuiltInRole","description":"Lets you manage Application Insights components, but not access to them.","scope":"/","permissions":[{"actions":["Microsoft.Insights/components/*","Microsoft.Insights/webtests/*","Microsoft.Authorization/*/read","Microsoft.Resources/subscriptions/resources/read","Microsoft.Resources/subscriptions/resourceGroups/read","Microsoft.Resources/subscriptions/resourceGroups/resources/read","Microsoft.Resources/subscriptions/resourceGroups/deployments/*","Microsoft.Insights/alertRules/*","Microsoft.Support/*"],"notActions":[]}]},"id":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/ae349356-3a1b-4a5e-921d-050484c6347e","type":"Microsoft.Authorization/roleDefinitions","name":"ae349356-3a1b-4a5e-921d-050484c6347e"}]}

<span data-ttu-id="ee7d4-266">Není nutné volat toto rozhraní API průběžně.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-266">You do not need to call this API on an ongoing basis.</span></span> <span data-ttu-id="ee7d4-267">Jakmile jste zjistili, dobře známé GUID definice role, můžete vytvořit id definice role jako:</span><span class="sxs-lookup"><span data-stu-id="ee7d4-267">Once you've determined the well-known GUID of the role definition, you can construct the role definition id as:</span></span>

    /subscriptions/{subscription_id}/providers/Microsoft.Authorization/roleDefinitions/{well-known-role-guid}

<span data-ttu-id="ee7d4-268">Toto jsou známé identifikátory GUID běžně používané předdefinovaných rolí:</span><span class="sxs-lookup"><span data-stu-id="ee7d4-268">Here are the well-known guids of commonly used built-in roles:</span></span>

| <span data-ttu-id="ee7d4-269">Role</span><span class="sxs-lookup"><span data-stu-id="ee7d4-269">Role</span></span> | <span data-ttu-id="ee7d4-270">Identifikátor GUID</span><span class="sxs-lookup"><span data-stu-id="ee7d4-270">Guid</span></span> |
| --- | --- |
| <span data-ttu-id="ee7d4-271">Čtenář</span><span class="sxs-lookup"><span data-stu-id="ee7d4-271">Reader</span></span> |<span data-ttu-id="ee7d4-272">acdd72a7-3385-48EF-bd42-f606fba81ae7</span><span class="sxs-lookup"><span data-stu-id="ee7d4-272">acdd72a7-3385-48ef-bd42-f606fba81ae7</span></span> |
| <span data-ttu-id="ee7d4-273">Přispěvatel</span><span class="sxs-lookup"><span data-stu-id="ee7d4-273">Contributor</span></span> |<span data-ttu-id="ee7d4-274">b24988ac-6180-42A0-ab88-20f7382dd24c</span><span class="sxs-lookup"><span data-stu-id="ee7d4-274">b24988ac-6180-42a0-ab88-20f7382dd24c</span></span> |
| <span data-ttu-id="ee7d4-275">Přispěvatel virtuálních počítačů</span><span class="sxs-lookup"><span data-stu-id="ee7d4-275">Virtual Machine Contributor</span></span> |<span data-ttu-id="ee7d4-276">d73bb868-a0df-4d4d-bd69-98a00b01fccb</span><span class="sxs-lookup"><span data-stu-id="ee7d4-276">d73bb868-a0df-4d4d-bd69-98a00b01fccb</span></span> |
| <span data-ttu-id="ee7d4-277">Přispěvatel virtuální sítě</span><span class="sxs-lookup"><span data-stu-id="ee7d4-277">Virtual Network Contributor</span></span> |<span data-ttu-id="ee7d4-278">b34d265f-36f7-4a0d-a4d4-e158ca92e90f</span><span class="sxs-lookup"><span data-stu-id="ee7d4-278">b34d265f-36f7-4a0d-a4d4-e158ca92e90f</span></span> |
| <span data-ttu-id="ee7d4-279">Přispěvatel účtu úložiště</span><span class="sxs-lookup"><span data-stu-id="ee7d4-279">Storage Account Contributor</span></span> |<span data-ttu-id="ee7d4-280">86e8f5dc-a6e9-4c67-9d15-de283e8eac25</span><span class="sxs-lookup"><span data-stu-id="ee7d4-280">86e8f5dc-a6e9-4c67-9d15-de283e8eac25</span></span> |
| <span data-ttu-id="ee7d4-281">Přispěvatel webu</span><span class="sxs-lookup"><span data-stu-id="ee7d4-281">Website Contributor</span></span> |<span data-ttu-id="ee7d4-282">de139f84-1756-47ae-9be6-808fbbe84772</span><span class="sxs-lookup"><span data-stu-id="ee7d4-282">de139f84-1756-47ae-9be6-808fbbe84772</span></span> |
| <span data-ttu-id="ee7d4-283">Plán přispěvatelů webu</span><span class="sxs-lookup"><span data-stu-id="ee7d4-283">Web Plan Contributor</span></span> |<span data-ttu-id="ee7d4-284">2cc479cb-7b4d-49a8-b449-8c00fd0f0a4b</span><span class="sxs-lookup"><span data-stu-id="ee7d4-284">2cc479cb-7b4d-49a8-b449-8c00fd0f0a4b</span></span> |
| <span data-ttu-id="ee7d4-285">Přispěvatel serveru SQL</span><span class="sxs-lookup"><span data-stu-id="ee7d4-285">SQL Server Contributor</span></span> |<span data-ttu-id="ee7d4-286">6d8ee4ec-f05a-4a1d-8b00-a9b17e38b437</span><span class="sxs-lookup"><span data-stu-id="ee7d4-286">6d8ee4ec-f05a-4a1d-8b00-a9b17e38b437</span></span> |
| <span data-ttu-id="ee7d4-287">Přispěvatel databází SQL</span><span class="sxs-lookup"><span data-stu-id="ee7d4-287">SQL DB Contributor</span></span> |<span data-ttu-id="ee7d4-288">9b7fa17d-e63e-47b0-bb0a-15c516ac86ec</span><span class="sxs-lookup"><span data-stu-id="ee7d4-288">9b7fa17d-e63e-47b0-bb0a-15c516ac86ec</span></span> |

### <a name="assign-rbac-role-to-application"></a><span data-ttu-id="ee7d4-289">Přiřazení RBAC role aplikace</span><span class="sxs-lookup"><span data-stu-id="ee7d4-289">Assign RBAC role to application</span></span>
<span data-ttu-id="ee7d4-290">Budete mít všechno, co je potřeba přiřadit příslušné role RBAC instanční objekt pomocí [Resource Manager vytvořit přiřazení role](https://docs.microsoft.com/rest/api/authorization/roleassignments) rozhraní API.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-290">You have everything you need to assign the appropriate RBAC role to your service principal by using the [Resource Manager create role assignment](https://docs.microsoft.com/rest/api/authorization/roleassignments) API.</span></span>

<span data-ttu-id="ee7d4-291">[GrantRoleToServicePrincipalOnSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L170) metoda ukázkovou aplikaci ASP.net MVC implementuje toto volání.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-291">The [GrantRoleToServicePrincipalOnSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L170) method of the ASP.net MVC sample app implements this call.</span></span>

<span data-ttu-id="ee7d4-292">Příklad požadavek přiřazení RBAC role aplikace:</span><span class="sxs-lookup"><span data-stu-id="ee7d4-292">An example request to assign RBAC role to application:</span></span>

    PUT https://management.azure.com/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/microsoft.authorization/roleassignments/4f87261d-2816-465d-8311-70a27558df4c?api-version=2015-07-01 HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJKV1QiL*****FlwO1mM7Cw6JWtfY2lGc5
    Content-Type: application/json
    Content-Length: 230

    {"properties": {"roleDefinitionId":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/acdd72a7-3385-48ef-bd42-f606fba81ae7","principalId":"c3097b31-7309-4c59-b4e3-770f8406bad2"}}

<span data-ttu-id="ee7d4-293">V požadavku budou použity následující hodnoty:</span><span class="sxs-lookup"><span data-stu-id="ee7d4-293">In the request, the following values are used:</span></span>

| <span data-ttu-id="ee7d4-294">Identifikátor GUID</span><span class="sxs-lookup"><span data-stu-id="ee7d4-294">Guid</span></span> | <span data-ttu-id="ee7d4-295">Popis</span><span class="sxs-lookup"><span data-stu-id="ee7d4-295">Description</span></span> |
| --- | --- |
| <span data-ttu-id="ee7d4-296">09cbd307-aa71-4aca-b346-5f253e6e3ebb</span><span class="sxs-lookup"><span data-stu-id="ee7d4-296">09cbd307-aa71-4aca-b346-5f253e6e3ebb</span></span> |<span data-ttu-id="ee7d4-297">id předplatného</span><span class="sxs-lookup"><span data-stu-id="ee7d4-297">the id of the subscription</span></span> |
| <span data-ttu-id="ee7d4-298">c3097b31-7309-4C59-b4e3-770f8406bad2</span><span class="sxs-lookup"><span data-stu-id="ee7d4-298">c3097b31-7309-4c59-b4e3-770f8406bad2</span></span> |<span data-ttu-id="ee7d4-299">id objektu objektu služby aplikace</span><span class="sxs-lookup"><span data-stu-id="ee7d4-299">the object id of the service principal of the application</span></span> |
| <span data-ttu-id="ee7d4-300">acdd72a7-3385-48EF-bd42-f606fba81ae7</span><span class="sxs-lookup"><span data-stu-id="ee7d4-300">acdd72a7-3385-48ef-bd42-f606fba81ae7</span></span> |<span data-ttu-id="ee7d4-301">id role čtenáře</span><span class="sxs-lookup"><span data-stu-id="ee7d4-301">the id of the reader role</span></span> |
| <span data-ttu-id="ee7d4-302">4f87261d-2816-465D-8311-70a27558df4c</span><span class="sxs-lookup"><span data-stu-id="ee7d4-302">4f87261d-2816-465d-8311-70a27558df4c</span></span> |<span data-ttu-id="ee7d4-303">nový identifikátor guid vytvořit nové přiřazení role</span><span class="sxs-lookup"><span data-stu-id="ee7d4-303">a new guid created for the new role assignment</span></span> |

<span data-ttu-id="ee7d4-304">Odpověď je v následujícím formátu:</span><span class="sxs-lookup"><span data-stu-id="ee7d4-304">The response is in the following format:</span></span>

    HTTP/1.1 201 Created

    {"properties":{"roleDefinitionId":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/acdd72a7-3385-48ef-bd42-f606fba81ae7","principalId":"c3097b31-7309-4c59-b4e3-770f8406bad2","scope":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb"},"id":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleAssignments/4f87261d-2816-465d-8311-70a27558df4c","type":"Microsoft.Authorization/roleAssignments","name":"4f87261d-2816-465d-8311-70a27558df4c"}

### <a name="get-app-only-access-token-for-azure-resource-manager"></a><span data-ttu-id="ee7d4-305">Získání jen aplikace tokenu přístupu pro Azure Resource Manager</span><span class="sxs-lookup"><span data-stu-id="ee7d4-305">Get app-only access token for Azure Resource Manager</span></span>
<span data-ttu-id="ee7d4-306">K ověření aplikaci má požadovaný přístup na předplatné, provést úlohu test na odběru pomocí tokenu jen aplikace.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-306">To validate that app has the desired access on the subscription, perform a test task on the subscription using an app-only token.</span></span>

<span data-ttu-id="ee7d4-307">Chcete-li získat token přístupu jenom aplikace, postupujte podle pokynů z oddílu [získání tokenu přístupu jen pro aplikace pro Azure AD Graph API](#app-azure-ad-graph), s jinou hodnotu pro parametr prostředků:</span><span class="sxs-lookup"><span data-stu-id="ee7d4-307">To get an app-only access token, follow instructions from section [Get app-only access token for Azure AD Graph API](#app-azure-ad-graph), with a different value for the resource parameter:</span></span>

    https://management.core.windows.net/

<span data-ttu-id="ee7d4-308">[ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) metoda ukázkové aplikace ASP.NET MVC získá přístup jen aplikace token pro Azure Resource Manager pomocí knihovny Active Directory Authentication Library pro .net.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-308">The [ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) method of the ASP.NET MVC sample application gets an app-only access token for Azure Resource Manager using the Active Directory Authentication Library for .net.</span></span>

#### <a name="get-applications-permissions-on-subscription"></a><span data-ttu-id="ee7d4-309">Získat oprávnění aplikace v předplatném</span><span class="sxs-lookup"><span data-stu-id="ee7d4-309">Get Application's Permissions on Subscription</span></span>
<span data-ttu-id="ee7d4-310">Pokud chcete zkontrolovat, že aplikace má požadovaný přístup na základě předplatného služby Azure, můžete také zavolat [oprávnění správce prostředků](https://docs.microsoft.com/rest/api/authorization/permissions) rozhraní API.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-310">To check that your application has the desired access on an Azure subscription, you may also call the [Resource Manager Permissions](https://docs.microsoft.com/rest/api/authorization/permissions) API.</span></span> <span data-ttu-id="ee7d4-311">Tento přístup je podobná jak můžete určit, zda má uživatel práva pro správu přístupu pro předplatné.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-311">This approach is similar to how you determined whether the user has Access Management rights for the subscription.</span></span> <span data-ttu-id="ee7d4-312">Tentokrát však volejte oprávnění rozhraní API s tímto tokenem přístupu jenom aplikace, který jste obdrželi v předchozím kroku.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-312">However, this time, call the permissions API with the app-only access token that you received in the previous step.</span></span>

<span data-ttu-id="ee7d4-313">[ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) metoda ukázkovou aplikaci ASP.NET MVC implementuje toto volání.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-313">The [ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) method of the ASP.NET MVC sample app implements this call.</span></span>

## <a name="manage-connected-subscriptions"></a><span data-ttu-id="ee7d4-314">Správa připojené odběrů</span><span class="sxs-lookup"><span data-stu-id="ee7d4-314">Manage connected subscriptions</span></span>
<span data-ttu-id="ee7d4-315">Pokud příslušné role RBAC je přiřazen k objektu v předplatném služby vaší aplikace, aplikace můžete zachovat monitorování nebo správa pomocí jen aplikace přístupových tokenů pro Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-315">When the appropriate RBAC role is assigned to your application's service principal on the subscription, your application can keep monitoring/managing it using app-only access tokens for Azure Resource Manager.</span></span>

<span data-ttu-id="ee7d4-316">Pokud vlastník předplatného Odebere přiřazení role vaší aplikace pomocí portálu classic nebo nástroje příkazového řádku, vaše aplikace není nadále přístup k tomuto předplatnému.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-316">If a subscription owner removes your application's role assignment using the classic portal or command-line tools, your application is no longer able to access that subscription.</span></span> <span data-ttu-id="ee7d4-317">V takovém případě by měl upozornit uživatele, který připojení k předplatnému bylo porušeno z mimo aplikaci a jim poskytnout možnost "Opravit" připojení.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-317">In that case, you should notify the user that the connection with the subscription was severed from outside the application and give them an option to "repair" the connection.</span></span> <span data-ttu-id="ee7d4-318">"Opravit" by jednoduše znovu vytvořit přiřazení role, který byl odstraněn do offline režimu.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-318">"Repair" would simply re-create the role assignment that was deleted offline.</span></span>

<span data-ttu-id="ee7d4-319">Stejně jako jste povolili uživatelům připojit odběry do vaší aplikace, musíte povolit uživatelům příliš odpojit odběry.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-319">Just as you enabled the user to connect subscriptions to your application, you must allow the user to disconnect subscriptions too.</span></span> <span data-ttu-id="ee7d4-320">Z přístup správu hlediska odpojte znamená odebrání přiřazení role, který má aplikace instanční objekt na předplatné.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-320">From an access management point of view, disconnect means removing the role assignment that the application's service principal has on the subscription.</span></span> <span data-ttu-id="ee7d4-321">Volitelně může být jakýkoli stav v aplikaci pro předplatné odstraněna příliš.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-321">Optionally, any state in the application for the subscription might be removed too.</span></span>
<span data-ttu-id="ee7d4-322">Pouze uživatelé s oprávněním správy přístupu u předplatného je moct odpojit předplatné.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-322">Only users with access management permission on the subscription are able to disconnect the subscription.</span></span>

<span data-ttu-id="ee7d4-323">[RevokeRoleFromServicePrincipalOnSubscription metoda](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L200) rozhraní ASP.net MVC implementuje ukázkovou aplikaci toto volání.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-323">The [RevokeRoleFromServicePrincipalOnSubscription method](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L200) of the ASP.net MVC sample app implements this call.</span></span>

<span data-ttu-id="ee7d4-324">Je to – uživatelé teď můžete snadno připojit a spravovat svá předplatná Azure s vaší aplikací.</span><span class="sxs-lookup"><span data-stu-id="ee7d4-324">That's it - users can now easily connect and manage their Azure subscriptions with your application.</span></span>
