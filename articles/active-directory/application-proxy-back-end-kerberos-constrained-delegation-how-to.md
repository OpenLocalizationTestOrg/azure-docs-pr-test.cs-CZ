---
title: "Postup konfigurace aplikace Proxy aplikace pro použití omezeného delegování protokolu Kerberos | Microsoft Docs"
description: "Jak nakonfigurovat omezené delegování Kerberos pro aplikaci Azure AD Application Proxy."
services: active-directory
documentationcenter: 
author: ajamess
manager: femila
ms.assetid: 
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/11/2017
ms.author: asteen
ms.openlocfilehash: 3a768c30cb874d42d7b4fbd2eeaa6c0e23904e10
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 08/03/2017
---
# <a name="how-to-configure-an-application-proxy-application-to-use-kerberos-constrained-delegation"></a><span data-ttu-id="29467-103">Postup konfigurace aplikace Proxy aplikace pro použití omezeného delegování protokolu Kerberos</span><span class="sxs-lookup"><span data-stu-id="29467-103">How to configure an Application Proxy application to use Kerberos Constrained Delegation</span></span>

<span data-ttu-id="29467-104">Dostupné metody pro dosažení jednotného přihlašování k publikovaným aplikacím můžete poněkud lišit aplikace z aplikace a jednu z možností, že Proxy aplikace služby Azure nabízí ihned, je pomocí protokolu Kerberos vynuceným delegování použitím (KCD).</span><span class="sxs-lookup"><span data-stu-id="29467-104">The methods available for achieving SSO to published applications can somewhat vary from application to application and one of the options that Azure Application Proxy offers right out of the box, is Kerberos Constrained Delegation (KCD).</span></span> <span data-ttu-id="29467-105">Toto je konfigurovaným hostitel konektor provádět ověřování omezené protokolu kerberos na back-end aplikace jménem uživatelů.</span><span class="sxs-lookup"><span data-stu-id="29467-105">This is where a connector host is configured to perform constrained kerberos authentication to backend applications, on behalf of users.</span></span>

<span data-ttu-id="29467-106">Skutečný postup povolení použitím KCD je relativně jednoduché a obvykle vyžaduje více než obecné znalosti o různými součástmi a tok ověřování, která usnadňuje jednotné přihlašování.</span><span class="sxs-lookup"><span data-stu-id="29467-106">The actual procedure for enabling KCD is relatively straightforward and typically requires no more than a general understanding of the various components and authentication flow that facilitates SSO.</span></span> <span data-ttu-id="29467-107">Hledání poskytují informace k řešení scénáře kde použitím KCD jednotného přihlašování k nebude fungovat podle očekávání, může být Zhuštěno.</span><span class="sxs-lookup"><span data-stu-id="29467-107">Finding good sources of information to help troubleshoot scenarios where KCD SSO doesn’t function as expected, can be sparse.</span></span>

<span data-ttu-id="29467-108">V tomto článku se jako takový pokusí poskytovat samostatný bod odkaz, který by měly pomoci při řešení potíží a samoobslužné napravit některé nejčastější problémy, které vidíte.</span><span class="sxs-lookup"><span data-stu-id="29467-108">As such, this article attempts to provide a single point of reference that should help troubleshoot and self-remediate some of the most common issues that we see.</span></span> <span data-ttu-id="29467-109">Ve stejnou dobu nabízí další pokyny pro diagnostiku více komplexní a problémových implementace.</span><span class="sxs-lookup"><span data-stu-id="29467-109">At the same time offer additional guidance for diagnosing the more complex and troubled of implementation.</span></span>

<span data-ttu-id="29467-110">Všimněte si, že v tomto článku provede následující předpoklady:</span><span class="sxs-lookup"><span data-stu-id="29467-110">note that this article makes the following assumptions:</span></span>

-   <span data-ttu-id="29467-111">Proxy aplikace služby Azure nasazený dle naše [dokumentace](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-enable) a obecné přístup k aplikacím jiných použitím KCD funguje podle očekávání.</span><span class="sxs-lookup"><span data-stu-id="29467-111">Azure Application Proxy has been deployed as per our [documentation](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-enable) and general access to non KCD applications is working as expected.</span></span>

-   <span data-ttu-id="29467-112">Publikované cílová aplikace je založena na službě IIS a společnosti Microsoft implementace protokolu kerberos.</span><span class="sxs-lookup"><span data-stu-id="29467-112">The published target application is based on IIS and Microsoft’s implementation of kerberos.</span></span>

-   <span data-ttu-id="29467-113">Hostitelé serveru a aplikace se nacházet v jedné doméně služby Active Directory.</span><span class="sxs-lookup"><span data-stu-id="29467-113">The server and application hosts reside in a single Active Directory domain.</span></span> <span data-ttu-id="29467-114">Podrobné informace o pro různé scénáře domény a doménové struktury naleznete v našem [dokument White Paper použitím KCD](http://aka.ms/KCDPaper).</span><span class="sxs-lookup"><span data-stu-id="29467-114">Detailed information on cross domain and forest scenarios can be found in our [KCD whitepaper](http://aka.ms/KCDPaper).</span></span>

-   <span data-ttu-id="29467-115">Příslušná aplikace je publikována v Azure klienta povoleno předběžné ověřování a uživatelé budou k ověřování na Azure prostřednictvím ověřování na základě formulářů.</span><span class="sxs-lookup"><span data-stu-id="29467-115">The subject application is published in an Azure tenant with pre-authentication enabled, and users are expected to authenticate to Azure via forms based authentication.</span></span> <span data-ttu-id="29467-116">Scénáře ověřování klienta bohaté nejsou uvedené v tomto článku, ale v určitém okamžiku přidat v budoucnu.</span><span class="sxs-lookup"><span data-stu-id="29467-116">Rich client authentication scenarios are not covered by this article, but be added at some point in the future.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="29467-117">Požadavky</span><span class="sxs-lookup"><span data-stu-id="29467-117">Prerequisites</span></span>

<span data-ttu-id="29467-118">Proxy aplikace služby Azure můžete nasadit do prakticky libovolný typ infrastrukturu nebo prostředí a architektury už nepochybně lišit organizace.</span><span class="sxs-lookup"><span data-stu-id="29467-118">Azure Application Proxy can be deployed into pretty much any type of infrastructure or environment and the architectures no doubt vary from organization to organization.</span></span> <span data-ttu-id="29467-119">Mezi nejběžnější příčiny použitím KCD související s problémy s nejsou prostředí sami, ale spíše jednoduché chybná konfigurace nebo obecné dohledu.</span><span class="sxs-lookup"><span data-stu-id="29467-119">One of the most common causes of KCD related issues are not the environments themselves, but rather simple mis-configurations, or general oversight.</span></span>

<span data-ttu-id="29467-120">Z tohoto důvodu naše Rady, jak je vždy zahájíte tím, že zajistí jste splnili všechny předpoklady nastíněny v našem hlavní [pomocí jednotného přihlašování použitím KCD s Proxy aplikace článku](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd) před spuštěním řešení potíží.</span><span class="sxs-lookup"><span data-stu-id="29467-120">For this reason, our advice is always to start by making sure you have met all the pre-requisites laid out in our main [Using KCD SSO with the Application Proxy article](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd) before starting troubleshooting.</span></span>

<span data-ttu-id="29467-121">Části se hlavně na konfiguraci použitím KCD na 2012R2, aktivuje se podstatně liší přístup ke konfiguraci použitím KCD v dřívějších verzích systému Windows, ale také při se s vědomím několik dalších hledisek:</span><span class="sxs-lookup"><span data-stu-id="29467-121">Particularly the section on configuring KCD on 2012R2, as this employs a fundamentally different approach to configuring KCD on previous versions of Windows, but also while being mindful of several other considerations:</span></span>

-   <span data-ttu-id="29467-122">Je běžné pro členský server domény a otevřete dialogové okno zabezpečený kanál s konkrétním řadičem domény.</span><span class="sxs-lookup"><span data-stu-id="29467-122">It is not uncommon for a domain member server to open a secure channel dialog with a specific domain controller.</span></span> <span data-ttu-id="29467-123">Pak přesunete do jiné dialogového okna v každém okamžiku tak konektor hostitele obecně by neměl být omezena schopnost komunikovat se pouze konkrétní místní lokality řadiče domény.</span><span class="sxs-lookup"><span data-stu-id="29467-123">Then move to another dialog at any given time, so connector hosts should generally not be restricted to being able to communicate with only specific local site DCs.</span></span>

-   <span data-ttu-id="29467-124">Podobně jako výše bodu napříč doménami, které scénáře spoléhají na referenční seznamy, které budou řídit konektor hostitele do řadiče domény, které se mohou nacházet mimo hraniční místní sítě.</span><span class="sxs-lookup"><span data-stu-id="29467-124">Similar to the above point, cross domain scenarios rely on referrals that direct a connector host to DCs that may reside outside of the local network perimeter.</span></span> <span data-ttu-id="29467-125">V tomto scénáři, který je stejně důležité zajistit také umožňujete provoz na řadičích domény, které představují jiných příslušných domén a vyšší, nebo jiný delegování nezdaří.</span><span class="sxs-lookup"><span data-stu-id="29467-125">In this scenario it is equally important to make sure you are also allowing traffic onwards to DCs that represent other respective domains, or else delegation fail.</span></span>

-   <span data-ttu-id="29467-126">Kde je to možné, vyhněte se umístění všech aktivních zařízení IP adresy nebo ID mezi hostiteli v konektoru a řadiče domény, jako jsou někdy přes nežádoucí a narušovat přenos pomocí protokolu RPC jádra</span><span class="sxs-lookup"><span data-stu-id="29467-126">Where possible, you should avoid placing any active IPS/IDS devices between connector hosts and DCs, as these are sometimes over intrusive and interfere with core RPC traffic</span></span>

<span data-ttu-id="29467-127">Tolik, kolik bychom rádi vyřešit problémy rychle a efektivně, může trvat dobu, takže kde je to možné doporučujeme zkuste a otestovat delegování v nejjednodušší scénářů.</span><span class="sxs-lookup"><span data-stu-id="29467-127">As much as we’d like to resolve issues quickly and effectively, it can take time, so where possible you should try and test delegation in the simplest of scenarios.</span></span> <span data-ttu-id="29467-128">Zavést další proměnné, čím může být nutné soupeří s.</span><span class="sxs-lookup"><span data-stu-id="29467-128">The more variables you introduce, the more you may have to contend with.</span></span> <span data-ttu-id="29467-129">Například omezení testování jeden konektor můžete uložit drahocenný čas a další konektory lze přidat po vyřešení problémů.</span><span class="sxs-lookup"><span data-stu-id="29467-129">For example, limiting your testing to a single connector can save valuable time, and additional connectors can be added after the issues has been resolved.</span></span>

<span data-ttu-id="29467-130">Některé faktorech prostředí může také být jednou z příčin problému, proto znovu Pokud možné zkuste a minimalizovat architekturu pro úplné minimálně pro testování.</span><span class="sxs-lookup"><span data-stu-id="29467-130">Some environmental factors may also be contributing to an issue, so again if possible try and minimize the architecture to a bare minimum for testing.</span></span> <span data-ttu-id="29467-131">Například, nejsou nesprávně nakonfigurované interní brány firewall seznamy ACL, takže pokud je to možné mít veškerý provoz z řadičů domény a back-end aplikace povoleno přímo prostřednictvím konektoru.</span><span class="sxs-lookup"><span data-stu-id="29467-131">For example, misconfigured internal firewall ACLs are not uncommon, so if possible have all traffic from a connector allowed straight through to the DCs and backend application.</span></span> 

<span data-ttu-id="29467-132">Absolutní nejlepší místo k umístit konektory ve skutečnosti je co nejblíže jejich cíle jako může být.</span><span class="sxs-lookup"><span data-stu-id="29467-132">Actually the absolute best place to position connectors is as close to their targets as can be.</span></span> <span data-ttu-id="29467-133">S vložené den brány firewall a přitom se jednoduše testování přidá nepotřebné složitost a může prodloužit jenom vaše šetření.</span><span class="sxs-lookup"><span data-stu-id="29467-133">Having a firewall sat inline whilst testing simply adds unnecessary complexity, and could just prolong your investigations.</span></span>

<span data-ttu-id="29467-134">Ano co se považuje za problém použitím KCD přesto?</span><span class="sxs-lookup"><span data-stu-id="29467-134">So, what constitutes a KCD problem anyway?</span></span> <span data-ttu-id="29467-135">Dobře existuje několik classic označení použitím KCD přihlašování selhání a první známky problém obvykle projevují v prohlížeči.</span><span class="sxs-lookup"><span data-stu-id="29467-135">Well, there several classic indications of KCD SSO failing and the first signs of an issue usually manifest themselves in the browser.</span></span>

   ![Chyba konfigurace nesprávný použitím KCD](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic1.png)

   ![Autorizace se nezdařila z důvodu chybějících oprávnění](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic2.png)

<span data-ttu-id="29467-138">všechny, které jsou opatřeny stejné příznakem nedaří provést jednotné přihlašování a v důsledku odepření přístupu uživatele k aplikaci.</span><span class="sxs-lookup"><span data-stu-id="29467-138">all which bear the same symptom of failing to perform SSO, and consequently denying the user access to the application.</span></span>

## <a name="troubleshooting"></a><span data-ttu-id="29467-139">Řešení potíží</span><span class="sxs-lookup"><span data-stu-id="29467-139">Troubleshooting</span></span>

<span data-ttu-id="29467-140">Jak pak řešení závisí na problém a zjištěnými příznaků.</span><span class="sxs-lookup"><span data-stu-id="29467-140">How you then troubleshoot depend on the issue and observed symptoms.</span></span> <span data-ttu-id="29467-141">Před přechodem všechny další by doporučujeme následující odkazy obsahovat užitečné informace, které jste ještě nemusí mít pocházet napříč:</span><span class="sxs-lookup"><span data-stu-id="29467-141">Before going any further we would suggest the following links, as they contain useful information you may not yet have come across:</span></span>

-   [<span data-ttu-id="29467-142">Řešení potíží s Proxy aplikace problémy a chybové zprávy</span><span class="sxs-lookup"><span data-stu-id="29467-142">Troubleshoot Application Proxy problems and error messages</span></span>](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-troubleshoot)

-   [<span data-ttu-id="29467-143">Chyby protokolu Kerberos a symptomy</span><span class="sxs-lookup"><span data-stu-id="29467-143">Kerberos errors and symptoms</span></span>](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-troubleshoot#kerberos-errors)

-   [<span data-ttu-id="29467-144">Práce s SSO při místní a cloudové identity nejsou identické</span><span class="sxs-lookup"><span data-stu-id="29467-144">Working with SSO when on-premises and cloud identities are not identical</span></span>](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd#working-with-sso-when-on-premises-and-cloud-identities-are-not-identical)

<span data-ttu-id="29467-145">Pokud máte k dispozici to úplně, pak potíže hlavní výborný existuje.</span><span class="sxs-lookup"><span data-stu-id="29467-145">If you’ve got this far, then the main issue definitely exists.</span></span> <span data-ttu-id="29467-146">Budete muset prozkoumat podrobněji, takže začněte tím, že oddělíte toku do tří různých fází, které lze řešit potíže s.</span><span class="sxs-lookup"><span data-stu-id="29467-146">You need to dig deeper, so start by separating the flow into three distinct stages that you can troubleshoot.</span></span>

<span data-ttu-id="29467-147">**Předběžné ověření klienta** – externího uživatele ověřováním v Azure prostřednictvím prohlížeče.</span><span class="sxs-lookup"><span data-stu-id="29467-147">**Client pre-authentication** - The external user authenticating to Azure via a browser.</span></span>

<span data-ttu-id="29467-148">Schopnost předběžné ověřování v Azure je nutné pro jednotné přihlašování použitím KCD funkce.</span><span class="sxs-lookup"><span data-stu-id="29467-148">Being able to pre-authenticate to Azure is imperative for KCD SSO to function.</span></span> <span data-ttu-id="29467-149">To by měla otestovat a řešit nejdříve, pokud jsou nějaké problémy.</span><span class="sxs-lookup"><span data-stu-id="29467-149">This should be tested and addressed first, if there are any issues.</span></span> <span data-ttu-id="29467-150">Upozorňujeme, že předběžné ověřování fáze má žádný vztah k použitím KCD nebo publikované aplikace.</span><span class="sxs-lookup"><span data-stu-id="29467-150">Note that the pre-authentication stage has no relation to KCD or the published application.</span></span> <span data-ttu-id="29467-151">Očekává se poměrně snadno vyřešit případné nesrovnalosti správností kontrola subjektu účtu v Azure existuje a zda není zakázána nebo zablokovaný.</span><span class="sxs-lookup"><span data-stu-id="29467-151">It should be fairly easy to correct any discrepancies by sanity checking the subject account exists in Azure, and that it is not disabled/blocked.</span></span> <span data-ttu-id="29467-152">Odpovědi na chybu v prohlížeči je obvykle dostatečně popisný k pochopení příčiny.</span><span class="sxs-lookup"><span data-stu-id="29467-152">The error response in the browser is usually descriptive enough to understand the cause.</span></span> <span data-ttu-id="29467-153">Naše další dokumentace Poradce při potížích k ověření, pokud si nejste jisti, můžete také zkontrolovat.</span><span class="sxs-lookup"><span data-stu-id="29467-153">You can also check our other Troubleshoot docs to verify if you aren’t sure.</span></span>

<span data-ttu-id="29467-154">**Delegování služby** – konektor Azure Proxy získání lístku služby z KDC (Kerberos Distribution Center) protokolu kerberos jménem uživatelů.</span><span class="sxs-lookup"><span data-stu-id="29467-154">**Delegation service** - The Azure Proxy connector obtaining a kerberos service ticket from a KDC (Kerberos Distribution Center), on behalf of users.</span></span>

<span data-ttu-id="29467-155">Externí komunikace mezi klientem a Azure front-endu by měl mít žádný vliv na použitím KCD jakkoli, jiné než zajistit, že funguje.</span><span class="sxs-lookup"><span data-stu-id="29467-155">The external communications between the client and the Azure front end should have no bearing on KCD whatsoever, other than ensuring that it works.</span></span> <span data-ttu-id="29467-156">To je proto službu Azure Proxy lze zadat s platné ID uživatele, použije k získání lístku protokolu kerberos.</span><span class="sxs-lookup"><span data-stu-id="29467-156">This is so the Azure Proxy service can be provided with a valid user ID that be used to obtain a kerberos ticket.</span></span> <span data-ttu-id="29467-157">Bez této použitím KCD není možné a dojde k selhání.</span><span class="sxs-lookup"><span data-stu-id="29467-157">Without this KCD is not possible and would fail.</span></span>

<span data-ttu-id="29467-158">Jak je uvedeno nahoře, prohlížeč chybové zprávy, které obvykle nabízejí některé funkční různá vodítka na Proč se nedaří věcí.</span><span class="sxs-lookup"><span data-stu-id="29467-158">As mentioned previously, the browser error messages usually provide some good clues on why things are failing.</span></span> <span data-ttu-id="29467-159">Zajistěte, aby si poznamenat ID aktivity a časové razítko v odpovědi jako umožňují korelovat požadované chování, skutečná události v protokolu událostí Azure Proxy.</span><span class="sxs-lookup"><span data-stu-id="29467-159">Make sure to note down the activity ID and timestamp in the response as this allow you to correlate the behavior to actual events in the Azure Proxy event log.</span></span>

   ![Chyba konfigurace nesprávný použitím KCD](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic3.png)

<span data-ttu-id="29467-161">A odpovídající položky zobrazit, že protokol událostí bude považovat za událost 13019 nebo 12027.</span><span class="sxs-lookup"><span data-stu-id="29467-161">And the corresponding entries seen the event log would be seen as events 13019 or 12027.</span></span> <span data-ttu-id="29467-162">Můžete najít protokoly událostí konektor v **protokoly aplikací a služeb** &gt; **Microsoft** &gt; **AadApplicationProxy** &gt; **konektor**&gt;**správce**.</span><span class="sxs-lookup"><span data-stu-id="29467-162">You can find the connector event logs in **Applications and Services Logs** &gt; **Microsoft** &gt; **AadApplicationProxy** &gt; **Connector**&gt;**Admin**.</span></span>

   ![Událost 13019 z protokolu událostí aplikace Proxy](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic4.png)

   ![12027 události z protokolu událostí aplikace Proxy](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic5.png)

-   <span data-ttu-id="29467-165">Použít záznam v interní DNS pro adresu aplikace a ne záznam CName</span><span class="sxs-lookup"><span data-stu-id="29467-165">Use an A record in your internal DNS for the application’s address, and not a CName</span></span>

-   <span data-ttu-id="29467-166">Znovu potvrďte, že hostitel konektor byla udělena oprávnění pro delegování do určené cílového účtu SPN a že **používající libovolný protokol pro ověřování** je vybrána.</span><span class="sxs-lookup"><span data-stu-id="29467-166">Re-confirm that the connector host has been granted the rights to delegate to the designated target account’s SPN, and that **Use any authentication protocol** is selected.</span></span> <span data-ttu-id="29467-167">To je popsaná v našem hlavní [článku Konfigurace jednotného přihlašování](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd)</span><span class="sxs-lookup"><span data-stu-id="29467-167">This is covered in our main [SSO configuration article](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd)</span></span>

-   <span data-ttu-id="29467-168">Ověřte, že je po vydání pouze jednu instanci služby SPN v existence ve službě AD **setspn - x** z příkazový řádek na všechny domény členského hostitele</span><span class="sxs-lookup"><span data-stu-id="29467-168">Verify that there is only a single instance of the SPN in existence in AD by issuing a **setspn -x** from a cmd prompt on any domain member host</span></span>

-   <span data-ttu-id="29467-169">Zkontrolujte, pokud je zásada domény vynucení omezit [maximální velikost protokolu kerberos vydaných tokenů](https://blogs.technet.microsoft.com/askds/2012/09/12/maxtokensize-and-windows-8-and-windows-server-2012/), jak je to zabránit konektor získání tokenu Pokud nalezen nadměrné</span><span class="sxs-lookup"><span data-stu-id="29467-169">Check to see if a domain policy is being enforced to limit the [max size of issued kerberos tokens](https://blogs.technet.microsoft.com/askds/2012/09/12/maxtokensize-and-windows-8-and-windows-server-2012/), as this prevent the connector from obtaining a token if found to be excessive</span></span>

<span data-ttu-id="29467-170">Trasování sítě zaznamenávání výměn mezi hostitelem konektoru a domény služby KDC pak bude nejlepší dál při získávání více nízkou úroveň podrobností na problémy.</span><span class="sxs-lookup"><span data-stu-id="29467-170">A network trace capturing the exchanges between the connector host and a domain KDC would then be the next best step in obtaining more low level detail on the issues.</span></span> <span data-ttu-id="29467-171">Můžete najít v [podrobné informace Poradce při potížích dokumentu](https://aka.ms/proxytshootpaper).</span><span class="sxs-lookup"><span data-stu-id="29467-171">You can find this in [deep dive Troubleshoot paper](https://aka.ms/proxytshootpaper).</span></span>

<span data-ttu-id="29467-172">Pokud lístků spokojeni, měli byste vidět událost v protokolech s informacemi o tom, ověření se nezdařilo z důvodu aplikace vrací 401.</span><span class="sxs-lookup"><span data-stu-id="29467-172">If ticketing looks good, you should see an event in the logs stating that authentication failed due to the application returning a 401.</span></span> <span data-ttu-id="29467-173">To obvykle označuje, že cílová aplikace odmítat lístku, takže pokračovat s následující další fáze.</span><span class="sxs-lookup"><span data-stu-id="29467-173">This typically indicates that the target application rejecting your ticket, so proceed with the following next stage.</span></span>

<span data-ttu-id="29467-174">**Cílová aplikace** -příjemce poskytované konektor lístek protokolu kerberos</span><span class="sxs-lookup"><span data-stu-id="29467-174">**Target application** - The consumer of the kerberos ticket provided by the connector</span></span>

<span data-ttu-id="29467-175">V této fázi se očekává konektor odeslali protokolu kerberos lístek služby do back-end, jako hlavičku v rámci první žádost o aplikaci.</span><span class="sxs-lookup"><span data-stu-id="29467-175">At this stage the connector is expected to have sent a kerberos service ticket to the backend, as a header within the first application request.</span></span>

-   <span data-ttu-id="29467-176">Pomocí aplikace interní adresa URL definované v portálu, ověřte, že aplikace je přístupný přímo z prohlížeče na hostiteli konektor.</span><span class="sxs-lookup"><span data-stu-id="29467-176">Using the application’s internal URL defined in the portal, validate that the application is accessible directly from the browser on the connector host.</span></span> <span data-ttu-id="29467-177">Potom může přihlásit úspěšně.</span><span class="sxs-lookup"><span data-stu-id="29467-177">Then you can login successfully.</span></span> <span data-ttu-id="29467-178">Podrobnosti o to naleznete na stránce konektor Poradce při potížích.</span><span class="sxs-lookup"><span data-stu-id="29467-178">Details on doing this can be found on the connector Troubleshoot page.</span></span>

-   <span data-ttu-id="29467-179">Stále v hostiteli konektor potvrďte, že ověřování mezi prohlížečem a aplikace používá protokolu kerberos, jedním z následujících akcí:</span><span class="sxs-lookup"><span data-stu-id="29467-179">Still on the connector host, confirm that the authentication between the browser and the application is using kerberos, by doing one of the following:</span></span>

1.  <span data-ttu-id="29467-180">Spuštění nástrojů pro vývojáře (**F12**) v Internet Exploreru, nebo použijte [Fiddler](https://blogs.msdn.microsoft.com/crminthefield/2012/10/10/using-fiddler-to-check-for-kerberos-auth/) z hostitele konektor.</span><span class="sxs-lookup"><span data-stu-id="29467-180">Run Dev tools(**F12**) in Internet Explorer, or use [Fiddler](https://blogs.msdn.microsoft.com/crminthefield/2012/10/10/using-fiddler-to-check-for-kerberos-auth/) from the connector host.</span></span> <span data-ttu-id="29467-181">Přejděte do aplikace pomocí interní adresa URL a zkontrolovat nabízených hlavičky WWW ověření vrácený v odpovědi z aplikace, ujistěte se, že buď vyjednávání nebo protokolu kerberos je k dispozici.</span><span class="sxs-lookup"><span data-stu-id="29467-181">Go to the application using the internal URL, and inspect the offered WWW authorization headers returned in the response from the application, to ensure that either negotiate or kerberos is present.</span></span> <span data-ttu-id="29467-182">Objekt blob následné protokolu kerberos, vrátí se v odpovědi z prohlížeče do aplikace obvykle začínat **JÍ**, takže toto je dobrá indikace toho Kerberos se v play.</span><span class="sxs-lookup"><span data-stu-id="29467-182">A subsequent kerberos blob returned in the response from the browser to the application typically start with **YII**, so this is a good indication of kerberos being in play.</span></span> <span data-ttu-id="29467-183">NTLM na druhé straně vždy začínat **TlRMTVNTUAAB**, který čte NTLMSSP při dekódovat z formátu Base64.</span><span class="sxs-lookup"><span data-stu-id="29467-183">NTLM on the other hand always start with **TlRMTVNTUAAB**, which reads NTLMSSP when decoded from Base64.</span></span> <span data-ttu-id="29467-184">Pokud se zobrazí **TlRMTVNTUAAB** na začátku objektu blob, to znamená, že se protokol Kerberos **není** k dispozici.</span><span class="sxs-lookup"><span data-stu-id="29467-184">If you see **TlRMTVNTUAAB** at the start of the blob, this means that Kerberos is **not** available.</span></span> <span data-ttu-id="29467-185">Pokud to nevidíte, pomocí protokolu Kerberos je pravděpodobně k dispozici.</span><span class="sxs-lookup"><span data-stu-id="29467-185">If you don’t see this, Kerberos is likely available.</span></span>

  * <span data-ttu-id="29467-186">Poznámka: Pokud používáte aplikaci Fiddler, tato metoda by vyžadovaly dočasně zakázat rozšířené ochrany na konfiguraci aplikace ve službě IIS.</span><span class="sxs-lookup"><span data-stu-id="29467-186">Note, if using Fiddler, this method would require temporarily disabling extended protection on the application’s config in IIS.</span></span>

     ![Okno kontroly sítě prohlížeče](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic6.png)

    <span data-ttu-id="29467-188">*Obrázek:* vzhledem k tomu, že to nezačíná TIRMTVNTUAAB, jedná se o příklad Kerberos je k dispozici.</span><span class="sxs-lookup"><span data-stu-id="29467-188">*Figure:* Since this does not start with TIRMTVNTUAAB, this is an example that Kerberos is available.</span></span> <span data-ttu-id="29467-189">Jedná se o příklad objektu Blob protokolu Kerberos, který nezačíná JÍ.</span><span class="sxs-lookup"><span data-stu-id="29467-189">This is an example of a Kerberos Blob that doesn’t start with YII.</span></span>

2.  <span data-ttu-id="29467-190">Ze seznamu poskytovatelů na webu a přístup aplikace IIS přímo z prohlížeče IE na hostiteli konektor dočasně odeberte protokolu NTLM.</span><span class="sxs-lookup"><span data-stu-id="29467-190">Temporarily remove NTLM from the providers list on IIS site and access app directly from IE on connector host.</span></span> <span data-ttu-id="29467-191">Pomocí protokolu NTLM již v seznamu poskytovatelů byste měli mít přístup k aplikaci pouze pomocí protokolu Kerberos.</span><span class="sxs-lookup"><span data-stu-id="29467-191">With NTLM no longer in the providers list, you should be able to access the application using Kerberos only.</span></span> <span data-ttu-id="29467-192">Pokud se to nezdaří, pak, naznačuje, že došlo k potížím s konfigurací aplikace a ověřování protokolu Kerberos nefunguje.</span><span class="sxs-lookup"><span data-stu-id="29467-192">If this fails, then that suggests that there is a problem with the application’s configuration and Kerberos authentication is not functioning.</span></span>

<span data-ttu-id="29467-193">Protokolu Kerberos není k dispozici, zkontrolovat nastavení ověřování aplikace ve službě IIS zajistěte, aby vyjednávání je uvedena nejhornější prostřednictvím NTLM pod ní.</span><span class="sxs-lookup"><span data-stu-id="29467-193">If Kerberos is not available, then check the application’s authentication settings in IIS to make sure negotiate is listed topmost, with NTLM just beneath it.</span></span> <span data-ttu-id="29467-194">(Není Negotiate: ověřování protokolu kerberos nebo Negotiate: protokolu PKU2U).</span><span class="sxs-lookup"><span data-stu-id="29467-194">(Not Negotiate:kerberos or Negotiate:PKU2U).</span></span> <span data-ttu-id="29467-195">Pokračujte pouze v případě protokolu Kerberos je funkční.</span><span class="sxs-lookup"><span data-stu-id="29467-195">Only continue if Kerberos is functional.</span></span>

   ![Zprostředkovatelé ověřování systému Windows](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic7.png)
   
-   <span data-ttu-id="29467-197">Pomocí protokolu Kerberos a NTLM na místě umožňuje nyní dočasně zakázat předběžné ověřování pro aplikaci na portálu.</span><span class="sxs-lookup"><span data-stu-id="29467-197">With Kerberos and NTLM in place, lets now temporarily disable pre-authentication for the application in the portal.</span></span> <span data-ttu-id="29467-198">V tématu, pokud je přístupné z Internetu pomocí externí adresu URL.</span><span class="sxs-lookup"><span data-stu-id="29467-198">See if you can access it from the internet using the external URL.</span></span> <span data-ttu-id="29467-199">Musí se výzva k ověření a byste měli mít k tomu se stejným účtem použitým v předchozím kroku.</span><span class="sxs-lookup"><span data-stu-id="29467-199">You should be prompted to authenticate and should be able to do so with the same account used in the previous step.</span></span> <span data-ttu-id="29467-200">Pokud ne, to znamená problém s back-end aplikace a není použitím KCD vůbec.</span><span class="sxs-lookup"><span data-stu-id="29467-200">If not, this indicates a problem with the backend application and not KCD at all.</span></span>

-   <span data-ttu-id="29467-201">Nyní znovu povolte předběžné ověření na portálu a ověřit prostřednictvím Azure tak, že pokus o připojení k aplikaci prostřednictvím externí URL.</span><span class="sxs-lookup"><span data-stu-id="29467-201">Now re-enable pre-authentication in the portal and authenticate through Azure by attempting to connect to the application via it’s external URL.</span></span> <span data-ttu-id="29467-202">Pokud se nezdařila jednotné přihlašování, měla zobrazit zpráva zakázané chyby v prohlížeči a 13022 událost v protokolu:</span><span class="sxs-lookup"><span data-stu-id="29467-202">If SSO has failed, then you should see a forbidden error message in the browser, plus event 13022 in the log:</span></span>

    <span data-ttu-id="29467-203">*Microsoft AAD Application Proxy Connector nemůže ověřit uživatele, protože back-end server odpoví na pokusy o ověření pomocí protokolu Kerberos s chybu HTTP 401.*</span><span class="sxs-lookup"><span data-stu-id="29467-203">*Microsoft AAD Application Proxy Connector cannot authenticate the user because the backend server responds to Kerberos authentication attempts with an HTTP 401 error.*</span></span>

    ![Je zakázané chyba 401 HTTTP](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic8.png)

-   <span data-ttu-id="29467-205">Zkontrolujte, zda aplikace služby IIS tak, aby fond aplikací nakonfigurovaný konfigurován pro použití stejný účet, který SPN nakonfiguroval proti ve službě AD: navigace ve službě IIS, jak je uvedeno dále</span><span class="sxs-lookup"><span data-stu-id="29467-205">Check the IIS application to ensure the configured application pool is configured to use the same account that the SPN has been configured against in AD, by navigating in IIS as illustrated below</span></span>

    ![Okno Konfigurace aplikace IIS](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic9.png)

    <span data-ttu-id="29467-207">Jakmile znáte identitu, vydejte následující z příkazový řádek a ujistěte se, že tento účet jednoznačně nastavena dotyčném SPN.</span><span class="sxs-lookup"><span data-stu-id="29467-207">Once you know the identity, issue the following from a cmd prompt to make sure this account is definitely configured with the SPN in question.</span></span> <span data-ttu-id="29467-208">Například **setspn – q http/spn.wacketywack.com**</span><span class="sxs-lookup"><span data-stu-id="29467-208">For example,  **setspn – q http/spn.wacketywack.com**</span></span>

    ![SetSPN příkazové okno](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic10.png)

-   <span data-ttu-id="29467-210">Zkontrolujte, jestli hlavní název služby definované vzhledem nastavení aplikace v portálu je stejné hlavní název služby, který je nakonfigurovaný pro cílový AD účet používá fond aplikací dané aplikace</span><span class="sxs-lookup"><span data-stu-id="29467-210">Check that the SPN defined against the application’s settings in the portal is the same SPN that is configured against the target AD account in use by the application’s app pool</span></span>

   ![Hlavní název služby konfigurací na portálu Azure](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic11.png)
   
-   <span data-ttu-id="29467-212">Přejděte do služby IIS a vyberte **Editor konfigurací** možnost pro aplikaci a přejděte na **system.webServer/security/authentication/windowsAuthentication** k Ujistěte se, že **UseAppPoolCredentials** je nastaven na hodnotu true</span><span class="sxs-lookup"><span data-stu-id="29467-212">Go into IIS and select the **Configuration Editor** option for the application, and navigate to **system.webServer/security/authentication/windowsAuthentication** to make sure that **UseAppPoolCredentials** is set to true</span></span>

   ![Fondy aplikací IIS konfigurace přihlašovacích údajů – možnost](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic12.png)

<span data-ttu-id="29467-214">Když je užitečné v zvýšení výkonu operací protokolu Kerberos, a také povoleno v režimu jádra způsobí, že lístek pro požadovaná služba k dešifrování pomocí účtu počítače.</span><span class="sxs-lookup"><span data-stu-id="29467-214">While being useful in improving the performance of Kerberos operations, leaving Kernel mode enabled also causes the ticket for the requested service to be decrypted using machine account.</span></span> <span data-ttu-id="29467-215">To je také označován místního systému, takže s to nastavené na true zalomení použitím KCD, když je aplikace hostované na více serverech ve farmě.</span><span class="sxs-lookup"><span data-stu-id="29467-215">This is also called the Local system, so having this set to true break KCD when the application is hosted across multiple servers in a farm.</span></span>

-   <span data-ttu-id="29467-216">Jako další kontrolu, můžete také chtít zakázat **rozšířené** ochrany příliš.</span><span class="sxs-lookup"><span data-stu-id="29467-216">As an additional check, you may also want to disable the **Extended** protection too.</span></span> <span data-ttu-id="29467-217">Byly došlo k scénáře, kde to se ukázalo jako rozdělit použitím KCD při povolené ve velmi specifickém konfigurace, kde je aplikace publikována jako dílčí složku výchozí webové stránky.</span><span class="sxs-lookup"><span data-stu-id="29467-217">There have been encountered scenarios where this has proved to break KCD when enabled in very specific configurations, where an application is published as a sub folder of the Default Web site.</span></span> <span data-ttu-id="29467-218">Tato samotné je nakonfigurován pro pouze anonymní ověřování a celý dialogová okna šedá, které naznačují, že podřízené objekty nebude dědí všechny aktivní nastavení.</span><span class="sxs-lookup"><span data-stu-id="29467-218">This itself is configured for Anonymous authentication only, leaving the entire dialogs greyed out suggesting child objects would not be inheriting any active settings.</span></span> <span data-ttu-id="29467-219">Ale kde to možné, bude vždy doporučujeme mít tuto funkci povolíte, proto by nestálo testů, ale nezapomeňte toto povolit obnovení.</span><span class="sxs-lookup"><span data-stu-id="29467-219">But where possible we would always recommend having this enabled, so by all means test, but don’t forget to restore this to enabled.</span></span>

<span data-ttu-id="29467-220">Tyto další kontroly by měl mít umístí můžete sledovat, pokud chcete začít používat k publikované aplikaci.</span><span class="sxs-lookup"><span data-stu-id="29467-220">These additional checks should have put you on track to start using your published application.</span></span> <span data-ttu-id="29467-221">Můžete pokračovat a začne pracovat další konektory, které jsou také nakonfigurovány pro delegování, ale pokud žádné další věci pak by doporučujeme číst z našich podrobnější návod technické [kompletní Příručka pro řešení potíží s Azure AD Application Proxy](https://aka.ms/proxytshootpaper)</span><span class="sxs-lookup"><span data-stu-id="29467-221">You can go ahead and spin up additional connectors that are also configured to delegate, but if things are no further then we would suggest a read of our more in-depth technical walkthrough [The complete guide for Troubleshoot Azure AD Application Proxy](https://aka.ms/proxytshootpaper)</span></span>

<span data-ttu-id="29467-222">Pokud jste stále se nedaří průběhu problém, podporu bychom více než pomůže a pokračujte odsud.</span><span class="sxs-lookup"><span data-stu-id="29467-222">If you’re still unable to progress your issue, support would be more than happy to assist and continue from here.</span></span> <span data-ttu-id="29467-223">Vytvořit lístek podpory přímo v rámci portálu a bude naše technici oslovení pro vás.</span><span class="sxs-lookup"><span data-stu-id="29467-223">Create a support ticket directly within the portal and our engineers will reach out to you.</span></span>

## <a name="other-scenarios"></a><span data-ttu-id="29467-224">Další scénáře</span><span class="sxs-lookup"><span data-stu-id="29467-224">Other scenarios</span></span>

-   <span data-ttu-id="29467-225">Proxy aplikace služby Azure vyžádá lístek protokolu Kerberos před odesláním požadavku k aplikaci.</span><span class="sxs-lookup"><span data-stu-id="29467-225">Azure Application Proxy requests a Kerberos ticket before sending its request to an application.</span></span> <span data-ttu-id="29467-226">Některé 3. stran aplikace například Tableau Server nelíbí tuto metodu ověřování a místo očekává více konvenční jednání proběhla.</span><span class="sxs-lookup"><span data-stu-id="29467-226">Some 3rd party applications such as Tableau Server do not like this method of authenticating, and rather expects the more conventional negotiations to take place,.</span></span> <span data-ttu-id="29467-227">První požadavek je anonymní, umožní aplikaci reagovat s typy ověřování, že podporuje prostřednictvím 401.</span><span class="sxs-lookup"><span data-stu-id="29467-227">The first request is anonymous, allowing the application to respond with the authentication types that it supports through a 401.</span></span>

-   <span data-ttu-id="29467-228">Double směrování ověřování – běžně používá ve scénářích, kde vrstvené aplikace s back-end a před koncem, oba vyžadují ověřování, jako je služba SQL Reporting Services.</span><span class="sxs-lookup"><span data-stu-id="29467-228">Double hop authentication - Commonly used in scenarios where an application is tiered, with a backend and front end, both requiring authentication, such as SQL Reporting Services.</span></span>

## <a name="next-steps"></a><span data-ttu-id="29467-229">Další kroky</span><span class="sxs-lookup"><span data-stu-id="29467-229">Next steps</span></span>
[<span data-ttu-id="29467-230">Nakonfigurujte omezené delegování protokolu kerberos (použitím KCD) na spravované doméně</span><span class="sxs-lookup"><span data-stu-id="29467-230">Configure kerberos constrained delegation (KCD) on a managed domain</span></span>](https://docs.microsoft.com/azure/active-directory-domain-services/active-directory-ds-enable-kcd)
