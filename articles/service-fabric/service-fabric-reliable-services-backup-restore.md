---
title: "Služba Fabric zálohování a obnovení | Microsoft Docs"
description: "Rámcová dokumentace pro Service Fabric zálohování a obnovení"
services: service-fabric
documentationcenter: .net
author: mcoskun
manager: timlt
editor: subramar,jessebenson
ms.assetid: 91ea6ca4-cc2a-4155-9823-dcbd0b996349
ms.service: service-fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 08/18/2017
ms.author: mcoskun
ms.openlocfilehash: 4242962e7e03053ef25f198a0b2f6c8012e693eb
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 08/29/2017
---
# <a name="back-up-and-restore-reliable-services-and-reliable-actors"></a><span data-ttu-id="cf9de-103">Zálohování a obnovení Reliable Services a Reliable Actors</span><span class="sxs-lookup"><span data-stu-id="cf9de-103">Back up and restore Reliable Services and Reliable Actors</span></span>
<span data-ttu-id="cf9de-104">Azure Service Fabric je vysoká dostupnost platforma, která replikuje stav napříč několika uzly udržovat tento vysokou dostupnost.</span><span class="sxs-lookup"><span data-stu-id="cf9de-104">Azure Service Fabric is a high-availability platform that replicates the state across multiple nodes to maintain this high availability.</span></span>  <span data-ttu-id="cf9de-105">Proto i v případě, že jeden uzel v clusteru selže, služby nadále k dispozici.</span><span class="sxs-lookup"><span data-stu-id="cf9de-105">Thus, even if one node in the cluster fails, the services continue to be available.</span></span> <span data-ttu-id="cf9de-106">Při této redundance v vytvořená poskytované platformou pravděpodobně dostatečná pro některé, v některých případech je žádoucí, aby službu, kterou chcete zálohovat data (na externí úložiště).</span><span class="sxs-lookup"><span data-stu-id="cf9de-106">While this in-built redundancy provided by the platform may be sufficient for some, in certain cases it is desirable for the service to back up data (to an external store).</span></span>

> [!NOTE]
> <span data-ttu-id="cf9de-107">Je důležité používat k zálohování a obnovení dat (a otestovat, že funguje podle očekávání), můžete obnovit z ztrátě dat..</span><span class="sxs-lookup"><span data-stu-id="cf9de-107">It is critical to backup and restore your data (and test that it works as expected) so you can recover from data loss scenarios.</span></span>
> 
> 

<span data-ttu-id="cf9de-108">Služba může například chcete zálohovat data, aby bylo možné chránit z následujících scénářů:</span><span class="sxs-lookup"><span data-stu-id="cf9de-108">For example, a service may want to back up data in order to protect from the following scenarios:</span></span>

- <span data-ttu-id="cf9de-109">V případě trvalé ztrátě celého clusteru Service Fabric.</span><span class="sxs-lookup"><span data-stu-id="cf9de-109">In the event of the permanent loss of an entire Service Fabric cluster.</span></span>
- <span data-ttu-id="cf9de-110">Trvalé ztrátě většiny repliky oddílu služby</span><span class="sxs-lookup"><span data-stu-id="cf9de-110">Permanent loss of a majority of the replicas of a service partition</span></span>
- <span data-ttu-id="cf9de-111">Správce chyby, které stav omylem získá odstranit nebo poškozený.</span><span class="sxs-lookup"><span data-stu-id="cf9de-111">Administrative errors whereby the state accidentally gets deleted or corrupted.</span></span> <span data-ttu-id="cf9de-112">Například to může dojít, pokud správce s dostatečná oprávnění omylem odstraní službu.</span><span class="sxs-lookup"><span data-stu-id="cf9de-112">For example, this may happen if an administrator with sufficient privilege erroneously deletes the service.</span></span>
- <span data-ttu-id="cf9de-113">Chyby v rámci služby, které dojít k poškození dat.</span><span class="sxs-lookup"><span data-stu-id="cf9de-113">Bugs in the service that cause data corruption.</span></span> <span data-ttu-id="cf9de-114">Například tomu může dojít při aktualizace služby kód spustí zápis vadný dat na kolekci spolehlivé.</span><span class="sxs-lookup"><span data-stu-id="cf9de-114">For example, this may happen when a service code upgrade starts writing faulty data to a Reliable Collection.</span></span> <span data-ttu-id="cf9de-115">V takovém případě budou muset kód a data mohou být vrácen do předchozího stavu.</span><span class="sxs-lookup"><span data-stu-id="cf9de-115">In such a case, both the code and the data may have to be reverted to an earlier state.</span></span>
- <span data-ttu-id="cf9de-116">Zpracování dat je offline.</span><span class="sxs-lookup"><span data-stu-id="cf9de-116">Offline data processing.</span></span> <span data-ttu-id="cf9de-117">Může být vhodné používat offline zpracování dat pro business intelligence, který se stane odděleně od služby, který generuje data.</span><span class="sxs-lookup"><span data-stu-id="cf9de-117">It might be convenient to have offline processing of data for business intelligence that happens separately from the service that generates the data.</span></span>

<span data-ttu-id="cf9de-118">Funkce zálohování a obnovení umožňuje službám založený na rozhraní API spolehlivé Services k vytvoření a obnovení zálohy.</span><span class="sxs-lookup"><span data-stu-id="cf9de-118">The Backup/Restore feature allows services built on the Reliable Services API to create and restore backups.</span></span> <span data-ttu-id="cf9de-119">Zálohování rozhraní API poskytované platformou povolit zálohy oddílu služby stavu, bez blokování čtení nebo operace zápisu.</span><span class="sxs-lookup"><span data-stu-id="cf9de-119">The backup APIs provided by the platform allow backup(s) of a service partition's state, without blocking read or write operations.</span></span> <span data-ttu-id="cf9de-120">Obnovení rozhraní API umožňují oddílu služby stav, který má být obnovena ze zálohy, vybrané.</span><span class="sxs-lookup"><span data-stu-id="cf9de-120">The restore APIs allow a service partition's state to be restored from a chosen backup.</span></span>

## <a name="types-of-backup"></a><span data-ttu-id="cf9de-121">Typy zálohování</span><span class="sxs-lookup"><span data-stu-id="cf9de-121">Types of Backup</span></span>
<span data-ttu-id="cf9de-122">Existují dvě možnosti zálohování: úplné a přírůstkové.</span><span class="sxs-lookup"><span data-stu-id="cf9de-122">There are two backup options: Full and Incremental.</span></span>
<span data-ttu-id="cf9de-123">Úplné zálohování je zálohy, která obsahuje všechna data požadovaná k opětovnému vytvoření stavu repliky: kontrolních bodů a všechny záznamy protokolu.</span><span class="sxs-lookup"><span data-stu-id="cf9de-123">A full backup is a backup that contains all the data required to recreate the state of the replica: checkpoints and all log records.</span></span>
<span data-ttu-id="cf9de-124">Protože obsahuje kontrolní body a protokol, úplné zálohování lze obnovit samostatně.</span><span class="sxs-lookup"><span data-stu-id="cf9de-124">Since it has the checkpoints and the log, a full backup can be restored by itself.</span></span>

<span data-ttu-id="cf9de-125">Problém s úplnými zálohami mohou nastat, pokud jsou velké kontrolní body.</span><span class="sxs-lookup"><span data-stu-id="cf9de-125">The problem with full backups arises when the checkpoints are large.</span></span>
<span data-ttu-id="cf9de-126">Repliky, která má 16 GB paměti stavu bude mít například kontrolní body, které přidávají přibližně až 16 GB.</span><span class="sxs-lookup"><span data-stu-id="cf9de-126">For example, a replica that has 16 GB of state will have checkpoints that add up approximately to 16 GB.</span></span>
<span data-ttu-id="cf9de-127">Pokud budeme mít plánovaného bodu obnovení pět minut, replika musí zálohovat každých pět minut.</span><span class="sxs-lookup"><span data-stu-id="cf9de-127">If we have a Recovery Point Objective of five minutes, the replica needs to be backed up every five minutes.</span></span>
<span data-ttu-id="cf9de-128">Pokaždé, když se zálohuje, je nutné zkopírovat 16 GB paměti kontrolní body kromě 50 MB (konfigurovat pomocí `CheckpointThresholdInMB`) za protokolů.</span><span class="sxs-lookup"><span data-stu-id="cf9de-128">Each time it backs up it needs to copy 16 GB of checkpoints in addition to 50 MB (configurable using `CheckpointThresholdInMB`) worth of logs.</span></span>

![Příklad úplného zálohování.](media/service-fabric-reliable-services-backup-restore/FullBackupExample.PNG)

<span data-ttu-id="cf9de-130">Řešení tohoto problému je přírůstkové zálohování, kde zálohování jenom obsahuje záznamy protokolu změněné od posledního zálohování.</span><span class="sxs-lookup"><span data-stu-id="cf9de-130">The solution to this problem is incremental backups, where backup only contains the changed log records since the last backup.</span></span>

![Příklad přírůstkové zálohování.](media/service-fabric-reliable-services-backup-restore/IncrementalBackupExample.PNG)

<span data-ttu-id="cf9de-132">Vzhledem k tomu, že přírůstkové zálohy jsou pouze změny od poslední zálohy (nezahrnuje kontrolní body), budou většinou poměrně rychlejší, ale je nebylo možné obnovit samostatně.</span><span class="sxs-lookup"><span data-stu-id="cf9de-132">Since incremental backups are only changes since the last backup (does not include the checkpoints), they tend to be faster but they cannot be restored on their own.</span></span>
<span data-ttu-id="cf9de-133">Obnovit přírůstkové zálohy, celý řetěz záloh je potřeba.</span><span class="sxs-lookup"><span data-stu-id="cf9de-133">To restore an incremental backup, the entire backup chain is required.</span></span>
<span data-ttu-id="cf9de-134">Řetěz záloh je řetěz záloh počínaje úplnou zálohu a následuje číslo souvislý přírůstkových záloh.</span><span class="sxs-lookup"><span data-stu-id="cf9de-134">A backup chain is a chain of backups starting with a full backup and followed by a number of contiguous incremental backups.</span></span>

## <a name="backup-reliable-services"></a><span data-ttu-id="cf9de-135">Zálohování spolehlivé služby</span><span class="sxs-lookup"><span data-stu-id="cf9de-135">Backup Reliable Services</span></span>
<span data-ttu-id="cf9de-136">Autor služby má plnou kontrolu, kdy vytvořit zálohování a uložení zálohy.</span><span class="sxs-lookup"><span data-stu-id="cf9de-136">The service author has full control of when to make backups and where backups will be stored.</span></span>

<span data-ttu-id="cf9de-137">Pokud chcete spustit zálohování, služba potřebuje k vyvolání funkce zděděného členu `BackupAsync`.</span><span class="sxs-lookup"><span data-stu-id="cf9de-137">To start a backup, the service needs to invoke the inherited member function `BackupAsync`.</span></span>  
<span data-ttu-id="cf9de-138">Zálohování může být vytvořen pouze ze primární repliky a vyžadují stav zápisu udělit oprávnění.</span><span class="sxs-lookup"><span data-stu-id="cf9de-138">Backups can be made only from primary replicas, and they require write status to be granted.</span></span>

<span data-ttu-id="cf9de-139">Jak je uvedeno níže, `BackupAsync` přebírá `BackupDescription` objektu, kde jeden určit úplné nebo přírůstkové zálohování, jakož i funkce zpětného volání, `Func<< BackupInfo, CancellationToken, Task<bool>>>` která je volána, když v zálohovací složce byl vytvořen místně a je připravený k přesunu na některé externí úložiště.</span><span class="sxs-lookup"><span data-stu-id="cf9de-139">As shown below, `BackupAsync` takes in a `BackupDescription` object, where one can specify a full or incremental backup, as well as a callback function, `Func<< BackupInfo, CancellationToken, Task<bool>>>` that is invoked when the backup folder has been created locally and is ready to be moved out to some external storage.</span></span>

```csharp

BackupDescription myBackupDescription = new BackupDescription(backupOption.Incremental,this.BackupCallbackAsync);

await this.BackupAsync(myBackupDescription);

```

<span data-ttu-id="cf9de-140">Žádost o trvat přírůstkové zálohování může selhat s `FabricMissingFullBackupException`.</span><span class="sxs-lookup"><span data-stu-id="cf9de-140">Request to take an incremental backup can fail with `FabricMissingFullBackupException`.</span></span> <span data-ttu-id="cf9de-141">Tato výjimka označuje děje jednu z následujících akcí:</span><span class="sxs-lookup"><span data-stu-id="cf9de-141">This exception indicates that one of the following things is happening:</span></span>

- <span data-ttu-id="cf9de-142">repliky nikdy trvá úplné zálohování, protože již není primární,</span><span class="sxs-lookup"><span data-stu-id="cf9de-142">the replica has never taken a full backup since it has become primary,</span></span>
- <span data-ttu-id="cf9de-143">Některé záznamy protokolu od poslední zálohy byl zkrácen nebo</span><span class="sxs-lookup"><span data-stu-id="cf9de-143">some of the log records since the last backup has been truncated or</span></span>
- <span data-ttu-id="cf9de-144">repliky předán `MaxAccumulatedBackupLogSizeInMB` limit.</span><span class="sxs-lookup"><span data-stu-id="cf9de-144">replica passed the `MaxAccumulatedBackupLogSizeInMB` limit.</span></span>

<span data-ttu-id="cf9de-145">Uživatelé mohou zvýšit pravděpodobnost moci provést přírůstkové zálohování tak, že konfigurace `MinLogSizeInMB` nebo `TruncationThresholdFactor`.</span><span class="sxs-lookup"><span data-stu-id="cf9de-145">Users can increase the likelihood of being able to do incremental backups by configuring `MinLogSizeInMB` or `TruncationThresholdFactor`.</span></span>
<span data-ttu-id="cf9de-146">Všimněte si, že tyto zvýšení hodnoty zvyšuje za využití disku repliky.</span><span class="sxs-lookup"><span data-stu-id="cf9de-146">Note that increasing these values increases the per replica disk usage.</span></span>
<span data-ttu-id="cf9de-147">Další informace najdete v tématu [spolehlivé konfigurace služeb](service-fabric-reliable-services-configuration.md)</span><span class="sxs-lookup"><span data-stu-id="cf9de-147">For more information, see [Reliable Services Configuration](service-fabric-reliable-services-configuration.md)</span></span>

<span data-ttu-id="cf9de-148">`BackupInfo`poskytuje informace o zálohování, včetně umístění složky pro uložení zálohy modulu runtime (`BackupInfo.Directory`).</span><span class="sxs-lookup"><span data-stu-id="cf9de-148">`BackupInfo` provides information regarding the backup, including the location of the folder where the runtime saved the backup (`BackupInfo.Directory`).</span></span> <span data-ttu-id="cf9de-149">Funkce zpětného volání můžete přesunout `BackupInfo.Directory` externím obchodu nebo do jiného umístění.</span><span class="sxs-lookup"><span data-stu-id="cf9de-149">The callback function can move the `BackupInfo.Directory` to an external store or another location.</span></span>  <span data-ttu-id="cf9de-150">Tato funkce také vrací logickou hodnotu, která určuje, zda bylo možné úspěšně přesunout do cílového umístění v zálohovací složce.</span><span class="sxs-lookup"><span data-stu-id="cf9de-150">This function also returns a bool that indicates whether it was able to successfully move the backup folder to its target location.</span></span>

<span data-ttu-id="cf9de-151">Následující kód ukazuje, jak `BackupCallbackAsync` metoda slouží k nahrání zálohování do úložiště Azure:</span><span class="sxs-lookup"><span data-stu-id="cf9de-151">The following code demonstrates how the `BackupCallbackAsync` method can be used to upload the backup to Azure Storage:</span></span>

```csharp
private async Task<bool> BackupCallbackAsync(BackupInfo backupInfo, CancellationToken cancellationToken)
{
    var backupId = Guid.NewGuid();

    await externalBackupStore.UploadBackupFolderAsync(backupInfo.Directory, backupId, cancellationToken);

    return true;
}
```

<span data-ttu-id="cf9de-152">V příkladu předcházející `ExternalBackupStore` je ukázka třída, která se používá k rozhraní s Azure Blob storage a `UploadBackupFolderAsync` je metoda, která komprimaci složce a umístí jej do úložiště objektů Blob v Azure.</span><span class="sxs-lookup"><span data-stu-id="cf9de-152">In the preceeding example, `ExternalBackupStore` is the sample class that is used to interface with Azure Blob storage, and `UploadBackupFolderAsync` is the method that compresses the folder and places it in the Azure Blob store.</span></span>

<span data-ttu-id="cf9de-153">Poznámky:</span><span class="sxs-lookup"><span data-stu-id="cf9de-153">Note that:</span></span>

  - <span data-ttu-id="cf9de-154">Může existovat jenom jedna operace zálohování během letu za repliky v daném okamžiku.</span><span class="sxs-lookup"><span data-stu-id="cf9de-154">There can be only one backup operation in-flight per replica at any given time.</span></span> <span data-ttu-id="cf9de-155">Více než jeden `BackupAsync` volání současně vyvolá výjimku `FabricBackupInProgressException` omezit aktivních pořadových zálohování na jedno.</span><span class="sxs-lookup"><span data-stu-id="cf9de-155">More than one `BackupAsync` call at a time will throw `FabricBackupInProgressException` to limit inflight backups to one.</span></span>
  - <span data-ttu-id="cf9de-156">Pokud repliku převezme v průběhu zálohování, zálohování nemusí byly dokončeny.</span><span class="sxs-lookup"><span data-stu-id="cf9de-156">If a replica fails over while a backup is in progress, the backup may not have been completed.</span></span> <span data-ttu-id="cf9de-157">Po dokončení převzetí z toho důvodu je odpovědnost služby restartujte zálohování vyvoláním `BackupAsync` podle potřeby.</span><span class="sxs-lookup"><span data-stu-id="cf9de-157">Thus, once the failover finishes, it is the service's responsibility to restart the backup by invoking `BackupAsync` as necessary.</span></span>

## <a name="restore-reliable-services"></a><span data-ttu-id="cf9de-158">Obnovení spolehlivé služby</span><span class="sxs-lookup"><span data-stu-id="cf9de-158">Restore Reliable Services</span></span>
<span data-ttu-id="cf9de-159">Obecně platí případech, kdy možná budete muset provést operaci obnovení spadat do jednoho z těchto kategorií:</span><span class="sxs-lookup"><span data-stu-id="cf9de-159">In general, the cases when you might need to perform a restore operation fall into one of these categories:</span></span>

  - <span data-ttu-id="cf9de-160">Služba oddílu ke ztrátě dat..</span><span class="sxs-lookup"><span data-stu-id="cf9de-160">The service partition lost data.</span></span> <span data-ttu-id="cf9de-161">Například získá disku pro dvě ze tří repliky pro oddíl (včetně primární repliky) poškozený nebo vymazat.</span><span class="sxs-lookup"><span data-stu-id="cf9de-161">For example, the disk for two out of three replicas for a partition (including the primary replica) gets corrupted or wiped.</span></span> <span data-ttu-id="cf9de-162">Nový primární možná muset obnovit data ze zálohy.</span><span class="sxs-lookup"><span data-stu-id="cf9de-162">The new primary may need to restore data from a backup.</span></span>
  - <span data-ttu-id="cf9de-163">S celou službou bude ztracena.</span><span class="sxs-lookup"><span data-stu-id="cf9de-163">The entire service is lost.</span></span> <span data-ttu-id="cf9de-164">Například správcem odebere s celou službou a proto služby a data je nutné obnovit.</span><span class="sxs-lookup"><span data-stu-id="cf9de-164">For example, an administrator removes the entire service and thus the service and the data need to be restored.</span></span>
  - <span data-ttu-id="cf9de-165">Služba replikovaných dat poškozené aplikace (např. z důvodu chyb aplikaci).</span><span class="sxs-lookup"><span data-stu-id="cf9de-165">The service replicated corrupt application data (e.g., because of an application bug).</span></span> <span data-ttu-id="cf9de-166">V takovém případě služby je třeba upgradovat nebo vrátit zpět na odebrat příčinu poškození, a -poškození dat musí být obnovena.</span><span class="sxs-lookup"><span data-stu-id="cf9de-166">In this case, the service has to be upgraded or reverted to remove the cause of the corruption, and non-corrupt data has to be restored.</span></span>

<span data-ttu-id="cf9de-167">Zatímco řada přístupů je možné, nabízíme některé příklady použití `RestoreAsync` obnovení z výše uvedených scénářů.</span><span class="sxs-lookup"><span data-stu-id="cf9de-167">While many approaches are possible, we offer some examples on using `RestoreAsync` to recover from the above scenarios.</span></span>

## <a name="partition-data-loss-in-reliable-services"></a><span data-ttu-id="cf9de-168">Oddíl ztrátě dat v spolehlivé služby</span><span class="sxs-lookup"><span data-stu-id="cf9de-168">Partition data loss in Reliable Services</span></span>
<span data-ttu-id="cf9de-169">V takovém případě by modulu runtime automaticky rozpoznat ztrátě dat a vyvolání `OnDataLossAsync` rozhraní API.</span><span class="sxs-lookup"><span data-stu-id="cf9de-169">In this case, the runtime would automatically detect the data loss and invoke the `OnDataLossAsync` API.</span></span>

<span data-ttu-id="cf9de-170">Autor služby musí, proveďte následující kroky k obnovení:</span><span class="sxs-lookup"><span data-stu-id="cf9de-170">The service author needs to perform the following to recover:</span></span>

  - <span data-ttu-id="cf9de-171">Potlačí metodu virtuální základní třídy `OnDataLossAsync`.</span><span class="sxs-lookup"><span data-stu-id="cf9de-171">Override the virtual base class method `OnDataLossAsync`.</span></span>
  - <span data-ttu-id="cf9de-172">Najít poslední zálohy v externích umístění, které obsahuje služby zálohování.</span><span class="sxs-lookup"><span data-stu-id="cf9de-172">Find the latest backup in the external location that contains the service's backups.</span></span>
  - <span data-ttu-id="cf9de-173">Stáhněte si nejnovější zálohu (a dekomprimovat zálohování do zálohovací složky, pokud byla komprimována).</span><span class="sxs-lookup"><span data-stu-id="cf9de-173">Download the latest backup (and uncompress the backup into the backup folder if it was compressed).</span></span>
  - <span data-ttu-id="cf9de-174">`OnDataLossAsync` Poskytuje metody `RestoreContext`.</span><span class="sxs-lookup"><span data-stu-id="cf9de-174">The `OnDataLossAsync` method provides a `RestoreContext`.</span></span> <span data-ttu-id="cf9de-175">Volání `RestoreAsync` rozhraní API na zadaných `RestoreContext`.</span><span class="sxs-lookup"><span data-stu-id="cf9de-175">Call the `RestoreAsync` API on the provided `RestoreContext`.</span></span>
  - <span data-ttu-id="cf9de-176">Vrátí hodnotu PRAVDA, pokud obnovení bylo úspěšné.</span><span class="sxs-lookup"><span data-stu-id="cf9de-176">Return true if the restoration was a success.</span></span>

<span data-ttu-id="cf9de-177">Následuje příklad implementace `OnDataLossAsync` metoda:</span><span class="sxs-lookup"><span data-stu-id="cf9de-177">Following is an example implementation of the `OnDataLossAsync` method:</span></span>

```csharp
protected override async Task<bool> OnDataLossAsync(RestoreContext restoreCtx, CancellationToken cancellationToken)
{
    var backupFolder = await this.externalBackupStore.DownloadLastBackupAsync(cancellationToken);

    var restoreDescription = new RestoreDescription(backupFolder);

    await restoreCtx.RestoreAsync(restoreDescription);

    return true;
}
```

<span data-ttu-id="cf9de-178">`RestoreDescription`předaná do `RestoreContext.RestoreAsync` volání obsahuje člena s názvem `BackupFolderPath`.</span><span class="sxs-lookup"><span data-stu-id="cf9de-178">`RestoreDescription` passed in to the `RestoreContext.RestoreAsync` call contains a member called `BackupFolderPath`.</span></span>
<span data-ttu-id="cf9de-179">Při obnovení jedné úplné zálohování, to `BackupFolderPath` musí být nastavena na místní cestu složky, která obsahuje vaše úplné zálohování.</span><span class="sxs-lookup"><span data-stu-id="cf9de-179">When restoring a single full backup, this `BackupFolderPath` should be set to the local path of the folder that contains your full backup.</span></span>
<span data-ttu-id="cf9de-180">Při obnovování úplnou zálohu a počet přírůstkové zálohování, `BackupFolderPath` musí být nastavena na místní cestu složky, která obsahuje není pouze úplné zálohování, ale také všechny přírůstkové zálohy.</span><span class="sxs-lookup"><span data-stu-id="cf9de-180">When restoring a full backup and a number of incremental backups, `BackupFolderPath` should be set to the local path of the folder that not only contains the full backup, but also all the incremental backups.</span></span>
<span data-ttu-id="cf9de-181">`RestoreAsync`můžete vyvolat volání `FabricMissingFullBackupException` Pokud `BackupFolderPath` zadané neobsahuje úplnou zálohu.</span><span class="sxs-lookup"><span data-stu-id="cf9de-181">`RestoreAsync` call can throw `FabricMissingFullBackupException` if the `BackupFolderPath` provided does not contain a full backup.</span></span>
<span data-ttu-id="cf9de-182">Můžete také vyvolat `ArgumentException` Pokud `BackupFolderPath` má porušený řetězec přírůstkových záloh.</span><span class="sxs-lookup"><span data-stu-id="cf9de-182">It can also throw `ArgumentException` if `BackupFolderPath` has a broken chain of incremental backups.</span></span>
<span data-ttu-id="cf9de-183">Například, pokud obsahuje úplné zálohování první přírůstkové a třetí přírůstkové zálohování, ale ne druhý přírůstkové zálohování.</span><span class="sxs-lookup"><span data-stu-id="cf9de-183">For example, if it contains the full backup, the first incremental and the third incremental backup but no the second incremental backup.</span></span>

> [!NOTE]
> <span data-ttu-id="cf9de-184">Ve výchozím nastavení do bezpečných RestorePolicy.</span><span class="sxs-lookup"><span data-stu-id="cf9de-184">The RestorePolicy is set to Safe by default.</span></span>  <span data-ttu-id="cf9de-185">To znamená, že `RestoreAsync` rozhraní API se nezdaří s ArgumentException – pokud zjistí, že v zálohovací složce obsahuje stavu, který je starší než nebo rovno stavu obsažené v této replice.</span><span class="sxs-lookup"><span data-stu-id="cf9de-185">This means that the `RestoreAsync` API will fail with ArgumentException if it detects that the backup folder contains a state that is older than or equal to the state contained in this replica.</span></span>  <span data-ttu-id="cf9de-186">`RestorePolicy.Force`můžete použít tak, aby přeskočil tuto kontrolu zabezpečení.</span><span class="sxs-lookup"><span data-stu-id="cf9de-186">`RestorePolicy.Force` can be used to skip this safety check.</span></span> <span data-ttu-id="cf9de-187">To je zadaný jako součást `RestoreDescription`.</span><span class="sxs-lookup"><span data-stu-id="cf9de-187">This is specified as part of `RestoreDescription`.</span></span>
> 

## <a name="deleted-or-lost-service"></a><span data-ttu-id="cf9de-188">Odstraněné nebo ke ztrátě služby</span><span class="sxs-lookup"><span data-stu-id="cf9de-188">Deleted or lost service</span></span>
<span data-ttu-id="cf9de-189">Pokud je odebrán služby, musíte nejdřív znovu vytvořit službu předtím, než lze obnovit data.</span><span class="sxs-lookup"><span data-stu-id="cf9de-189">If a service is removed, you must first re-create the service before the data can be restored.</span></span>  <span data-ttu-id="cf9de-190">Je důležité vytvořit službu se stejnou konfigurací, například vytváření oddílů schéma, tak, aby bezproblémově lze obnovit data.</span><span class="sxs-lookup"><span data-stu-id="cf9de-190">It is important to create the service with the same configuration, e.g., partitioning scheme, so that the data can be restored seamlessly.</span></span>  <span data-ttu-id="cf9de-191">Jakmile je služba, rozhraní API k obnovení dat (`OnDataLossAsync` výše) musí být spuštěna v každém oddílu této služby.</span><span class="sxs-lookup"><span data-stu-id="cf9de-191">Once the service is up, the API to restore data (`OnDataLossAsync` above) has to be invoked on every partition of this service.</span></span> <span data-ttu-id="cf9de-192">Jeden ze způsobů dosažení jde pomocí `[FabricClient.TestManagementClient.StartPartitionDataLossAsync](https://msdn.microsoft.com/library/mt693569.aspx)` každý oddíl.</span><span class="sxs-lookup"><span data-stu-id="cf9de-192">One way of achieving this is by using `[FabricClient.TestManagementClient.StartPartitionDataLossAsync](https://msdn.microsoft.com/library/mt693569.aspx)` on every partition.</span></span>  

<span data-ttu-id="cf9de-193">Z tohoto bodu implementace je stejný jako výše uvedené scénáře.</span><span class="sxs-lookup"><span data-stu-id="cf9de-193">From this point, implementation is the same as the above scenario.</span></span> <span data-ttu-id="cf9de-194">Každý oddíl musí obnovit poslední relevantní zálohu z externího úložiště.</span><span class="sxs-lookup"><span data-stu-id="cf9de-194">Each partition needs to restore the latest relevant backup from the external store.</span></span> <span data-ttu-id="cf9de-195">Jeden přímý přístup paměti je, že ID oddílu může mít nyní změněn, vzhledem k tomu, že modul runtime dynamicky vytvoří ID oddílů.</span><span class="sxs-lookup"><span data-stu-id="cf9de-195">One caveat is that the partition ID may have now changed, since the runtime creates partition IDs dynamically.</span></span> <span data-ttu-id="cf9de-196">Proto služba potřebuje k uložení název oddílu příslušné informace a služby k identifikaci správné nejnovější zálohu k obnovení z pro každý oddíl.</span><span class="sxs-lookup"><span data-stu-id="cf9de-196">Thus, the service needs to store the appropriate partition information and service name to identify the correct latest backup to restore from for each partition.</span></span>

> [!NOTE]
> <span data-ttu-id="cf9de-197">Nedoporučuje se používat `FabricClient.ServiceManager.InvokeDataLossAsync` na každý oddíl pro obnovení s celou službou, vzhledem k tomu, které by mohlo poškodit váš stav clusteru.</span><span class="sxs-lookup"><span data-stu-id="cf9de-197">It is not recommended to use `FabricClient.ServiceManager.InvokeDataLossAsync` on each partition to restore the entire service, since that may corrupt your cluster state.</span></span>
> 

## <a name="replication-of-corrupt-application-data"></a><span data-ttu-id="cf9de-198">Replikace dat poškozený aplikací</span><span class="sxs-lookup"><span data-stu-id="cf9de-198">Replication of corrupt application data</span></span>
<span data-ttu-id="cf9de-199">Pokud upgradu nově nasazené aplikace obsahuje chyby, které může způsobit poškození dat.</span><span class="sxs-lookup"><span data-stu-id="cf9de-199">If the newly deployed application upgrade has a bug, that may cause corruption of data.</span></span> <span data-ttu-id="cf9de-200">Upgrade aplikace může například spuštění aktualizace každých telefonní číslo záznam v spolehlivé slovník s neplatný kód oblasti.</span><span class="sxs-lookup"><span data-stu-id="cf9de-200">For example, an application upgrade may start to update every phone number record in a Reliable Dictionary with an invalid area code.</span></span>  <span data-ttu-id="cf9de-201">Neplatnými telefonními čísly v takovém případě bude replikován, protože nemá žádné informace o povaze data, která ukládají Service Fabric.</span><span class="sxs-lookup"><span data-stu-id="cf9de-201">In this case, the invalid phone numbers will be replicated since Service Fabric is not aware of the nature of the data that is being stored.</span></span>

<span data-ttu-id="cf9de-202">První věc udělat po zjištění takové mimořádně závažných chyb, která způsobuje poškození dat je zmrazení služby na úrovni aplikace a pokud je to možné, upgradujte na verzi aplikační kód, který nemá chyb.</span><span class="sxs-lookup"><span data-stu-id="cf9de-202">The first thing to do after you detect such an egregious bug that causes data corruption is to freeze the service at the application level and, if possible, upgrade to the version of the application code that does not have the bug.</span></span>  <span data-ttu-id="cf9de-203">I po kódu služby vyřešen, data mohou být poškozena a proto může třeba obnovit data.</span><span class="sxs-lookup"><span data-stu-id="cf9de-203">However, even after the service code is fixed, the data may still be corrupt and thus data may need to be restored.</span></span>  <span data-ttu-id="cf9de-204">V takových případech nemusí být dostatečná k obnovení poslední zálohu, protože nejnovější zálohy také může být poškozený.</span><span class="sxs-lookup"><span data-stu-id="cf9de-204">In such cases, it may not be sufficient to restore the latest backup, since the latest backups may also be corrupt.</span></span>  <span data-ttu-id="cf9de-205">Proto je nutné nalézt poslední zálohy, která byla vytvořená před tu poškozená data.</span><span class="sxs-lookup"><span data-stu-id="cf9de-205">Thus, you have to find the last backup that was made before the data got corrupted.</span></span>

<span data-ttu-id="cf9de-206">Pokud si nejste jisti, který zálohy jsou poškozené, můžete nasadit do nového clusteru Service Fabric a obnovit zálohy ovlivněných oddílů stejně jako výše "Odstraněno nebo ke ztrátě služby" scénář.</span><span class="sxs-lookup"><span data-stu-id="cf9de-206">If you are not sure which backups are corrupt, you could deploy a new Service Fabric cluster and restore the backups of affected partitions just like the above "Deleted or lost service" scenario.</span></span>  <span data-ttu-id="cf9de-207">Pro každý oddíl spuštění obnovení zálohování z nejnovější na nejmenší.</span><span class="sxs-lookup"><span data-stu-id="cf9de-207">For each partition, start restoring the backups from the most recent to the least.</span></span> <span data-ttu-id="cf9de-208">Po nalezení zálohy, která nemá poškození přesunutí nebo odstranění tohoto oddílu všechny zálohy, které byly novější (než zálohování).</span><span class="sxs-lookup"><span data-stu-id="cf9de-208">Once you find a backup that does not have the corruption, move/delete all backups of this partition that were more recent (than that backup).</span></span> <span data-ttu-id="cf9de-209">Tento postup opakujte pro každý oddíl.</span><span class="sxs-lookup"><span data-stu-id="cf9de-209">Repeat this process for each partition.</span></span> <span data-ttu-id="cf9de-210">Teď, když `OnDataLossAsync` je volána v oddílu v clusteru výroby, bude poslední zálohy v externím úložišti nalezen jeden zachyceny proces výše.</span><span class="sxs-lookup"><span data-stu-id="cf9de-210">Now, when `OnDataLossAsync` is called on the partition in the production cluster, the last backup found in the external store will be the one picked by the above process.</span></span>

<span data-ttu-id="cf9de-211">Nyní, kroky v "odstraněno nebo ke ztrátě služby" části lze použít k obnovení stavu služby stavu, než kód buggy poškozený stav.</span><span class="sxs-lookup"><span data-stu-id="cf9de-211">Now, the steps in the "Deleted or lost service" section can be used to restore the state of the service to the state before the buggy code corrupted the state.</span></span>

<span data-ttu-id="cf9de-212">Poznámky:</span><span class="sxs-lookup"><span data-stu-id="cf9de-212">Note that:</span></span>

  - <span data-ttu-id="cf9de-213">Při obnovování, je pravděpodobné, že obnovení ze zálohy je starší než stav oddílu, než data bylo ztraceno.</span><span class="sxs-lookup"><span data-stu-id="cf9de-213">When you restore, there is a chance that the backup being restored is older than the state of the partition before the data was lost.</span></span> <span data-ttu-id="cf9de-214">Z toho důvodu obnovíte pouze jako poslední možnost obnovit jako množství dat nejdříve.</span><span class="sxs-lookup"><span data-stu-id="cf9de-214">Because of this, you should restore only as a last resort to recover as much data as possible.</span></span>
  - <span data-ttu-id="cf9de-215">Řetězec, který představuje cestu ke složce pro zálohování a cest souborů ve složce pro zálohování může být větší než 255 znaků, v závislosti na cesta k adresáři FabricDataRoot a délka názvu typu aplikace.</span><span class="sxs-lookup"><span data-stu-id="cf9de-215">The string that represents the backup folder path and the paths of files inside the backup folder can be greater than 255 characters, depending on the FabricDataRoot path and Application Type name's length.</span></span> <span data-ttu-id="cf9de-216">To může způsobit některé metody rozhraní .NET, jako je třeba `Directory.Move`, má být vyvolána `PathTooLongException` výjimky.</span><span class="sxs-lookup"><span data-stu-id="cf9de-216">This can cause some .NET methods, like `Directory.Move`, to throw the `PathTooLongException` exception.</span></span> <span data-ttu-id="cf9de-217">Jeden řešení je přímo volat rozhraní API kernel32, jako je `CopyFile`.</span><span class="sxs-lookup"><span data-stu-id="cf9de-217">One workaround is to directly call kernel32 APIs, like `CopyFile`.</span></span>

## <a name="backup-and-restore-reliable-actors"></a><span data-ttu-id="cf9de-218">Zálohování a obnovení Reliable Actors</span><span class="sxs-lookup"><span data-stu-id="cf9de-218">Backup and restore Reliable Actors</span></span>


<span data-ttu-id="cf9de-219">Spolehlivé Framework aktéři je postavená na spolehlivé služby.</span><span class="sxs-lookup"><span data-stu-id="cf9de-219">Reliable Actors Framework is built on top of Reliable Services.</span></span> <span data-ttu-id="cf9de-220">ActorService, který hostuje actor(s) je stavová služba spolehlivé.</span><span class="sxs-lookup"><span data-stu-id="cf9de-220">The ActorService which hosts the actor(s) is a stateful reliable service.</span></span> <span data-ttu-id="cf9de-221">Všechny zálohování a obnovení funkce dostupné v spolehlivé služby je proto také k dispozici pro Reliable Actors (s výjimkou chování, které jsou specifické pro zprostředkovatele stavu).</span><span class="sxs-lookup"><span data-stu-id="cf9de-221">Hence, all the backup and restore functionality available in Reliable Services is also available to Reliable Actors (except behaviors that are state provider specific).</span></span> <span data-ttu-id="cf9de-222">Vzhledem k tomu, že zálohování budete přesměrováni na bázi oddílů, se stavy pro všechny účastníky v, že se bude zálohovat oddílu (a obnovení je podobný a proběhne na bázi oddílů).</span><span class="sxs-lookup"><span data-stu-id="cf9de-222">Since backups will be taken on a per-partition basis, states for all actors in that partition will be backed up (and restoration is similar and will happen on a per-partition basis).</span></span> <span data-ttu-id="cf9de-223">K provedení zálohování a obnovení, by měl vytvořit vlastní objektu actor služby třídu odvozenou od třídy ActorService a potom proveďte vlastník služby zálohování nebo obnovení podobná spolehlivé služby, jak je popsáno výše v předchozích částech.</span><span class="sxs-lookup"><span data-stu-id="cf9de-223">To perform backup/restore, the service owner should create a custom actor service class that derives from ActorService class and then do backup/restore similar to Reliable Services as described above in previous sections.</span></span>

```csharp
class MyCustomActorService : ActorService
{
     public MyCustomActorService(StatefulServiceContext context, ActorTypeInformation actorTypeInfo)
            : base(context, actorTypeInfo)
     {                  
     }
    
    //
   // Method overrides and other code.
    //
}
```

<span data-ttu-id="cf9de-224">Když vytváříte třídu služby objektu actor vlastní, budete muset zaregistrovat, a při registraci objektu actor.</span><span class="sxs-lookup"><span data-stu-id="cf9de-224">When you create a custom actor service class, you need to register that as well when registering the actor.</span></span>

```csharp
ActorRuntime.RegisterActorAsync<MyActor>(
   (context, typeInfo) => new MyCustomActorService(context, typeInfo)).GetAwaiter().GetResult();
```

<span data-ttu-id="cf9de-225">Výchozí zprostředkovatel stavu Reliable actors je `KvsActorStateProvider`.</span><span class="sxs-lookup"><span data-stu-id="cf9de-225">The default state provider for Reliable Actors is `KvsActorStateProvider`.</span></span> <span data-ttu-id="cf9de-226">Přírůstkové zálohování není povoleno ve výchozím nastavení pro `KvsActorStateProvider`.</span><span class="sxs-lookup"><span data-stu-id="cf9de-226">Incremental backup is not enabled by default for `KvsActorStateProvider`.</span></span> <span data-ttu-id="cf9de-227">Přírůstkové zálohování můžete povolit vytvořením `KvsActorStateProvider` s příslušná nastavení v jeho konstruktoru a předejte jí ActorService konstruktoru, jak je znázorněno v následující fragment kódu:</span><span class="sxs-lookup"><span data-stu-id="cf9de-227">You can enable incremental backup by creating `KvsActorStateProvider` with the appropriate setting in its constructor and then passing it to ActorService constructor as shown in following code snippet:</span></span>

```csharp
class MyCustomActorService : ActorService
{
     public MyCustomActorService(StatefulServiceContext context, ActorTypeInformation actorTypeInfo)
            : base(context, actorTypeInfo, null, null, new KvsActorStateProvider(true)) // Enable incremental backup
     {                  
     }
    
    //
   // Method overrides and other code.
    //
}
```

<span data-ttu-id="cf9de-228">Po přírůstkové zálohování, trvá přírůstkové zálohování může selhat s FabricMissingFullBackupException pro jednu z následujících důvodů a budete muset provést úplné zálohy před provedením přírůstkové zálohy:</span><span class="sxs-lookup"><span data-stu-id="cf9de-228">After incremental backup has been enabled, taking an incremental backup can fail with FabricMissingFullBackupException for one of following reasons and you will need to take a full backup before taking incremental backup(s):</span></span>

  - <span data-ttu-id="cf9de-229">Replika nikdy trvá úplné zálohování, vzhledem k tomu, že jsou primární.</span><span class="sxs-lookup"><span data-stu-id="cf9de-229">The replica has never taken a full backup since it became primary.</span></span>
  - <span data-ttu-id="cf9de-230">Některé záznamy protokolu bylo zkráceno od poslední zálohy.</span><span class="sxs-lookup"><span data-stu-id="cf9de-230">Some of the log records were truncated since last backup was taken.</span></span>

<span data-ttu-id="cf9de-231">Pokud je povoleno přírůstkové zálohování, `KvsActorStateProvider` nepoužívá ke správě svoje záznamy protokolu cyklické vyrovnávací paměti a pravidelně se zkrátí.</span><span class="sxs-lookup"><span data-stu-id="cf9de-231">When incremental backup is enabled, `KvsActorStateProvider` does not use circular buffer to manage its log records and periodically truncates it.</span></span> <span data-ttu-id="cf9de-232">Pokud nedojde k žádné zálohování uživatelem po dobu 45 minut, systém automaticky zkrátí záznamy protokolu.</span><span class="sxs-lookup"><span data-stu-id="cf9de-232">If no backup is taken by user for a period of 45 minutes, the system automatically truncates the log records.</span></span> <span data-ttu-id="cf9de-233">Tento interval můžete nakonfigurovat tak, že zadáte `logTrunctationIntervalInMinutes` v `KvsActorStateProvider` konstruktoru (podobně jako při povolování přírůstkové zálohování).</span><span class="sxs-lookup"><span data-stu-id="cf9de-233">This interval can be configured by specifying `logTrunctationIntervalInMinutes` in `KvsActorStateProvider` constructor (similar to when enabling incremental backup).</span></span> <span data-ttu-id="cf9de-234">Záznamy protokolu může získat také zkrácen, pokud primární repliky potřebujete k vytvoření jiné repliky odesláním všechna jeho data.</span><span class="sxs-lookup"><span data-stu-id="cf9de-234">The log records may also get truncated if primary replica need to build another replica by sending all its data.</span></span>

<span data-ttu-id="cf9de-235">Při provádění obnovení ze zálohy řetěz, spolehlivé služby, podobně jako BackupFolderPath by měl obsahovat podadresářů pomocí jednoho podadresáři obsahující úplnou zálohu a ostatní podadresáře obsahující přírůstkové zálohy.</span><span class="sxs-lookup"><span data-stu-id="cf9de-235">When doing restore from a backup chain, similar to Reliable Services, the BackupFolderPath should contain subdirectories with one subdirectory containing full backup and others subdirectories containing incremental backup(s).</span></span> <span data-ttu-id="cf9de-236">Rozhraní API obnovení vyvolá výjimku FabricException se příslušná chybová zpráva, pokud selže ověření řetěz záloh.</span><span class="sxs-lookup"><span data-stu-id="cf9de-236">The restore API will throw FabricException with appropriate error message if the backup chain validation fails.</span></span> 

> [!NOTE]
> <span data-ttu-id="cf9de-237">`KvsActorStateProvider`možnost RestorePolicy.Safe aktuálně ignoruje.</span><span class="sxs-lookup"><span data-stu-id="cf9de-237">`KvsActorStateProvider` currently ignores the option RestorePolicy.Safe.</span></span> <span data-ttu-id="cf9de-238">Podpora pro tuto funkci je plánované v nadcházející verzi.</span><span class="sxs-lookup"><span data-stu-id="cf9de-238">Support for this feature is planned in an upcoming release.</span></span>
> 

## <a name="testing-backup-and-restore"></a><span data-ttu-id="cf9de-239">Testování zálohování a obnovení</span><span class="sxs-lookup"><span data-stu-id="cf9de-239">Testing Backup and Restore</span></span>
<span data-ttu-id="cf9de-240">Je důležité zajistit, že se záloha důležitých dat a lze obnovit z.</span><span class="sxs-lookup"><span data-stu-id="cf9de-240">It is important to ensure that critical data is being backed up, and can be restored from.</span></span> <span data-ttu-id="cf9de-241">To lze provést vyvoláním `Start-ServiceFabricPartitionDataLoss` rutiny v prostředí PowerShell, které může způsobit ztrátu dat v konkrétní oddílu k ověření, zda data zálohování a obnovení funkce pro vaše služba funguje podle očekávání.</span><span class="sxs-lookup"><span data-stu-id="cf9de-241">This can be done by invoking the `Start-ServiceFabricPartitionDataLoss` cmdlet in PowerShell that can induce data loss in a particular partition to test whether the data backup and restore functionality for your service is working as expected.</span></span>  <span data-ttu-id="cf9de-242">Také je možné programově vyvolání ztrátě dat a obnovit ze také tuto událost.</span><span class="sxs-lookup"><span data-stu-id="cf9de-242">It is also possible to programmatically invoke data loss and restore from that event as well.</span></span>

> [!NOTE]
> <span data-ttu-id="cf9de-243">Můžete najít na ukázkové implementace zálohování a obnovení funkce ve webové aplikaci odkaz na Githubu.</span><span class="sxs-lookup"><span data-stu-id="cf9de-243">You can find a sample implementation of backup and restore functionality in the Web Reference App on GitHub.</span></span> <span data-ttu-id="cf9de-244">Podívejte se prosím na `Inventory.Service` služby další podrobnosti.</span><span class="sxs-lookup"><span data-stu-id="cf9de-244">Please look at the `Inventory.Service` service for more details.</span></span>
> 
> 

## <a name="under-the-hood-more-details-on-backup-and-restore"></a><span data-ttu-id="cf9de-245">Pod pokličkou: Další informace o zálohování a obnovení</span><span class="sxs-lookup"><span data-stu-id="cf9de-245">Under the hood: more details on backup and restore</span></span>
<span data-ttu-id="cf9de-246">Zde je některé další informace o zálohování a obnovení.</span><span class="sxs-lookup"><span data-stu-id="cf9de-246">Here's some more details on backup and restore.</span></span>

### <a name="backup"></a><span data-ttu-id="cf9de-247">Zálohování</span><span class="sxs-lookup"><span data-stu-id="cf9de-247">Backup</span></span>
<span data-ttu-id="cf9de-248">Správce spolehlivé stavu poskytuje možnost vytvořit konzistentní zálohování bez blokování všech pro čtení nebo zápisu operace.</span><span class="sxs-lookup"><span data-stu-id="cf9de-248">The Reliable State Manager provides the ability to create consistent backups without blocking any read or write operations.</span></span> <span data-ttu-id="cf9de-249">Uděláte to tak ho využívá mechanismus trvalosti kontrolního bodu a protokolu.</span><span class="sxs-lookup"><span data-stu-id="cf9de-249">To do so, it utilizes a checkpoint and log persistence mechanism.</span></span>  <span data-ttu-id="cf9de-250">Správce spolehlivé stavu trvá přibližné (lightweight) kontrolní body v určitých bodech snížit zatížení z protokol transakcí a vylepšovat dobu obnovení.</span><span class="sxs-lookup"><span data-stu-id="cf9de-250">The Reliable State Manager takes fuzzy (lightweight) checkpoints at certain points to relieve pressure from the transactional log and improve recovery times.</span></span>  <span data-ttu-id="cf9de-251">Když `BackupAsync` je volána, spolehlivé správce stavu dá pokyn všechny objekty spolehlivé kopírovat jejich nejnovější soubory kontrolního bodu do místní složky zálohování.</span><span class="sxs-lookup"><span data-stu-id="cf9de-251">When `BackupAsync` is called, the Reliable State Manager instructs all Reliable objects to copy their latest checkpoint files to a local backup folder.</span></span>  <span data-ttu-id="cf9de-252">Spolehlivé správce stavu pak zkopíruje všechny záznamy protokolu od ukazatele"počáteční" nejnovější záznam protokolu do zálohovací složky.</span><span class="sxs-lookup"><span data-stu-id="cf9de-252">Then, the Reliable State Manager copies all log records, starting from the "start pointer" to the latest log record into the backup folder.</span></span>  <span data-ttu-id="cf9de-253">Vzhledem k tomu, že všechny záznamy protokolu až nejnovější záznam protokolu jsou zahrnuté do zálohy a spolehlivé správce stavu zachovává předběžné protokolování, spolehlivé správce stavu zaručuje, že jsou všechny transakce, potvrzeny (`CommitAsync` úspěšně vrátila) jsou zahrnuté do zálohy.</span><span class="sxs-lookup"><span data-stu-id="cf9de-253">Since all the log records up to the latest log record are included in the backup and the Reliable State Manager preserves write-ahead logging, the Reliable State Manager guarantees that all transactions that are committed (`CommitAsync` has returned successfully) are included in the backup.</span></span>

<span data-ttu-id="cf9de-254">Jakékoli transakce, která provádí po `BackupAsync` byla volána může nebo nemusí být v záloze.</span><span class="sxs-lookup"><span data-stu-id="cf9de-254">Any transaction that commits after `BackupAsync` has been called may or may not be in the backup.</span></span>  <span data-ttu-id="cf9de-255">Jakmile místní složce pro zálohování naplněné platformou (tj, místní bylo zálohování dokončeno modulem runtime), je vyvolána zálohování zpětného volání služby.</span><span class="sxs-lookup"><span data-stu-id="cf9de-255">Once the local backup folder has been populated by the platform (i.e., local backup is completed by the runtime), the service's backup callback is invoked.</span></span>  <span data-ttu-id="cf9de-256">Tato zpětné volání je zodpovědná za přesunutí v zálohovací složce do externího umístění například Azure Storage.</span><span class="sxs-lookup"><span data-stu-id="cf9de-256">This callback is responsible for moving the backup folder to an external location such as Azure Storage.</span></span>

### <a name="restore"></a><span data-ttu-id="cf9de-257">Obnovení</span><span class="sxs-lookup"><span data-stu-id="cf9de-257">Restore</span></span>
<span data-ttu-id="cf9de-258">Správce spolehlivé stavu poskytuje možnost obnovení ze zálohy pomocí `RestoreAsync` rozhraní API.</span><span class="sxs-lookup"><span data-stu-id="cf9de-258">The Reliable State Manager provides the ability to restore from a backup by using the `RestoreAsync` API.</span></span>  
<span data-ttu-id="cf9de-259">`RestoreAsync` Metodu `RestoreContext` lze volat pouze uvnitř `OnDataLossAsync` metoda.</span><span class="sxs-lookup"><span data-stu-id="cf9de-259">The `RestoreAsync` method on `RestoreContext` can be called only inside the `OnDataLossAsync` method.</span></span>
<span data-ttu-id="cf9de-260">Bool vrácený `OnDataLossAsync` označuje, zda se služba obnovit stav z externího zdroje.</span><span class="sxs-lookup"><span data-stu-id="cf9de-260">The bool returned by `OnDataLossAsync` indicates whether the service restored its state from an external source.</span></span>
<span data-ttu-id="cf9de-261">Pokud `OnDataLossAsync` vrátí hodnotu true, Service Fabric se znovu vytvořit všechny ostatní repliky z tomuto primárnímu.</span><span class="sxs-lookup"><span data-stu-id="cf9de-261">If the `OnDataLossAsync` returns true, Service Fabric will rebuild all other replicas from this primary.</span></span> <span data-ttu-id="cf9de-262">Service Fabric zajišťuje, že repliky, které obdrží `OnDataLossAsync` volání první přechod do primární role, ale nejsou uděleno číst stav nebo zapisovat stav.</span><span class="sxs-lookup"><span data-stu-id="cf9de-262">Service Fabric ensures that replicas that will receive `OnDataLossAsync` call first transition to the primary role but are not granted read status or write status.</span></span>
<span data-ttu-id="cf9de-263">To vyplývá, že pro implementátory StatefulService `RunAsync` dokud nebude volána `OnDataLossAsync` úspěšně dokončí.</span><span class="sxs-lookup"><span data-stu-id="cf9de-263">This implies that for StatefulService implementers, `RunAsync` will not be called until `OnDataLossAsync` finishes successfully.</span></span>
<span data-ttu-id="cf9de-264">Potom `OnDataLossAsync` bude volána pro nový primární.</span><span class="sxs-lookup"><span data-stu-id="cf9de-264">Then, `OnDataLossAsync` will be invoked on the new primary.</span></span>
<span data-ttu-id="cf9de-265">Dokud služby dokončí toto rozhraní API úspěšně (vrací hodnotu true nebo false) a dokončí příslušné změny konfigurace, rozhraní API bude udržovat volána po jednom.</span><span class="sxs-lookup"><span data-stu-id="cf9de-265">Until a service completes this API successfully (by returning true or false) and finishes the relevant reconfiguration, the API will keep being called one at a time.</span></span>

<span data-ttu-id="cf9de-266">`RestoreAsync`nejprve zahodí všechny existující stav v primární replice, která byla volána na.</span><span class="sxs-lookup"><span data-stu-id="cf9de-266">`RestoreAsync` first drops all existing state in the primary replica that it was called on.</span></span>  
<span data-ttu-id="cf9de-267">Spolehlivé správce stavu vytvoří spolehlivé objekty, které existují ve složce zálohy.</span><span class="sxs-lookup"><span data-stu-id="cf9de-267">Then the Reliable State Manager creates all the Reliable objects that exist in the backup folder.</span></span>  
<span data-ttu-id="cf9de-268">Dále jsou spolehlivé objekty pokyn k obnovení z jejich kontrolní body ve složce pro zálohování.</span><span class="sxs-lookup"><span data-stu-id="cf9de-268">Next, the Reliable objects are instructed to restore from their checkpoints in the backup folder.</span></span>  
<span data-ttu-id="cf9de-269">Nakonec spolehlivé správce stavu obnoví vlastní stavu ze záznamů protokolu ve složce pro zálohování a provede obnovení.</span><span class="sxs-lookup"><span data-stu-id="cf9de-269">Finally, the Reliable State Manager recovers its own state from the log records in the backup folder and performs recovery.</span></span>  
<span data-ttu-id="cf9de-270">Jako součást procesu obnovení operace od "výchozí bod", které mají potvrzení záznamů protokolu ve složce zálohování se přehraje na virtuálním pevném spolehlivé objekty.</span><span class="sxs-lookup"><span data-stu-id="cf9de-270">As part of the recovery process, operations starting from the "starting point" that have commit log records in the backup folder are replayed to the Reliable objects.</span></span>  
<span data-ttu-id="cf9de-271">Tento krok zajistí, že obnovené stav je konzistentní.</span><span class="sxs-lookup"><span data-stu-id="cf9de-271">This step ensures that the recovered state is consistent.</span></span>

## <a name="next-steps"></a><span data-ttu-id="cf9de-272">Další kroky</span><span class="sxs-lookup"><span data-stu-id="cf9de-272">Next steps</span></span>
  - [<span data-ttu-id="cf9de-273">Reliable Collections</span><span class="sxs-lookup"><span data-stu-id="cf9de-273">Reliable Collections</span></span>](service-fabric-work-with-reliable-collections.md)
  - [<span data-ttu-id="cf9de-274">Spolehlivé služby rychlý start</span><span class="sxs-lookup"><span data-stu-id="cf9de-274">Reliable Services quick start</span></span>](service-fabric-reliable-services-quick-start.md)
  - [<span data-ttu-id="cf9de-275">Spolehlivé služby oznámení</span><span class="sxs-lookup"><span data-stu-id="cf9de-275">Reliable Services notifications</span></span>](service-fabric-reliable-services-notifications.md)
  - [<span data-ttu-id="cf9de-276">Spolehlivé služby konfigurace</span><span class="sxs-lookup"><span data-stu-id="cf9de-276">Reliable Services configuration</span></span>](service-fabric-reliable-services-configuration.md)
  - [<span data-ttu-id="cf9de-277">Referenční informace pro vývojáře pro spolehlivé kolekce</span><span class="sxs-lookup"><span data-stu-id="cf9de-277">Developer reference for Reliable Collections</span></span>](https://msdn.microsoft.com/library/azure/microsoft.servicefabric.data.collections.aspx)

