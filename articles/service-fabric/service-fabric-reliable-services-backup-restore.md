---
title: "aaaService prostředků infrastruktury zálohování a obnovení | Microsoft Docs"
description: "Rámcová dokumentace pro Service Fabric zálohování a obnovení"
services: service-fabric
documentationcenter: .net
author: mcoskun
manager: timlt
editor: subramar,jessebenson
ms.assetid: 91ea6ca4-cc2a-4155-9823-dcbd0b996349
ms.service: service-fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 08/18/2017
ms.author: mcoskun
ms.openlocfilehash: e502b59c84999c3fe825167383f00a5ebd70c9b5
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 10/06/2017
---
# <a name="back-up-and-restore-reliable-services-and-reliable-actors"></a><span data-ttu-id="ba143-103">Zálohování a obnovení Reliable Services a Reliable Actors</span><span class="sxs-lookup"><span data-stu-id="ba143-103">Back up and restore Reliable Services and Reliable Actors</span></span>
<span data-ttu-id="ba143-104">Azure Service Fabric je vysoká dostupnost platforma, která replikuje hello stavu napříč několika uzly toomaintain tento vysokou dostupnost.</span><span class="sxs-lookup"><span data-stu-id="ba143-104">Azure Service Fabric is a high-availability platform that replicates hello state across multiple nodes toomaintain this high availability.</span></span>  <span data-ttu-id="ba143-105">Proto i v případě, že jeden uzel v clusteru hello selže, pokračovat hello služby toobe k dispozici.</span><span class="sxs-lookup"><span data-stu-id="ba143-105">Thus, even if one node in hello cluster fails, hello services continue toobe available.</span></span> <span data-ttu-id="ba143-106">Při této redundance v vytvořená poskytované hello platformy pravděpodobně dostatečná pro některé, v některých případech je žádoucí, aby služba tooback hello dat (tooan externí úložiště).</span><span class="sxs-lookup"><span data-stu-id="ba143-106">While this in-built redundancy provided by hello platform may be sufficient for some, in certain cases it is desirable for hello service tooback up data (tooan external store).</span></span>

> [!NOTE]
> <span data-ttu-id="ba143-107">Je důležité toobackup a obnovení dat (a test, který funguje podle očekávání), můžete obnovit z ztrátě dat..</span><span class="sxs-lookup"><span data-stu-id="ba143-107">It is critical toobackup and restore your data (and test that it works as expected) so you can recover from data loss scenarios.</span></span>
> 
> 

<span data-ttu-id="ba143-108">Služba může například, tooback data v pořadí tooprotect z hello následující scénáře:</span><span class="sxs-lookup"><span data-stu-id="ba143-108">For example, a service may want tooback up data in order tooprotect from hello following scenarios:</span></span>

- <span data-ttu-id="ba143-109">V případě hello hello trvalé dojít ke ztrátě celého clusteru Service Fabric.</span><span class="sxs-lookup"><span data-stu-id="ba143-109">In hello event of hello permanent loss of an entire Service Fabric cluster.</span></span>
- <span data-ttu-id="ba143-110">Trvalé ztrátě většiny hello repliky oddílu služby</span><span class="sxs-lookup"><span data-stu-id="ba143-110">Permanent loss of a majority of hello replicas of a service partition</span></span>
- <span data-ttu-id="ba143-111">Správce chyby, které hello stavu omylem získá odstranit nebo poškozený.</span><span class="sxs-lookup"><span data-stu-id="ba143-111">Administrative errors whereby hello state accidentally gets deleted or corrupted.</span></span> <span data-ttu-id="ba143-112">Například to může dojít, pokud správce s dostatečná oprávnění omylem odstraní hello služby.</span><span class="sxs-lookup"><span data-stu-id="ba143-112">For example, this may happen if an administrator with sufficient privilege erroneously deletes hello service.</span></span>
- <span data-ttu-id="ba143-113">Chyby v hello služby, které dojít k poškození dat.</span><span class="sxs-lookup"><span data-stu-id="ba143-113">Bugs in hello service that cause data corruption.</span></span> <span data-ttu-id="ba143-114">Například tomu může dojít při aktualizace služby kód spustí zápis vadný data tooa spolehlivé kolekce.</span><span class="sxs-lookup"><span data-stu-id="ba143-114">For example, this may happen when a service code upgrade starts writing faulty data tooa Reliable Collection.</span></span> <span data-ttu-id="ba143-115">V takovém případě obě hello kódu a hello dat může mít toobe vrátit tooan dříve stavu.</span><span class="sxs-lookup"><span data-stu-id="ba143-115">In such a case, both hello code and hello data may have toobe reverted tooan earlier state.</span></span>
- <span data-ttu-id="ba143-116">Zpracování dat je offline.</span><span class="sxs-lookup"><span data-stu-id="ba143-116">Offline data processing.</span></span> <span data-ttu-id="ba143-117">Může být vhodné toohave offline zpracování dat pro business intelligence, který se stane samostatně z hello služby, která generuje hello data.</span><span class="sxs-lookup"><span data-stu-id="ba143-117">It might be convenient toohave offline processing of data for business intelligence that happens separately from hello service that generates hello data.</span></span>

<span data-ttu-id="ba143-118">Funkce zálohování a obnovení Hello umožňuje službám založený na hello spolehlivé rozhraní API služby toocreate a obnovení zálohy.</span><span class="sxs-lookup"><span data-stu-id="ba143-118">hello Backup/Restore feature allows services built on hello Reliable Services API toocreate and restore backups.</span></span> <span data-ttu-id="ba143-119">Hello zálohování rozhraní API poskytované hello platformy umožňují zálohy oddílu služby stavu, bez blokování čtení nebo operace zápisu.</span><span class="sxs-lookup"><span data-stu-id="ba143-119">hello backup APIs provided by hello platform allow backup(s) of a service partition's state, without blocking read or write operations.</span></span> <span data-ttu-id="ba143-120">obnovení Hello rozhraní API umožňují toobe stavu oddílu služba obnovena ze zálohy, vybrané.</span><span class="sxs-lookup"><span data-stu-id="ba143-120">hello restore APIs allow a service partition's state toobe restored from a chosen backup.</span></span>

## <a name="types-of-backup"></a><span data-ttu-id="ba143-121">Typy zálohování</span><span class="sxs-lookup"><span data-stu-id="ba143-121">Types of Backup</span></span>
<span data-ttu-id="ba143-122">Existují dvě možnosti zálohování: úplné a přírůstkové.</span><span class="sxs-lookup"><span data-stu-id="ba143-122">There are two backup options: Full and Incremental.</span></span>
<span data-ttu-id="ba143-123">Úplné zálohování je zálohy, která obsahuje všechny hello data požadovaná toorecreate hello stavu repliky hello: kontrolních bodů a všechny záznamy protokolu.</span><span class="sxs-lookup"><span data-stu-id="ba143-123">A full backup is a backup that contains all hello data required toorecreate hello state of hello replica: checkpoints and all log records.</span></span>
<span data-ttu-id="ba143-124">Vzhledem k tomu, že má hello kontrolních bodů a hello protokolu, úplné zálohování lze obnovit samostatně.</span><span class="sxs-lookup"><span data-stu-id="ba143-124">Since it has hello checkpoints and hello log, a full backup can be restored by itself.</span></span>

<span data-ttu-id="ba143-125">Hello problém s úplnými zálohami mohou nastat, pokud jsou velké hello kontrolní body.</span><span class="sxs-lookup"><span data-stu-id="ba143-125">hello problem with full backups arises when hello checkpoints are large.</span></span>
<span data-ttu-id="ba143-126">Například repliky, která má 16 GB paměti stavu bude mít kontrolní body, které dohromady přibližně too16 GB.</span><span class="sxs-lookup"><span data-stu-id="ba143-126">For example, a replica that has 16 GB of state will have checkpoints that add up approximately too16 GB.</span></span>
<span data-ttu-id="ba143-127">Pokud budeme mít plánovaného bodu obnovení pět minut, je potřeba hello repliky toobe zálohovat každých pět minut.</span><span class="sxs-lookup"><span data-stu-id="ba143-127">If we have a Recovery Point Objective of five minutes, hello replica needs toobe backed up every five minutes.</span></span>
<span data-ttu-id="ba143-128">Pokaždé, když se zálohuje, je nutné toocopy 16 GB paměti kontrolní body kromě too50 MB (konfigurovat pomocí `CheckpointThresholdInMB`) za protokolů.</span><span class="sxs-lookup"><span data-stu-id="ba143-128">Each time it backs up it needs toocopy 16 GB of checkpoints in addition too50 MB (configurable using `CheckpointThresholdInMB`) worth of logs.</span></span>

![Příklad úplného zálohování.](media/service-fabric-reliable-services-backup-restore/FullBackupExample.PNG)

<span data-ttu-id="ba143-130">Hello řešení toothis problém je přírůstkové zálohování, kde záloha pouze obsahuje záznamy protokolu hello změnit od poslední zálohy hello.</span><span class="sxs-lookup"><span data-stu-id="ba143-130">hello solution toothis problem is incremental backups, where backup only contains hello changed log records since hello last backup.</span></span>

![Příklad přírůstkové zálohování.](media/service-fabric-reliable-services-backup-restore/IncrementalBackupExample.PNG)

<span data-ttu-id="ba143-132">Vzhledem k tomu, že přírůstkové zálohy jsou pouze změny od poslední zálohy hello (nezahrnuje kontrolní body hello), se zpravidla toobe rychleji, ale je nebylo možné obnovit samostatně.</span><span class="sxs-lookup"><span data-stu-id="ba143-132">Since incremental backups are only changes since hello last backup (does not include hello checkpoints), they tend toobe faster but they cannot be restored on their own.</span></span>
<span data-ttu-id="ba143-133">toorestore přírůstkové zálohy, hello celý řetěz záloh je povinný.</span><span class="sxs-lookup"><span data-stu-id="ba143-133">toorestore an incremental backup, hello entire backup chain is required.</span></span>
<span data-ttu-id="ba143-134">Řetěz záloh je řetěz záloh počínaje úplnou zálohu a následuje číslo souvislý přírůstkových záloh.</span><span class="sxs-lookup"><span data-stu-id="ba143-134">A backup chain is a chain of backups starting with a full backup and followed by a number of contiguous incremental backups.</span></span>

## <a name="backup-reliable-services"></a><span data-ttu-id="ba143-135">Zálohování spolehlivé služby</span><span class="sxs-lookup"><span data-stu-id="ba143-135">Backup Reliable Services</span></span>
<span data-ttu-id="ba143-136">Hello služby Autor má plnou kontrolu nad tím, kdy toomake zálohování a uložení zálohy.</span><span class="sxs-lookup"><span data-stu-id="ba143-136">hello service author has full control of when toomake backups and where backups will be stored.</span></span>

<span data-ttu-id="ba143-137">toostart zálohu, služba hello musí tooinvoke hello zděděná – členská funkce `BackupAsync`.</span><span class="sxs-lookup"><span data-stu-id="ba143-137">toostart a backup, hello service needs tooinvoke hello inherited member function `BackupAsync`.</span></span>  
<span data-ttu-id="ba143-138">Zálohování může být vytvořen pouze ze primární repliky a vyžadují toobe stav zápisu udělena.</span><span class="sxs-lookup"><span data-stu-id="ba143-138">Backups can be made only from primary replicas, and they require write status toobe granted.</span></span>

<span data-ttu-id="ba143-139">Jak je uvedeno níže, `BackupAsync` přebírá `BackupDescription` objektu, kde jeden určit úplné nebo přírůstkové zálohování, jakož i funkce zpětného volání, `Func<< BackupInfo, CancellationToken, Task<bool>>>` která je volána, když místně byla vytvořena hello zálohovací složky a je připravený toobe přesunout na toosome externí úložiště.</span><span class="sxs-lookup"><span data-stu-id="ba143-139">As shown below, `BackupAsync` takes in a `BackupDescription` object, where one can specify a full or incremental backup, as well as a callback function, `Func<< BackupInfo, CancellationToken, Task<bool>>>` that is invoked when hello backup folder has been created locally and is ready toobe moved out toosome external storage.</span></span>

```csharp

BackupDescription myBackupDescription = new BackupDescription(backupOption.Incremental,this.BackupCallbackAsync);

await this.BackupAsync(myBackupDescription);

```

<span data-ttu-id="ba143-140">Žádost o tootake přírůstkové zálohování může selhat s `FabricMissingFullBackupException`.</span><span class="sxs-lookup"><span data-stu-id="ba143-140">Request tootake an incremental backup can fail with `FabricMissingFullBackupException`.</span></span> <span data-ttu-id="ba143-141">Tato výjimka označuje, že jeden z následujících věcí hello probíhá:</span><span class="sxs-lookup"><span data-stu-id="ba143-141">This exception indicates that one of hello following things is happening:</span></span>

- <span data-ttu-id="ba143-142">Hello repliky nikdy trvá úplné zálohování, protože již není primární,</span><span class="sxs-lookup"><span data-stu-id="ba143-142">hello replica has never taken a full backup since it has become primary,</span></span>
- <span data-ttu-id="ba143-143">Některé hello protokolování záznamů, protože hello poslední zálohy byl zkrácen nebo</span><span class="sxs-lookup"><span data-stu-id="ba143-143">some of hello log records since hello last backup has been truncated or</span></span>
- <span data-ttu-id="ba143-144">repliky předán hello `MaxAccumulatedBackupLogSizeInMB` limit.</span><span class="sxs-lookup"><span data-stu-id="ba143-144">replica passed hello `MaxAccumulatedBackupLogSizeInMB` limit.</span></span>

<span data-ttu-id="ba143-145">Uživatele můžete zvýšit pravděpodobnost hello je možné toodo přírůstkové zálohování nakonfigurováním `MinLogSizeInMB` nebo `TruncationThresholdFactor`.</span><span class="sxs-lookup"><span data-stu-id="ba143-145">Users can increase hello likelihood of being able toodo incremental backups by configuring `MinLogSizeInMB` or `TruncationThresholdFactor`.</span></span>
<span data-ttu-id="ba143-146">Všimněte si, že tyto hodnoty zvýšení zvyšuje hello za využití disku repliky.</span><span class="sxs-lookup"><span data-stu-id="ba143-146">Note that increasing these values increases hello per replica disk usage.</span></span>
<span data-ttu-id="ba143-147">Další informace najdete v tématu [spolehlivé konfigurace služeb](service-fabric-reliable-services-configuration.md)</span><span class="sxs-lookup"><span data-stu-id="ba143-147">For more information, see [Reliable Services Configuration](service-fabric-reliable-services-configuration.md)</span></span>

<span data-ttu-id="ba143-148">`BackupInfo`poskytuje informace o zálohování hello, včetně umístění hello hello složky pro uložení zálohy hello hello runtime (`BackupInfo.Directory`).</span><span class="sxs-lookup"><span data-stu-id="ba143-148">`BackupInfo` provides information regarding hello backup, including hello location of hello folder where hello runtime saved hello backup (`BackupInfo.Directory`).</span></span> <span data-ttu-id="ba143-149">Funkce zpětného volání Hello můžete přesunout hello `BackupInfo.Directory` tooan externím obchodu nebo v jiném umístění.</span><span class="sxs-lookup"><span data-stu-id="ba143-149">hello callback function can move hello `BackupInfo.Directory` tooan external store or another location.</span></span>  <span data-ttu-id="ba143-150">Tato funkce také vrací logickou hodnotu, která určuje, zda bylo možné toosuccessfully přesunutí hello zálohovací složky tooits cílové umístění.</span><span class="sxs-lookup"><span data-stu-id="ba143-150">This function also returns a bool that indicates whether it was able toosuccessfully move hello backup folder tooits target location.</span></span>

<span data-ttu-id="ba143-151">Hello následující kód ukazuje, jak hello `BackupCallbackAsync` metoda může být použité tooupload hello zálohování tooAzure úložiště:</span><span class="sxs-lookup"><span data-stu-id="ba143-151">hello following code demonstrates how hello `BackupCallbackAsync` method can be used tooupload hello backup tooAzure Storage:</span></span>

```csharp
private async Task<bool> BackupCallbackAsync(BackupInfo backupInfo, CancellationToken cancellationToken)
{
    var backupId = Guid.NewGuid();

    await externalBackupStore.UploadBackupFolderAsync(backupInfo.Directory, backupId, cancellationToken);

    return true;
}
```

<span data-ttu-id="ba143-152">V příkladu předcházející hello `ExternalBackupStore` je hello ukázka třída, která je použité toointerface s Azure Blob storage a `UploadBackupFolderAsync` je metoda hello komprimaci hello složky a umístí jej do úložiště objektů Blob v Azure hello.</span><span class="sxs-lookup"><span data-stu-id="ba143-152">In hello preceeding example, `ExternalBackupStore` is hello sample class that is used toointerface with Azure Blob storage, and `UploadBackupFolderAsync` is hello method that compresses hello folder and places it in hello Azure Blob store.</span></span>

<span data-ttu-id="ba143-153">Poznámky:</span><span class="sxs-lookup"><span data-stu-id="ba143-153">Note that:</span></span>

  - <span data-ttu-id="ba143-154">Může existovat jenom jedna operace zálohování během letu za repliky v daném okamžiku.</span><span class="sxs-lookup"><span data-stu-id="ba143-154">There can be only one backup operation in-flight per replica at any given time.</span></span> <span data-ttu-id="ba143-155">Více než jeden `BackupAsync` volání současně vyvolá výjimku `FabricBackupInProgressException` toolimit aktivních pořadových zálohování tooone.</span><span class="sxs-lookup"><span data-stu-id="ba143-155">More than one `BackupAsync` call at a time will throw `FabricBackupInProgressException` toolimit inflight backups tooone.</span></span>
  - <span data-ttu-id="ba143-156">Pokud repliku převezme v průběhu zálohování, zálohování hello nemusí byly dokončeny.</span><span class="sxs-lookup"><span data-stu-id="ba143-156">If a replica fails over while a backup is in progress, hello backup may not have been completed.</span></span> <span data-ttu-id="ba143-157">Po dokončení převzetí služeb při selhání hello z toho důvodu je služba hello odpovědnost toorestart hello zálohování vyvoláním `BackupAsync` podle potřeby.</span><span class="sxs-lookup"><span data-stu-id="ba143-157">Thus, once hello failover finishes, it is hello service's responsibility toorestart hello backup by invoking `BackupAsync` as necessary.</span></span>

## <a name="restore-reliable-services"></a><span data-ttu-id="ba143-158">Obnovení spolehlivé služby</span><span class="sxs-lookup"><span data-stu-id="ba143-158">Restore Reliable Services</span></span>
<span data-ttu-id="ba143-159">Obecně platí hello případech, kdy může být nutné tooperform operace obnovení spadat do jednoho z těchto kategorií:</span><span class="sxs-lookup"><span data-stu-id="ba143-159">In general, hello cases when you might need tooperform a restore operation fall into one of these categories:</span></span>

  - <span data-ttu-id="ba143-160">Služba Hello oddílu ke ztrátě dat..</span><span class="sxs-lookup"><span data-stu-id="ba143-160">hello service partition lost data.</span></span> <span data-ttu-id="ba143-161">Například získá hello disku pro dvě ze tří repliky pro oddíl (včetně primární repliky hello) poškozený nebo vymazat.</span><span class="sxs-lookup"><span data-stu-id="ba143-161">For example, hello disk for two out of three replicas for a partition (including hello primary replica) gets corrupted or wiped.</span></span> <span data-ttu-id="ba143-162">nový primární Hello může být nutné toorestore data ze zálohy.</span><span class="sxs-lookup"><span data-stu-id="ba143-162">hello new primary may need toorestore data from a backup.</span></span>
  - <span data-ttu-id="ba143-163">dojde ke ztrátě Hello celé služby.</span><span class="sxs-lookup"><span data-stu-id="ba143-163">hello entire service is lost.</span></span> <span data-ttu-id="ba143-164">Například správce odebere hello celou službou, a proto hello služby a hello data potřebovat toobe obnovit.</span><span class="sxs-lookup"><span data-stu-id="ba143-164">For example, an administrator removes hello entire service and thus hello service and hello data need toobe restored.</span></span>
  - <span data-ttu-id="ba143-165">Služba Hello replikovaných dat poškozené aplikace (např. z důvodu chyb aplikaci).</span><span class="sxs-lookup"><span data-stu-id="ba143-165">hello service replicated corrupt application data (e.g., because of an application bug).</span></span> <span data-ttu-id="ba143-166">V takovém případě hello služby má toobe upgradovat nebo vrácený tooremove hello příčinu hello poškození a -poškození dat toobe obnovit.</span><span class="sxs-lookup"><span data-stu-id="ba143-166">In this case, hello service has toobe upgraded or reverted tooremove hello cause of hello corruption, and non-corrupt data has toobe restored.</span></span>

<span data-ttu-id="ba143-167">Zatímco řada přístupů je možné, nabízíme některé příklady použití `RestoreAsync` toorecover z hello výše scénáře.</span><span class="sxs-lookup"><span data-stu-id="ba143-167">While many approaches are possible, we offer some examples on using `RestoreAsync` toorecover from hello above scenarios.</span></span>

## <a name="partition-data-loss-in-reliable-services"></a><span data-ttu-id="ba143-168">Oddíl ztrátě dat v spolehlivé služby</span><span class="sxs-lookup"><span data-stu-id="ba143-168">Partition data loss in Reliable Services</span></span>
<span data-ttu-id="ba143-169">V takovém případě by hello runtime automaticky rozpoznat hello ztrátě dat a vyvolání hello `OnDataLossAsync` rozhraní API.</span><span class="sxs-lookup"><span data-stu-id="ba143-169">In this case, hello runtime would automatically detect hello data loss and invoke hello `OnDataLossAsync` API.</span></span>

<span data-ttu-id="ba143-170">Autor služby Hello musí tooperform hello toorecover následující:</span><span class="sxs-lookup"><span data-stu-id="ba143-170">hello service author needs tooperform hello following toorecover:</span></span>

  - <span data-ttu-id="ba143-171">Potlačí metodu virtuální třídy base hello `OnDataLossAsync`.</span><span class="sxs-lookup"><span data-stu-id="ba143-171">Override hello virtual base class method `OnDataLossAsync`.</span></span>
  - <span data-ttu-id="ba143-172">Najde hello nejnovější zálohy hello externích umístění, které obsahuje hello služby zálohování.</span><span class="sxs-lookup"><span data-stu-id="ba143-172">Find hello latest backup in hello external location that contains hello service's backups.</span></span>
  - <span data-ttu-id="ba143-173">Stáhněte nejnovější zálohu hello (a dekomprimovat hello zálohování do zálohovací složky hello, pokud byla komprimována).</span><span class="sxs-lookup"><span data-stu-id="ba143-173">Download hello latest backup (and uncompress hello backup into hello backup folder if it was compressed).</span></span>
  - <span data-ttu-id="ba143-174">Hello `OnDataLossAsync` poskytuje metody `RestoreContext`.</span><span class="sxs-lookup"><span data-stu-id="ba143-174">hello `OnDataLossAsync` method provides a `RestoreContext`.</span></span> <span data-ttu-id="ba143-175">Volání hello `RestoreAsync` rozhraní API hello poskytuje `RestoreContext`.</span><span class="sxs-lookup"><span data-stu-id="ba143-175">Call hello `RestoreAsync` API on hello provided `RestoreContext`.</span></span>
  - <span data-ttu-id="ba143-176">Vrátí hodnotu PRAVDA, pokud hello obnovení bylo úspěšné.</span><span class="sxs-lookup"><span data-stu-id="ba143-176">Return true if hello restoration was a success.</span></span>

<span data-ttu-id="ba143-177">Následuje příklad implementace hello `OnDataLossAsync` metoda:</span><span class="sxs-lookup"><span data-stu-id="ba143-177">Following is an example implementation of hello `OnDataLossAsync` method:</span></span>

```csharp
protected override async Task<bool> OnDataLossAsync(RestoreContext restoreCtx, CancellationToken cancellationToken)
{
    var backupFolder = await this.externalBackupStore.DownloadLastBackupAsync(cancellationToken);

    var restoreDescription = new RestoreDescription(backupFolder);

    await restoreCtx.RestoreAsync(restoreDescription);

    return true;
}
```

<span data-ttu-id="ba143-178">`RestoreDescription`Předaná toohello `RestoreContext.RestoreAsync` volání obsahuje člena s názvem `BackupFolderPath`.</span><span class="sxs-lookup"><span data-stu-id="ba143-178">`RestoreDescription` passed in toohello `RestoreContext.RestoreAsync` call contains a member called `BackupFolderPath`.</span></span>
<span data-ttu-id="ba143-179">Při obnovení jedné úplné zálohování, to `BackupFolderPath` by mělo být nastavené toohello místní cesty hello složku, která obsahuje vaše úplné zálohování.</span><span class="sxs-lookup"><span data-stu-id="ba143-179">When restoring a single full backup, this `BackupFolderPath` should be set toohello local path of hello folder that contains your full backup.</span></span>
<span data-ttu-id="ba143-180">Při obnovování úplnou zálohu a počet přírůstkové zálohování, `BackupFolderPath` by mělo být nastavené toohello místní cesty hello složku, ne jenom obsahující hello úplné zálohování, ale také všechny hello přírůstkové zálohy.</span><span class="sxs-lookup"><span data-stu-id="ba143-180">When restoring a full backup and a number of incremental backups, `BackupFolderPath` should be set toohello local path of hello folder that not only contains hello full backup, but also all hello incremental backups.</span></span>
<span data-ttu-id="ba143-181">`RestoreAsync`můžete vyvolat volání `FabricMissingFullBackupException` Pokud hello `BackupFolderPath` zadané neobsahuje úplnou zálohu.</span><span class="sxs-lookup"><span data-stu-id="ba143-181">`RestoreAsync` call can throw `FabricMissingFullBackupException` if hello `BackupFolderPath` provided does not contain a full backup.</span></span>
<span data-ttu-id="ba143-182">Můžete také vyvolat `ArgumentException` Pokud `BackupFolderPath` má porušený řetězec přírůstkových záloh.</span><span class="sxs-lookup"><span data-stu-id="ba143-182">It can also throw `ArgumentException` if `BackupFolderPath` has a broken chain of incremental backups.</span></span>
<span data-ttu-id="ba143-183">Například pokud obsahuje hello úplného zálohování, první hello přírůstkové a hello třetí přírůstkové zálohování, ale žádné hello druhý přírůstkové zálohování.</span><span class="sxs-lookup"><span data-stu-id="ba143-183">For example, if it contains hello full backup, hello first incremental and hello third incremental backup but no hello second incremental backup.</span></span>

> [!NOTE]
> <span data-ttu-id="ba143-184">Hello RestorePolicy ve výchozím nastavení tooSafe.</span><span class="sxs-lookup"><span data-stu-id="ba143-184">hello RestorePolicy is set tooSafe by default.</span></span>  <span data-ttu-id="ba143-185">To znamená, že hello `RestoreAsync` rozhraní API se nezdaří s ArgumentException – pokud zjistí, že hello zálohování složka obsahuje stavu, který je starší než nebo rovna toohello stavu obsažené v této replice.</span><span class="sxs-lookup"><span data-stu-id="ba143-185">This means that hello `RestoreAsync` API will fail with ArgumentException if it detects that hello backup folder contains a state that is older than or equal toohello state contained in this replica.</span></span>  <span data-ttu-id="ba143-186">`RestorePolicy.Force`lze použít tooskip této kontroly zabezpečení.</span><span class="sxs-lookup"><span data-stu-id="ba143-186">`RestorePolicy.Force` can be used tooskip this safety check.</span></span> <span data-ttu-id="ba143-187">To je zadaný jako součást `RestoreDescription`.</span><span class="sxs-lookup"><span data-stu-id="ba143-187">This is specified as part of `RestoreDescription`.</span></span>
> 

## <a name="deleted-or-lost-service"></a><span data-ttu-id="ba143-188">Odstraněné nebo ke ztrátě služby</span><span class="sxs-lookup"><span data-stu-id="ba143-188">Deleted or lost service</span></span>
<span data-ttu-id="ba143-189">Pokud je odebrán služby, musíte nejdřív znovu vytvořit hello služby před hello je možné obnovit.</span><span class="sxs-lookup"><span data-stu-id="ba143-189">If a service is removed, you must first re-create hello service before hello data can be restored.</span></span>  <span data-ttu-id="ba143-190">Je důležité toocreate hello služby s hello stejnou konfiguraci, například vytváření oddílů schéma, které hello dat může být obnovena bezproblémově.</span><span class="sxs-lookup"><span data-stu-id="ba143-190">It is important toocreate hello service with hello same configuration, e.g., partitioning scheme, so that hello data can be restored seamlessly.</span></span>  <span data-ttu-id="ba143-191">Jakmile je služba hello, hello data toorestore rozhraní API (`OnDataLossAsync` výše) má toobe vyvolat každý oddíl této služby.</span><span class="sxs-lookup"><span data-stu-id="ba143-191">Once hello service is up, hello API toorestore data (`OnDataLossAsync` above) has toobe invoked on every partition of this service.</span></span> <span data-ttu-id="ba143-192">Jeden ze způsobů dosažení jde pomocí `[FabricClient.TestManagementClient.StartPartitionDataLossAsync](https://msdn.microsoft.com/library/mt693569.aspx)` každý oddíl.</span><span class="sxs-lookup"><span data-stu-id="ba143-192">One way of achieving this is by using `[FabricClient.TestManagementClient.StartPartitionDataLossAsync](https://msdn.microsoft.com/library/mt693569.aspx)` on every partition.</span></span>  

<span data-ttu-id="ba143-193">Z tohoto bodu je hello implementace stejné jako hello výše scénář.</span><span class="sxs-lookup"><span data-stu-id="ba143-193">From this point, implementation is hello same as hello above scenario.</span></span> <span data-ttu-id="ba143-194">Každý oddíl musí toorestore hello nejnovější relevantní zálohování z externího úložiště hello.</span><span class="sxs-lookup"><span data-stu-id="ba143-194">Each partition needs toorestore hello latest relevant backup from hello external store.</span></span> <span data-ttu-id="ba143-195">Jeden přímý přístup paměti je ID může mít nyní změnit, protože hello runtime dynamicky vytvoří oddílu ID oddílu hello.</span><span class="sxs-lookup"><span data-stu-id="ba143-195">One caveat is that hello partition ID may have now changed, since hello runtime creates partition IDs dynamically.</span></span> <span data-ttu-id="ba143-196">Proto služba hello musí toostore hello oddílu příslušné informace a služby název tooidentify hello správné nejnovější zálohy toorestore z pro každý oddíl.</span><span class="sxs-lookup"><span data-stu-id="ba143-196">Thus, hello service needs toostore hello appropriate partition information and service name tooidentify hello correct latest backup toorestore from for each partition.</span></span>

> [!NOTE]
> <span data-ttu-id="ba143-197">Není doporučeno toouse `FabricClient.ServiceManager.InvokeDataLossAsync` na každý oddíl toorestore hello celou službou, vzhledem k tomu, které by mohlo poškodit váš stav clusteru.</span><span class="sxs-lookup"><span data-stu-id="ba143-197">It is not recommended toouse `FabricClient.ServiceManager.InvokeDataLossAsync` on each partition toorestore hello entire service, since that may corrupt your cluster state.</span></span>
> 

## <a name="replication-of-corrupt-application-data"></a><span data-ttu-id="ba143-198">Replikace dat poškozený aplikací</span><span class="sxs-lookup"><span data-stu-id="ba143-198">Replication of corrupt application data</span></span>
<span data-ttu-id="ba143-199">Pokud upgradu hello nově nasazené aplikace obsahuje chyby, které může způsobit poškození dat.</span><span class="sxs-lookup"><span data-stu-id="ba143-199">If hello newly deployed application upgrade has a bug, that may cause corruption of data.</span></span> <span data-ttu-id="ba143-200">Například upgradu aplikace může spustit tooupdate každý záznam telefonní číslo v slovník spolehlivé s neplatný kód oblasti.</span><span class="sxs-lookup"><span data-stu-id="ba143-200">For example, an application upgrade may start tooupdate every phone number record in a Reliable Dictionary with an invalid area code.</span></span>  <span data-ttu-id="ba143-201">V takovém případě hello neplatnými telefonními čísly bude replikován vzhledem k tomu, že Service Fabric nemá informace o povaze hello hello data, která ukládají.</span><span class="sxs-lookup"><span data-stu-id="ba143-201">In this case, hello invalid phone numbers will be replicated since Service Fabric is not aware of hello nature of hello data that is being stored.</span></span>

<span data-ttu-id="ba143-202">Hello nejprve thing toodo po zjištění takové mimořádně závažných chyb, která způsobuje poškození dat je toofreeze hello služby na úrovni aplikace hello a, pokud je to možné, upgradujte verzi toohello hello aplikační kód, který nemá hello chyb.</span><span class="sxs-lookup"><span data-stu-id="ba143-202">hello first thing toodo after you detect such an egregious bug that causes data corruption is toofreeze hello service at hello application level and, if possible, upgrade toohello version of hello application code that does not have hello bug.</span></span>  <span data-ttu-id="ba143-203">I po opravení kódu služby hello hello dat může být poškozena a proto dat může být nutné toobe obnovit.</span><span class="sxs-lookup"><span data-stu-id="ba143-203">However, even after hello service code is fixed, hello data may still be corrupt and thus data may need toobe restored.</span></span>  <span data-ttu-id="ba143-204">V takových případech nemusí být dostatečná toorestore hello nejnovější zálohu, protože nejnovější zálohy hello také může být poškozený.</span><span class="sxs-lookup"><span data-stu-id="ba143-204">In such cases, it may not be sufficient toorestore hello latest backup, since hello latest backups may also be corrupt.</span></span>  <span data-ttu-id="ba143-205">Proto, že máte hello toofind poslední se zálohy, která byla vytvořená před hello data získali poškozená.</span><span class="sxs-lookup"><span data-stu-id="ba143-205">Thus, you have toofind hello last backup that was made before hello data got corrupted.</span></span>

<span data-ttu-id="ba143-206">Pokud si nejste jisti, který zálohy jsou poškozené, můžete nasadit do nového clusteru Service Fabric a obnovit zálohy hello ovlivněných oddílů stejně jako hello výše "Odstraněno nebo ke ztrátě služby" scénář.</span><span class="sxs-lookup"><span data-stu-id="ba143-206">If you are not sure which backups are corrupt, you could deploy a new Service Fabric cluster and restore hello backups of affected partitions just like hello above "Deleted or lost service" scenario.</span></span>  <span data-ttu-id="ba143-207">Pro každý oddíl spustíte obnovení záloh hello z nejnovější toohello hello alespoň.</span><span class="sxs-lookup"><span data-stu-id="ba143-207">For each partition, start restoring hello backups from hello most recent toohello least.</span></span> <span data-ttu-id="ba143-208">Po nalezení zálohy, která nemá hello poškození přesunutí nebo odstranění tohoto oddílu všechny zálohy, které byly novější (než zálohování).</span><span class="sxs-lookup"><span data-stu-id="ba143-208">Once you find a backup that does not have hello corruption, move/delete all backups of this partition that were more recent (than that backup).</span></span> <span data-ttu-id="ba143-209">Tento postup opakujte pro každý oddíl.</span><span class="sxs-lookup"><span data-stu-id="ba143-209">Repeat this process for each partition.</span></span> <span data-ttu-id="ba143-210">Teď, když `OnDataLossAsync` je volána v oddílu hello v hello provozní cluster, poslední zálohy hello nalezen v hello externí úložiště bude hello jeden zachyceny hello výše procesu.</span><span class="sxs-lookup"><span data-stu-id="ba143-210">Now, when `OnDataLossAsync` is called on hello partition in hello production cluster, hello last backup found in hello external store will be hello one picked by hello above process.</span></span>

<span data-ttu-id="ba143-211">Nyní hello kroky hello "Odstraněno nebo ke ztrátě služby" části lze využít toorestore hello stavu hello služby toohello stavu, než buggy kód hello poškozen hello stavu.</span><span class="sxs-lookup"><span data-stu-id="ba143-211">Now, hello steps in hello "Deleted or lost service" section can be used toorestore hello state of hello service toohello state before hello buggy code corrupted hello state.</span></span>

<span data-ttu-id="ba143-212">Poznámky:</span><span class="sxs-lookup"><span data-stu-id="ba143-212">Note that:</span></span>

  - <span data-ttu-id="ba143-213">Při obnovování, se pravděpodobnost, že hello zálohování obnovit není starší než hello stavu hello oddílu před hello data byla ztracena.</span><span class="sxs-lookup"><span data-stu-id="ba143-213">When you restore, there is a chance that hello backup being restored is older than hello state of hello partition before hello data was lost.</span></span> <span data-ttu-id="ba143-214">Z toho důvodu obnovíte pouze jako poslední možnost toorecover jako množství dat nejdříve.</span><span class="sxs-lookup"><span data-stu-id="ba143-214">Because of this, you should restore only as a last resort toorecover as much data as possible.</span></span>
  - <span data-ttu-id="ba143-215">řetězec, který představuje cestu ke složce zálohování hello Hello a hello cest souborů do zálohovací složky hello může být větší než 255 znaků, v závislosti na hello proměnná FabricDataRoot cestu a název typu aplikace délka.</span><span class="sxs-lookup"><span data-stu-id="ba143-215">hello string that represents hello backup folder path and hello paths of files inside hello backup folder can be greater than 255 characters, depending on hello FabricDataRoot path and Application Type name's length.</span></span> <span data-ttu-id="ba143-216">To může způsobit některé metody rozhraní .NET, jako je třeba `Directory.Move`, toothrow hello `PathTooLongException` výjimka.</span><span class="sxs-lookup"><span data-stu-id="ba143-216">This can cause some .NET methods, like `Directory.Move`, toothrow hello `PathTooLongException` exception.</span></span> <span data-ttu-id="ba143-217">Jeden řešení je toodirectly volání rozhraní API kernel32, jako je `CopyFile`.</span><span class="sxs-lookup"><span data-stu-id="ba143-217">One workaround is toodirectly call kernel32 APIs, like `CopyFile`.</span></span>

## <a name="backup-and-restore-reliable-actors"></a><span data-ttu-id="ba143-218">Zálohování a obnovení Reliable Actors</span><span class="sxs-lookup"><span data-stu-id="ba143-218">Backup and restore Reliable Actors</span></span>


<span data-ttu-id="ba143-219">Spolehlivé Framework aktéři je postavená na spolehlivé služby.</span><span class="sxs-lookup"><span data-stu-id="ba143-219">Reliable Actors Framework is built on top of Reliable Services.</span></span> <span data-ttu-id="ba143-220">Hello ActorService, který hostuje hello actor(s) je stavová služba spolehlivé.</span><span class="sxs-lookup"><span data-stu-id="ba143-220">hello ActorService which hosts hello actor(s) is a stateful reliable service.</span></span> <span data-ttu-id="ba143-221">Proto všechny hello zálohování a obnovení funkce je k dispozici v spolehlivé služby je také k dispozici tooReliable aktéři (s výjimkou chování, které jsou specifické pro zprostředkovatele stavu).</span><span class="sxs-lookup"><span data-stu-id="ba143-221">Hence, all hello backup and restore functionality available in Reliable Services is also available tooReliable Actors (except behaviors that are state provider specific).</span></span> <span data-ttu-id="ba143-222">Vzhledem k tomu, že zálohování budete přesměrováni na bázi oddílů, se stavy pro všechny účastníky v, že se bude zálohovat oddílu (a obnovení je podobný a proběhne na bázi oddílů).</span><span class="sxs-lookup"><span data-stu-id="ba143-222">Since backups will be taken on a per-partition basis, states for all actors in that partition will be backed up (and restoration is similar and will happen on a per-partition basis).</span></span> <span data-ttu-id="ba143-223">tooperform zálohování a obnovení, vlastník služby hello měli vytvořit vlastní objektu actor služby třídu odvozenou od třídy ActorService a pak zálohování nebo obnovení podobné tooReliable služby, jak je popsáno výše v předchozích částech.</span><span class="sxs-lookup"><span data-stu-id="ba143-223">tooperform backup/restore, hello service owner should create a custom actor service class that derives from ActorService class and then do backup/restore similar tooReliable Services as described above in previous sections.</span></span>

```csharp
class MyCustomActorService : ActorService
{
     public MyCustomActorService(StatefulServiceContext context, ActorTypeInformation actorTypeInfo)
            : base(context, actorTypeInfo)
     {                  
     }
    
    //
   // Method overrides and other code.
    //
}
```

<span data-ttu-id="ba143-224">Když vytváříte třídu služby objektu actor vlastní, musíte to také tooregister při registraci objektu actor hello.</span><span class="sxs-lookup"><span data-stu-id="ba143-224">When you create a custom actor service class, you need tooregister that as well when registering hello actor.</span></span>

```csharp
ActorRuntime.RegisterActorAsync<MyActor>(
   (context, typeInfo) => new MyCustomActorService(context, typeInfo)).GetAwaiter().GetResult();
```

<span data-ttu-id="ba143-225">poskytovatel stavu výchozí Hello Reliable actors je `KvsActorStateProvider`.</span><span class="sxs-lookup"><span data-stu-id="ba143-225">hello default state provider for Reliable Actors is `KvsActorStateProvider`.</span></span> <span data-ttu-id="ba143-226">Přírůstkové zálohování není povoleno ve výchozím nastavení pro `KvsActorStateProvider`.</span><span class="sxs-lookup"><span data-stu-id="ba143-226">Incremental backup is not enabled by default for `KvsActorStateProvider`.</span></span> <span data-ttu-id="ba143-227">Přírůstkové zálohování můžete povolit vytvořením `KvsActorStateProvider` s hello příslušným nastavení v jeho konstruktoru a předejte jí tooActorService konstruktor, jak je znázorněno v následující fragment kódu:</span><span class="sxs-lookup"><span data-stu-id="ba143-227">You can enable incremental backup by creating `KvsActorStateProvider` with hello appropriate setting in its constructor and then passing it tooActorService constructor as shown in following code snippet:</span></span>

```csharp
class MyCustomActorService : ActorService
{
     public MyCustomActorService(StatefulServiceContext context, ActorTypeInformation actorTypeInfo)
            : base(context, actorTypeInfo, null, null, new KvsActorStateProvider(true)) // Enable incremental backup
     {                  
     }
    
    //
   // Method overrides and other code.
    //
}
```

<span data-ttu-id="ba143-228">Po přírůstkové zálohování, trvá přírůstkové zálohování může selhat s FabricMissingFullBackupException pro jednu z následujících důvodů a budete potřebovat tootake úplné zálohy před provedením přírůstkové zálohy:</span><span class="sxs-lookup"><span data-stu-id="ba143-228">After incremental backup has been enabled, taking an incremental backup can fail with FabricMissingFullBackupException for one of following reasons and you will need tootake a full backup before taking incremental backup(s):</span></span>

  - <span data-ttu-id="ba143-229">repliky Hello nikdy trvá úplné zálohování, vzhledem k tomu, že jsou primární.</span><span class="sxs-lookup"><span data-stu-id="ba143-229">hello replica has never taken a full backup since it became primary.</span></span>
  - <span data-ttu-id="ba143-230">Některé záznamy protokolu hello bylo zkráceno od poslední zálohy.</span><span class="sxs-lookup"><span data-stu-id="ba143-230">Some of hello log records were truncated since last backup was taken.</span></span>

<span data-ttu-id="ba143-231">Pokud je povoleno přírůstkové zálohování, `KvsActorStateProvider` nepoužívá cyklické vyrovnávací paměti toomanage protokol zaznamenává a pravidelně se zkrátí.</span><span class="sxs-lookup"><span data-stu-id="ba143-231">When incremental backup is enabled, `KvsActorStateProvider` does not use circular buffer toomanage its log records and periodically truncates it.</span></span> <span data-ttu-id="ba143-232">Pokud nedojde k žádné zálohování uživatelem po dobu 45 minut, zkrátí hello systému automaticky hello záznamy protokolu.</span><span class="sxs-lookup"><span data-stu-id="ba143-232">If no backup is taken by user for a period of 45 minutes, hello system automatically truncates hello log records.</span></span> <span data-ttu-id="ba143-233">Tento interval můžete nakonfigurovat tak, že zadáte `logTrunctationIntervalInMinutes` v `KvsActorStateProvider` – konstruktor (podobně jako toowhen povolíte přírůstkové zálohování).</span><span class="sxs-lookup"><span data-stu-id="ba143-233">This interval can be configured by specifying `logTrunctationIntervalInMinutes` in `KvsActorStateProvider` constructor (similar toowhen enabling incremental backup).</span></span> <span data-ttu-id="ba143-234">záznamy protokolu Hello může získat také zkrácen, pokud primární repliky potřebovat toobuild jiné repliky odesláním všechna jeho data.</span><span class="sxs-lookup"><span data-stu-id="ba143-234">hello log records may also get truncated if primary replica need toobuild another replica by sending all its data.</span></span>

<span data-ttu-id="ba143-235">Při provádění obnovení ze řetěz záloh, podobně jako tooReliable služby, by měly obsahovat hello BackupFolderPath podadresářů pomocí jednoho podadresáři obsahující úplnou zálohu a ostatní podadresáře obsahující přírůstkové zálohy.</span><span class="sxs-lookup"><span data-stu-id="ba143-235">When doing restore from a backup chain, similar tooReliable Services, hello BackupFolderPath should contain subdirectories with one subdirectory containing full backup and others subdirectories containing incremental backup(s).</span></span> <span data-ttu-id="ba143-236">rozhraní API obnovení Hello vyvolá výjimku FabricException se příslušná chybová zpráva, pokud selže ověření řetěz záloh hello.</span><span class="sxs-lookup"><span data-stu-id="ba143-236">hello restore API will throw FabricException with appropriate error message if hello backup chain validation fails.</span></span> 

> [!NOTE]
> <span data-ttu-id="ba143-237">`KvsActorStateProvider`aktuálně ignoruje hello možnost RestorePolicy.Safe.</span><span class="sxs-lookup"><span data-stu-id="ba143-237">`KvsActorStateProvider` currently ignores hello option RestorePolicy.Safe.</span></span> <span data-ttu-id="ba143-238">Podpora pro tuto funkci je plánované v nadcházející verzi.</span><span class="sxs-lookup"><span data-stu-id="ba143-238">Support for this feature is planned in an upcoming release.</span></span>
> 

## <a name="testing-backup-and-restore"></a><span data-ttu-id="ba143-239">Testování zálohování a obnovení</span><span class="sxs-lookup"><span data-stu-id="ba143-239">Testing Backup and Restore</span></span>
<span data-ttu-id="ba143-240">Je důležité tooensure, který je zálohovaných důležitých dat a lze obnovit z.</span><span class="sxs-lookup"><span data-stu-id="ba143-240">It is important tooensure that critical data is being backed up, and can be restored from.</span></span> <span data-ttu-id="ba143-241">To lze provést vyvoláním hello `Start-ServiceFabricPartitionDataLoss` rutiny v prostředí PowerShell, které může způsobit ztrátě dat v konkrétní oddíl tootest, zda text hello data zálohování a obnovení funkce pro vaše služba funguje podle očekávání.</span><span class="sxs-lookup"><span data-stu-id="ba143-241">This can be done by invoking hello `Start-ServiceFabricPartitionDataLoss` cmdlet in PowerShell that can induce data loss in a particular partition tootest whether hello data backup and restore functionality for your service is working as expected.</span></span>  <span data-ttu-id="ba143-242">Je také možné tooprogrammatically vyvolání ztrátě dat a obnovit ze také tuto událost.</span><span class="sxs-lookup"><span data-stu-id="ba143-242">It is also possible tooprogrammatically invoke data loss and restore from that event as well.</span></span>

> [!NOTE]
> <span data-ttu-id="ba143-243">Můžete najít ukázkové implementace zálohování a obnovení funkce v hello webové aplikace odkaz na Githubu.</span><span class="sxs-lookup"><span data-stu-id="ba143-243">You can find a sample implementation of backup and restore functionality in hello Web Reference App on GitHub.</span></span> <span data-ttu-id="ba143-244">Podívejte se prosím na hello `Inventory.Service` služby další podrobnosti.</span><span class="sxs-lookup"><span data-stu-id="ba143-244">Please look at hello `Inventory.Service` service for more details.</span></span>
> 
> 

## <a name="under-hello-hood-more-details-on-backup-and-restore"></a><span data-ttu-id="ba143-245">Pod pokličkou hello: Další informace o zálohování a obnovení</span><span class="sxs-lookup"><span data-stu-id="ba143-245">Under hello hood: more details on backup and restore</span></span>
<span data-ttu-id="ba143-246">Zde je některé další informace o zálohování a obnovení.</span><span class="sxs-lookup"><span data-stu-id="ba143-246">Here's some more details on backup and restore.</span></span>

### <a name="backup"></a><span data-ttu-id="ba143-247">Zálohování</span><span class="sxs-lookup"><span data-stu-id="ba143-247">Backup</span></span>
<span data-ttu-id="ba143-248">Hello spolehlivé správce stavu poskytuje hello možnost toocreate konzistentní zálohování bez blokování všechny operace čtení nebo zápisu.</span><span class="sxs-lookup"><span data-stu-id="ba143-248">hello Reliable State Manager provides hello ability toocreate consistent backups without blocking any read or write operations.</span></span> <span data-ttu-id="ba143-249">toodo, takže ho využívá mechanismus trvalosti kontrolního bodu a protokolu.</span><span class="sxs-lookup"><span data-stu-id="ba143-249">toodo so, it utilizes a checkpoint and log persistence mechanism.</span></span>  <span data-ttu-id="ba143-250">Hello spolehlivé správce stavu trvá přibližné (lightweight) kontrolní body v určité zatížení toorelieve bodů z hello transakčního protokolu a vylepšovat dobu obnovení.</span><span class="sxs-lookup"><span data-stu-id="ba143-250">hello Reliable State Manager takes fuzzy (lightweight) checkpoints at certain points toorelieve pressure from hello transactional log and improve recovery times.</span></span>  <span data-ttu-id="ba143-251">Když `BackupAsync` nazývá hello spolehlivé správce stavu dá pokyn všechny spolehlivé objekty toocopy jejich poslední kontrolní bod tooa místní zálohování složce se soubory.</span><span class="sxs-lookup"><span data-stu-id="ba143-251">When `BackupAsync` is called, hello Reliable State Manager instructs all Reliable objects toocopy their latest checkpoint files tooa local backup folder.</span></span>  <span data-ttu-id="ba143-252">Potom hello spolehlivé správce stavu zkopíruje všechny záznamy protokolu od hello "start ukazatel" toohello nejnovější záznam protokolu do zálohovací složky hello.</span><span class="sxs-lookup"><span data-stu-id="ba143-252">Then, hello Reliable State Manager copies all log records, starting from hello "start pointer" toohello latest log record into hello backup folder.</span></span>  <span data-ttu-id="ba143-253">Vzhledem k tomu, že všechny záznamy protokolu hello až toohello nejnovější záznam protokolu jsou součástí zálohy hello a hello spolehlivé správce stavu zachovává předběžné protokolování, hello spolehlivé správce stavu zaručuje, že jsou všechny transakce, potvrzeny (`CommitAsync` vrátila úspěšně) jsou zahrnuté v záloze hello.</span><span class="sxs-lookup"><span data-stu-id="ba143-253">Since all hello log records up toohello latest log record are included in hello backup and hello Reliable State Manager preserves write-ahead logging, hello Reliable State Manager guarantees that all transactions that are committed (`CommitAsync` has returned successfully) are included in hello backup.</span></span>

<span data-ttu-id="ba143-254">Jakékoli transakce, která provádí po `BackupAsync` byla volána může nebo nemusí být hello zálohování.</span><span class="sxs-lookup"><span data-stu-id="ba143-254">Any transaction that commits after `BackupAsync` has been called may or may not be in hello backup.</span></span>  <span data-ttu-id="ba143-255">Jakmile hello místní zálohování složky naplněné platformou hello (tj, místní bylo zálohování dokončeno modulem hello runtime), je volána hello služby zálohování zpětného volání.</span><span class="sxs-lookup"><span data-stu-id="ba143-255">Once hello local backup folder has been populated by hello platform (i.e., local backup is completed by hello runtime), hello service's backup callback is invoked.</span></span>  <span data-ttu-id="ba143-256">Tato zpětné volání je zodpovědná za přesunutí hello zálohovací složky tooan externí umístění například Azure Storage.</span><span class="sxs-lookup"><span data-stu-id="ba143-256">This callback is responsible for moving hello backup folder tooan external location such as Azure Storage.</span></span>

### <a name="restore"></a><span data-ttu-id="ba143-257">Obnovení</span><span class="sxs-lookup"><span data-stu-id="ba143-257">Restore</span></span>
<span data-ttu-id="ba143-258">Hello spolehlivé správce stavu poskytuje možnost toorestore hello ze zálohy pomocí hello `RestoreAsync` rozhraní API.</span><span class="sxs-lookup"><span data-stu-id="ba143-258">hello Reliable State Manager provides hello ability toorestore from a backup by using hello `RestoreAsync` API.</span></span>  
<span data-ttu-id="ba143-259">Hello `RestoreAsync` metodu `RestoreContext` lze volat pouze uvnitř hello `OnDataLossAsync` metoda.</span><span class="sxs-lookup"><span data-stu-id="ba143-259">hello `RestoreAsync` method on `RestoreContext` can be called only inside hello `OnDataLossAsync` method.</span></span>
<span data-ttu-id="ba143-260">Hello bool vrácený `OnDataLossAsync` označuje, zda služba hello obnovit stav z externího zdroje.</span><span class="sxs-lookup"><span data-stu-id="ba143-260">hello bool returned by `OnDataLossAsync` indicates whether hello service restored its state from an external source.</span></span>
<span data-ttu-id="ba143-261">Pokud hello `OnDataLossAsync` vrátí hodnotu true, Service Fabric se znovu vytvořit všechny ostatní repliky z tomuto primárnímu.</span><span class="sxs-lookup"><span data-stu-id="ba143-261">If hello `OnDataLossAsync` returns true, Service Fabric will rebuild all other replicas from this primary.</span></span> <span data-ttu-id="ba143-262">Service Fabric zajišťuje, že repliky, které obdrží `OnDataLossAsync` volání první přechod toohello primární roli, ale nejsou uděleno číst stav nebo zapisovat stav.</span><span class="sxs-lookup"><span data-stu-id="ba143-262">Service Fabric ensures that replicas that will receive `OnDataLossAsync` call first transition toohello primary role but are not granted read status or write status.</span></span>
<span data-ttu-id="ba143-263">To vyplývá, že pro implementátory StatefulService `RunAsync` dokud nebude volána `OnDataLossAsync` úspěšně dokončí.</span><span class="sxs-lookup"><span data-stu-id="ba143-263">This implies that for StatefulService implementers, `RunAsync` will not be called until `OnDataLossAsync` finishes successfully.</span></span>
<span data-ttu-id="ba143-264">Potom `OnDataLossAsync` bude volána pro nový primární hello.</span><span class="sxs-lookup"><span data-stu-id="ba143-264">Then, `OnDataLossAsync` will be invoked on hello new primary.</span></span>
<span data-ttu-id="ba143-265">Dokud služby dokončí toto rozhraní API úspěšně (vrací hodnotu true nebo false) a dokončí příslušné Rekonfigurace hello, hello rozhraní API bude udržovat volána po jednom.</span><span class="sxs-lookup"><span data-stu-id="ba143-265">Until a service completes this API successfully (by returning true or false) and finishes hello relevant reconfiguration, hello API will keep being called one at a time.</span></span>

<span data-ttu-id="ba143-266">`RestoreAsync`nejprve zahodí všechny existující stavy hello primární repliku, která byla volána na.</span><span class="sxs-lookup"><span data-stu-id="ba143-266">`RestoreAsync` first drops all existing state in hello primary replica that it was called on.</span></span>  
<span data-ttu-id="ba143-267">Pak hello spolehlivé správce stavu vytvoří všechny objekty spolehlivé hello, které existují v zálohovací složce hello.</span><span class="sxs-lookup"><span data-stu-id="ba143-267">Then hello Reliable State Manager creates all hello Reliable objects that exist in hello backup folder.</span></span>  
<span data-ttu-id="ba143-268">V dalším kroku hello spolehlivé objekty jsou pokyn toorestore z jejich kontrolní body ve složce backup hello.</span><span class="sxs-lookup"><span data-stu-id="ba143-268">Next, hello Reliable objects are instructed toorestore from their checkpoints in hello backup folder.</span></span>  
<span data-ttu-id="ba143-269">Nakonec hello spolehlivé správce stavu obnovuje vlastní stavu ze záznamů protokolu hello hello zálohovací složky a provede obnovení.</span><span class="sxs-lookup"><span data-stu-id="ba143-269">Finally, hello Reliable State Manager recovers its own state from hello log records in hello backup folder and performs recovery.</span></span>  
<span data-ttu-id="ba143-270">Jako součást procesu obnovení hello jsou operace od hello "výchozí bod", které mají záznamy protokolu potvrzení v zálohovací složce hello přehraná toohello spolehlivé objekty.</span><span class="sxs-lookup"><span data-stu-id="ba143-270">As part of hello recovery process, operations starting from hello "starting point" that have commit log records in hello backup folder are replayed toohello Reliable objects.</span></span>  
<span data-ttu-id="ba143-271">Tento krok zajistí, že hello obnovené stav je konzistentní.</span><span class="sxs-lookup"><span data-stu-id="ba143-271">This step ensures that hello recovered state is consistent.</span></span>

## <a name="next-steps"></a><span data-ttu-id="ba143-272">Další kroky</span><span class="sxs-lookup"><span data-stu-id="ba143-272">Next steps</span></span>
  - [<span data-ttu-id="ba143-273">Reliable Collections</span><span class="sxs-lookup"><span data-stu-id="ba143-273">Reliable Collections</span></span>](service-fabric-work-with-reliable-collections.md)
  - [<span data-ttu-id="ba143-274">Spolehlivé služby rychlý start</span><span class="sxs-lookup"><span data-stu-id="ba143-274">Reliable Services quick start</span></span>](service-fabric-reliable-services-quick-start.md)
  - [<span data-ttu-id="ba143-275">Spolehlivé služby oznámení</span><span class="sxs-lookup"><span data-stu-id="ba143-275">Reliable Services notifications</span></span>](service-fabric-reliable-services-notifications.md)
  - [<span data-ttu-id="ba143-276">Spolehlivé služby konfigurace</span><span class="sxs-lookup"><span data-stu-id="ba143-276">Reliable Services configuration</span></span>](service-fabric-reliable-services-configuration.md)
  - [<span data-ttu-id="ba143-277">Referenční informace pro vývojáře pro spolehlivé kolekce</span><span class="sxs-lookup"><span data-stu-id="ba143-277">Developer reference for Reliable Collections</span></span>](https://msdn.microsoft.com/library/azure/microsoft.servicefabric.data.collections.aspx)

